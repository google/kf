<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://google.github.io/kf/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://google.github.io/kf/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/kf/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/kf/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/kf/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/kf/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/kf/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/kf/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/kf/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/kf/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/kf/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/kf/favicons/android-192x192.png" sizes="192x192">

<title>Docs | Kf</title>
<meta name="description" content="">
<meta property="og:title" content="Docs" />
<meta property="og:description" content="A Cloud Foundry inspired MicroPAAS for Kubernetes." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://google.github.io/kf/docs/" /><meta property="og:site_name" content="Kf" />

<meta itemprop="name" content="Docs">
<meta itemprop="description" content="A Cloud Foundry inspired MicroPAAS for Kubernetes."><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docs"/>
<meta name="twitter:description" content="A Cloud Foundry inspired MicroPAAS for Kubernetes."/>




<link rel="preload" href="/kf/scss/main.scss" as="style">
<link href="/kf/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/kf/">
		<span class="navbar-logo"></span><span class="font-weight-bold">Kf</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kf/docs/v2.11/developer/" ><span>Developer Guide</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kf/docs/v2.11/operator/" ><span>Operator Guide</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kf/docs/v2.11/troubleshooting/" ><span>Troubleshooting</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/kf/offline-search-index.7286fcd87331c972fd64c843afb49d7c.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/kf/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Docs</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-8c09c24013599d9618c9e499a790f8f5">Documentation</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-b07e23f90ca6fedff467b799c3bb3c5b">Getting Started</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1.1: <a href="#pg-54601883b55d3f295b321e786d1697e7">Getting Started Overview</a></li>


    
  
    
    
	
<li>1.1.2: <a href="#pg-28390d010686a9f1024c3218dd5d957d">Quickstart</a></li>


    
  
    
    
	
<li>1.1.3: <a href="#pg-628f2a640205aa38e8087d11eb557ca1">Compare Cloud Foundry and Kf services</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.2: <a href="#pg-32f5172febd46ea26dcdc6257f973f4f">Develop Applications on Kf</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.2.1: <a href="#pg-a60b85e1dd5f928d7162ace6696bd931">Build and deploy applications</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.2.1.1: <a href="#pg-0e8cd33d006c97b252697a9cfd07f2c7">Deploy an application</a></li>


    
  
    
    
	
<li>1.2.1.2: <a href="#pg-8ea3d94dc554a1582b70703a82fca49f">Get started with buildpacks</a></li>


    
  
    
    
	
<li>1.2.1.3: <a href="#pg-f1392c0da56cd744e3f2a431f5b31ef1">Reduce deployment risk with blue-green deployments</a></li>


    
  
    
    
	
<li>1.2.1.4: <a href="#pg-b2c95f335af52e4210d54a7a32f7f710">Compare V2 and V3 Buildpacks</a></li>


    
  
    
    
	
<li>1.2.1.5: <a href="#pg-149d70341c8f45f4db5d853c1df8199c">App Manifest</a></li>


    
  
    
    
	
<li>1.2.1.6: <a href="#pg-f9a54f404531eb77094696e5deff4f90">App runtime</a></li>


    
  
    
    
	
<li>1.2.1.7: <a href="#pg-9e253740257aaf5fafb8377b39e5e3f3">Build runtime</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.2.2: <a href="#pg-83f77835eae3d15dda612e1c86814bd0">Backing services</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.2.2.1: <a href="#pg-c2ebc22b9018da19d5d34e6e9c45330c">Backing Services Overview</a></li>


    
  
    
    
	
<li>1.2.2.2: <a href="#pg-aaeb0115cc03519618bc12ca99dd6372">Use managed services</a></li>


    
  
    
    
	
<li>1.2.2.3: <a href="#pg-65eb33ea4f1b06e45c9630828e66567e">Configure user-provided services</a></li>


    
  
    
    
	
<li>1.2.2.4: <a href="#pg-dcb66f5640af578e83d147a64abbd646">User Provided Service Templates</a></li>


    
  
    
    
	
<li>1.2.2.5: <a href="#pg-7c5cfb1597b32604da9ea5cb7a9bb1d5">Configure NFS volumes</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.2.3: <a href="#pg-c16824af8fd2a461ef90c4f8160d9b6c">Scaling</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.2.3.1: <a href="#pg-b382e70e5bab4b7f5eb676e75ffdd352">Scaling overview</a></li>


    
  
    
    
	
<li>1.2.3.2: <a href="#pg-8412b2ccff3bf6d3216d6875e40cd997">Manage Autoscaling</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.2.4: <a href="#pg-942fc5a9d62607b3fdeac4fd7cc64e68">Service discovery</a></li>


    
  
    
    
	
<li>1.2.5: <a href="#pg-112457d24a74b66b91a3aad98b695483">Configure routes and domains</a></li>


    
  
    
    
	
<li>1.2.6: <a href="#pg-08ccb5aed1b65bbb79ebfe9a95bdfda5">Tasks</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.2.6.1: <a href="#pg-fc8abef5d8b8b4cd00451c7fbf42f60e">Tasks Overview</a></li>


    
  
    
    
	
<li>1.2.6.2: <a href="#pg-1fe7b60117f61a59570dc9806b2e2128">Run Tasks</a></li>


    
  
    
    
	
<li>1.2.6.3: <a href="#pg-52b92bfa0949442cec57f0a34cd75406">Schedule Tasks</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>1.3: <a href="#pg-71a90347dd73976aef782a044da2dda6">Operate and Maintain Kf</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.1: <a href="#pg-676fe26aec89a6298c30c8bde719f98c">Service brokers</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.1.1: <a href="#pg-57a67dff900071f2cffcad23543f9c9e">Service Brokers Overview</a></li>


    
  
    
    
	
<li>1.3.1.2: <a href="#pg-9a3de66316708be4c05787cd2dd1aba9">About Kf Cloud Service Broker</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>1.3.1.3: <a href="#pg-5446c3e6e9dd77ccf2bb6d4380fbad8c">Deploy Kf Cloud Service Broker</a></li>


    
  
    
    
	
<li>1.3.1.4: <a href="#pg-0ed1f2553ce17ae3693a557beaea071d">Set up NFS platform</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.3.2: <a href="#pg-eb59913b8a37858863152c1befc303fb">Customizing Kf</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.2.1: <a href="#pg-b156f3a85a418456ea8aeb7c077af36d">Customizing Overview</a></li>


    
  
    
    
	
<li>1.3.2.2: <a href="#pg-2de7bc87b8e461d33fe1259e2cf92256">Cluster Configuration</a></li>


    
  
    
    
	
<li>1.3.2.3: <a href="#pg-3c86bc86c018c6665f7e1bad06988b6f">Customizing Kf Features</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.3.3: <a href="#pg-ee9aef4d5863cf3b7971485e6a86039f">Kf dependencies and architecture</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>1.3.4: <a href="#pg-835c09d088daa498f7f4edc9aca34410">Kf reference architecture diagrams</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>1.3.5: <a href="#pg-84debb8217acd435c5d68f3dcf614a6b">Logging and Monitoring</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.5.1: <a href="#pg-dbee04d71aa54a688f7ea60028e06371">Create and user monitoring dashboards.</a></li>


    
  
    
    
	
<li>1.3.5.2: <a href="#pg-5a85a7965fdcfe4cf8ad48fec38d5940">Logging and monitoring</a></li>


    
  
    
    
	
<li>1.3.5.3: <a href="#pg-feab5808045e2631f70969b913fafe31">Logging and monitoring overview</a></li>


    
  
    
    
	
<li>1.3.5.4: <a href="#pg-ca8fa32dfcb17c91cbd11356f47a4f4f">View logs</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.3.6: <a href="#pg-b2adb428c5ca36c2ceb9e1e03ad76231">Networking</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.6.1: <a href="#pg-7a417b00bb28a3931ab1fd45e7c32f1a">Set up a custom domain</a></li>


    
  
    
    
	
<li>1.3.6.2: <a href="#pg-02e4f4812df4620e950d845e9b74bf7c">Set up HTTPS ingress</a></li>


    
  
    
    
	
<li>1.3.6.3: <a href="#pg-73a1d3010499b813fad95f898bb1d8a8">Set up network policies</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.3.7: <a href="#pg-cbe31da3743a949ac1b65626af3b367b">Security</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.7.1: <a href="#pg-618739ac86f5ed17603f48ea81584abf">Security Overview</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>1.3.7.2: <a href="#pg-304425574fd6e3f21a7dd1619983268f">Role-based access control</a></li>


    
  
    
    
	
<li>1.3.7.3: <a href="#pg-40ff7467b86eb5796edbb4944e3340fe">Configure role-based access control</a></li>


    
  
    
    
	
<li>1.3.7.4: <a href="#pg-4497b76abb619113621471039e747061">Enable compute isolation</a></li>


    
  
    
    
	
<li>1.3.7.5: <a href="#pg-f4376724fa27ad233014070cf3e62b66">Kubernetes Roles</a></li>


    
  

    </ul>
    
  
    
    
	
<li>1.3.8: <a href="#pg-340fae6dd8d6497edae52aa4e6cac4ff">Stacks and Buildpacks</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.3.8.1: <a href="#pg-6dc2637a3c7511c15b5eea65056a667c">Customize stacks</a></li>


    
  
    
    
	
<li>1.3.8.2: <a href="#pg-7b5d652a95409ea35a6e10e2bce40600">Customize stacks and buildpacks</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>1.4: <a href="#pg-f60fa136297c818ca9e1b205060a8432">Troubleshooting</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>1.5: <a href="#pg-9a85ad478cf508ecdd1e71de61d669e6">Examples</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.5.1: <a href="#pg-d9d41c282d85bcfed58e3051ef14aefa">Deploy Spring Cloud Config</a></li>


    
  
    
    
	
<li>1.5.2: <a href="#pg-ff91ce51c2369e24b7fbd6a3ddf9a37d">Deploy Spring Music</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8c09c24013599d9618c9e499a790f8f5">1 - Documentation</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b07e23f90ca6fedff467b799c3bb3c5b">1.1 - Getting Started</h1>
    <div class="lead">Get started with Kf as an app runtime.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-54601883b55d3f295b321e786d1697e7">1.1.1 - Getting Started Overview</h1>
    
	<p>With Kf, you can migrate your Cloud Foundry apps to
Kubernetes without changing your developer workflows.</p>
<p>Use the following sections to get started deploying Cloud Foundry apps
to Kf.</p>
<h2 id="get-started-with-a-quickstart">Get started with a quickstart</h2>
<p>Use the <a href="/kf/docs/v2.11/getting-started/quickstart/">quickstart</a> to install Kf and deploy a
simple test Cloud Foundry app. This introduces you to the basic steps you&rsquo;d
perform for most app deployments.</p>
<h2 id="get-an-introduction-to-key-concepts">Get an introduction to key concepts</h2>
<p>For an introduction to the value of Kf, as well as
high-level overviews of the technology, see the following documents:</p>
<ul>
<li>To learn more about how Kf works, see
<a href="/kf/docs/v2.11/operator/kf-dependencies/">Kf dependencies and architecture</a>.</li>
<li>For a side-by-side comparison of Cloud Foundry and Kf
components, see
<a href="/kf/docs/v2.11/getting-started/compare-services/">Compare Cloud Foundry and Kf services</a>.</li>
<li>To learn how to use service brokers with Kf,
see <a href="/kf/docs/v2.11/operator/service-brokers/about-service-brokers/">Service brokers</a>.</li>
<li>For more information about Kf security design, see the
<a href="/kf/docs/v2.11/operator/security/security-overview/">Security overview</a>.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-28390d010686a9f1024c3218dd5d957d">1.1.2 - Quickstart</h1>
    
	<p>In this quickstart, you will deploy a sample Cloud Foundry app on an existing Kf cluster.</p>
<h2 id="push-an-application">Push an application</h2>
<h3 id="prerequisites">Prerequisites</h3>
<p>The following are required to complete this section:</p>
<ol>
<li>
<p>The <code>kf</code> CLI installed and in your path.</p>
</li>
<li>
<p>You have connected to the Kf Kubernetes cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gcloud container clusters get-credentials CLUSTER_NAME <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --project<span style="color:#ce5c00;font-weight:bold">=</span>CLUSTER_PROJECT_ID <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --zone<span style="color:#ce5c00;font-weight:bold">=</span>CLUSTER_LOCATION
</span></span></code></pre></div></li>
<li>
<p>The <code>git</code> CLI installed and in your path.</p>
</li>
</ol>
<h3 id="prepare-space">Prepare space</h3>
<ol>
<li>
<p>Create new space:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-space test-space
</span></span></code></pre></div></li>
<li>
<p>Target the space:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf target -s test-space
</span></span></code></pre></div></li>
</ol>
<h3 id="push-the-cloud-foundry-test-app">Push the Cloud Foundry test app</h3>
<ol>
<li>
<p>Clone the <a href="https://github.com/cloudfoundry-samples/test-app">test-app repo</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/cloudfoundry-samples/test-app go-test-app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> go-test-app
</span></span></code></pre></div></li>
<li>
<p>Push the app.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> It will take a few minutes for the build to complete.
</aside>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push test-app
</span></span></code></pre></div></li>
<li>
<p>Get the application&rsquo;s URL.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf apps
</span></span></code></pre></div>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The app will have a random route by default.
</aside>

</li>
<li>
<p>Open the URL in your browser where you should see the app running.</p>

    <figure>
        <img src="./app-quickstart-success.png"/> <figcaption>
                <h4>Successful app push on Kf</h4>
            </figcaption>
    </figure>

</li>
</ol>
<h2 id="clean-up">Clean up</h2>
<p>These steps should return the cluster to the starting state.</p>
<ol>
<li>
<p>Delete the application.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete test-app
</span></span></code></pre></div></li>
<li>
<p>Delete the Space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete-space test-space
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-628f2a640205aa38e8087d11eb557ca1">1.1.3 - Compare Cloud Foundry and Kf services</h1>
    
	<p>This document provides a side-by-side comparison of the various services
available on Cloud Foundry (CF) and those that Kf integrates
with on Google Cloud.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> This guide does not attempt to compare the syntax or semantics of the SDK,
APIs, or command-line tools provided by CF and Kf.
</aside>

<table>
  <thead>
    <tr>
      <th>Service category</th>
      <th>Service</th>
      <th>CF</th>
      <th>Kf</th>
    </tr>
  </thead>
  <tbody>
  <!-- Only include Service Category for the first row of each type -->
  <!-- Platform Components -->
  <tr>
    <td>Platform</td>
    <td>Infrastructure Orchestrator</td>
    <td>BOSH</td>
    <td>Kubernetes</td>
  </tr>
  <tr>
    <td></td>
    <td>PaaS</td>
    <td>CF Application Runtime (CFAR)</td>
    <td>Kf</td>
  </tr>
  <!-- Data Management -->
  <tr>
    <td>Data management</td>
    <td>Service Broker</td>
    <td>Service Broker Tile</td>
    <td>Kubernetes Deployed Service Brokers</td>
  </tr>
  <tr>
    <td></td>
    <td>MySQL</td>
    <td>MySQL Tile</td>
    <td>Kf Cloud Service Broker</td>
  </tr>
  <tr>
    <td></td>
    <td>MongoDB</td>
    <td>MongoDB Tile</td>
    <td>Kf Cloud Service Broker</td>
  </tr>
  <tr>
    <td></td>
    <td>RabbitMQ</td>
    <td>RabbitMQ Tile</td>
    <td>Kf Cloud Service Broker</td>
  </tr>
  <tr>
    <td></td>
    <td>Redis</td>
    <td>Redis Tile</td>
    <td>Kf Cloud Service Broker</td>
  </tr>
  <tr>
    <td></td>
    <td>Eureka</td>
    <td>Spring Cloud Services Tile</td>
    <td><a href="{{docs_path}}concepts/service-discovery">Service Discovery</a></td>
  </tr>
  <tr>
    <td></td>
    <td>Spring Cloud Config</td>
    <td>Spring Cloud Services Tile</td>
    <td><a href="{{docs_path}}how-to/deploying-spring-cloud-config">Spring Cloud Config</a></td>
  </tr>
  <!-- Operations tooling -->
  <tr>
    <td>Operations tooling</td>
    <td>Continuous Integration (CI)</td>
    <td>Concourse Tile</td>
    <td><a href="https://github.com/concourse/concourse-chart" target="_blank" class="external">Concourse Helm Chart</a></td>
  </tr>
  <!-- Logging -->
  <tr>
    <td>Logging</td>
    <td>Google Cloud</td>
    <td>Google Cloud Firehose Nozzle</td>
    <td><a href="https://cloud.google.com/blog/products/management-tools/using-logging-your-apps-running-kubernetes-engine" target="_blank" class="external">Google Cloud Logging Kubernetes Agent</a></td>
  </tr>
  <tr>
    <td></td>
    <td>Elastic</td>
    <td>Elastic Firehose Nozzle</td>
    <td><a href="https://cloud.google.com/solutions/partners/monitoring-gke-on-prem-with-the-elastic-stack">Elastic Stack Agent</a></td>
  </tr>
  <tr>
    <td></td>
    <td>Splunk</td>
    <td>Splunk Firehose Nozzle</td>
    <td><a href="https://cloud.google.com/solutions/logging-anthos-with-splunk-connect">Splunk Connect</a></td>
  </tr>
  <tr>
    <td></td>
    <td>Metrics</td>
    <td>CF App Metrics</td>
    <td><a href="https://cloud.google.com/monitoring/">Google Cloud Monitoring Kubernetes AGent</a></td>
  </tr>
  </tbody>
</table>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-32f5172febd46ea26dcdc6257f973f4f">1.2 - Develop Applications on Kf</h1>
    <div class="lead">Learn to use Kf to deploy and maintain applications.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a60b85e1dd5f928d7162ace6696bd931">1.2.1 - Build and deploy applications</h1>
    <div class="lead">Learn how to build and deploy applications in Kf.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0e8cd33d006c97b252697a9cfd07f2c7">1.2.1.1 - Deploy an application</h1>
    <div class="lead">Guide to deploying applications with Kf.</div>
	<p>When pushing an app (via <code>kf push</code>) to Kf, there are
three lifecycles that Kf uses to take your source code
and allow it to handle traffic:</p>
<ol>
<li>Source code upload</li>
<li>Build</li>
<li>Run</li>
</ol>
<h2 id="source-code-upload">Source code upload</h2>
<p>The first thing that happens when you <code>kf push</code> is the Kf CLI (<code>kf</code>) packages
up your directory (either current or <code>--path/-p</code>) into a container and
publishes it to the container registry configured for the Space. This is
called the source container. The Kf CLI then creates an <code>App</code> type in Kubernetes
that contains both the source image and configuration from the App manifest and
push flags.</p>
<h3 id="ignore-files-during-push">Ignore files during push</h3>
<p>In many cases, you will not want to upload certain files during <code>kf push</code> (i.e., &ldquo;ignore&rdquo; them).
This is where a <code>.kfignore</code> (or <code>.cfignore</code>) file can be used.
Similar to a <code>.gitignore</code> file, this file instructs the Kf CLI which
files to not include in the source code container.</p>
<p>To create a <code>.kfignore</code> file, create a text file named <code>.kfignore</code> in the base
directory of your app (similar to where you would store the manifest
file). Then populate it with a newline delimited list of files and directories
you don&rsquo;t want published. For example:</p>
<pre tabindex="0"><code>bin
.idea
</code></pre><p>This will tell the Kf CLI to not include anything in the <code>bin</code> or <code>.idea</code>
directories.</p>
<p>Kf supports <a href="https://git-scm.com/docs/gitignore">gitignore</a> style syntax.</p>
<h2 id="build">Build</h2>
<p>The Build lifecycle is handled by a Tekton
<a href="https://github.com/tektoncd/pipeline/blob/master/docs/taskruns.md">TaskRun</a>.
Depending on the flags that you provide while pushing, it will choose a specific
Tekton <a href="https://github.com/tektoncd/pipeline/blob/master/docs/tasks.md">Task</a>.
Kf currently has the following Tekton Tasks:</p>
<ul>
<li>buildpackv2</li>
<li>buildpackv3</li>
<li>kaniko</li>
</ul>
<p>Kf tracks each TaskRun as a Build. If a Build succeeds, the resulting
container image is then deployed via the Run lifecycle (described below).</p>
<p>More information can be found at <a href="/kf/docs/v2.11/developer/build-and-deploy/build-runtime/">Build runtime</a>.</p>
<h2 id="run">Run</h2>
<p>The Run lifecycle is responsible for taking a container image and creating a
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment</a>.</p>
<p>It also creates:</p>
<ul>
<li><a href="https://istio.io/docs/reference/config/networking/virtual-service/">Istio Virtual Services</a></li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes Secrets</a></li>
</ul>
<p>More information can be found at <a href="/kf/docs/v2.11/developer/build-and-deploy/build-runtime/">Build runtime</a>.</p>
<h2 id="push-timeouts">Push timeouts</h2>
<p>Kf supports setting an environment variable to instruct the CLI to time out
while pushing apps. If set, the variables <code>KF_STARTUP_TIMEOUT</code> or
<code>CF_STARTUP_TIMEOUT</code> are parsed as a golang style duration (for example <code>15m</code>,
<code>1h</code>). If a value is not set, the push timeout defaults to 15 minutes.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8ea3d94dc554a1582b70703a82fca49f">1.2.1.2 - Get started with buildpacks</h1>
    <div class="lead">How to use built-in buildpacks for various languages.</div>
	<p>Kf supports a variety of buildpacks. This document
covers some starter examples for using them.</p>
<h2 id="before-you-begin">Before you begin</h2>
<ul>
<li>You should have Kf running on a cluster.</li>
<li>You should have run <code>kf target -s &lt;space-name&gt;</code> to target your space.</li>
</ul>
<h2 id="java-v2-buildpack">Java (v2) buildpack</h2>
<p>Use <a href="https://start.spring.io/">spring initializr</a> to create a Java 8 maven project with a spring web dependency and JAR packaging. Download it, extract it, and once extracted you can generate a JAR.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./mvnw package
</span></span></code></pre></div><p>Push the JAR to Kf with the Java v2 buildpack.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push java-v2 --path target/helloworld-0.0.1-SNAPSHOT.jar
</span></span></code></pre></div><h2 id="java-v3-buildpack">Java (v3) buildpack</h2>
<p>Use <a href="https://start.spring.io/">spring initializr</a> to create a Java 8 maven project with a spring web dependency and JAR packaging. Download it, extract it, and once extracted, push to Kf with the cloud native buildpack.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push java-v3 --stack org.cloudfoundry.stacks.cflinuxfs3
</span></span></code></pre></div><h2 id="python-v2-buildpack">Python (v2) buildpack</h2>
<p>Create a new directory with files as shown in the following structure.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── Procfile
</span></span><span style="display:flex;"><span>├── requirements.txt
</span></span><span style="display:flex;"><span>└── server.py
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat Procfile
</span></span><span style="display:flex;"><span>web: python server.py
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat requirements.txt
</span></span><span style="display:flex;"><span>Flask
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat server.py
</span></span><span style="display:flex;"><span>from flask import Flask
</span></span><span style="display:flex;"><span>import os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> Flask<span style="color:#ce5c00;font-weight:bold">(</span>__name__<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@app.route<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>def hello_world<span style="color:#ce5c00;font-weight:bold">()</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#39;Hello, World!&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> int<span style="color:#ce5c00;font-weight:bold">(</span>os.getenv<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PORT&#34;</span>, 8080<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  app.run<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;0.0.0.0&#39;</span>, <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">=</span>port<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>Push the Python flask app using v2 buildpacks.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push python --buildpack python<span style="color:#4e9a06">\_</span>buildpack
</span></span></code></pre></div><h2 id="python-v3-buildpack">Python (v3) buildpack</h2>
<p>(same as above)</p>
<p>Push the Python flask app using cloud native buildpacks.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push pythonv3 --stack org.cloudfoundry.stacks.cflinuxfs3
</span></span></code></pre></div><h2 id="staticfile-v2-buildpack">Staticfile (v2) buildpack</h2>
<p>Create a new directory that holds your source code.</p>
<p>Add an <code>index.html</code> file with this content.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">html</span> <span style="color:#c4a000">lang</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;en&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;&lt;</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>Hello, world!<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;&lt;</span><span style="color:#204a87;font-weight:bold">h1</span><span style="color:#000;font-weight:bold">&gt;</span>Hello, world!<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">h1</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>Push the static content with the staticfile buildpack.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push staticsite --buildpack staticfile<span style="color:#4e9a06">\_</span>buildpack
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f1392c0da56cd744e3f2a431f5b31ef1">1.2.1.3 - Reduce deployment risk with blue-green deployments</h1>
    <div class="lead">How to deploy highly available applications.</div>
	
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Kf will perform rolling deployments by default if you upgrade an app in place by starting
an extra instance of it, waiting for it to become healthy, and then replacing an existing
instance.
</aside>

<p>This page shows you how to deploy a new version of your application and migrate
traffic over from an old to a new version.</p>
<h2 id="push-the-initial-app">Push the initial App</h2>
<p>Use the Kf CLI to push the initial version of your App
with any routes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf push app-v1 --route my-app.my-space.example.com
</span></span></code></pre></div><h2 id="push-the-updated-app">Push the updated App</h2>
<p>Use the Kf CLI to push a new version of your App without
any routes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf push app-v2 --no-route
</span></span></code></pre></div><h2 id="add-routes-to-the-updated-app">Add routes to the updated App</h2>
<p>Use the Kf CLI to bind all existing routes to the updated
App with a weight of 0 to ensure that they don&rsquo;t get any requests:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf map-route app-v2 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h2 id="shift-traffic">Shift traffic</h2>
<p>Start shifting traffic from the old App to the updated App by updating the
weights on the routes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf map-route app-v1 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>$ kf map-route app-v2 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">20</span>
</span></span></code></pre></div><p>If the deployment is going well, you can shift more traffic by updating the
weights again:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf map-route app-v1 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">50</span>
</span></span><span style="display:flex;"><span>$ kf map-route app-v2 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">50</span>
</span></span></code></pre></div>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Weights split traffic proportionally to the sum of the weights of all
Apps mapped to the route. It&rsquo;s a common practice to treat weights as percentages.
</aside>

<h2 id="complete-traffic-shifting">Complete traffic shifting</h2>
<p>After you&rsquo;re satisfied that the new service hasn&rsquo;t introduced regressions,
complete the rollout by shifting all traffic to the new instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf map-route app-v1 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>$ kf map-route app-v2 my-space.example.com --hostname my-app --weight <span style="color:#0000cf;font-weight:bold">100</span>
</span></span></code></pre></div><h2 id="turn-down-the-original-app">Turn down the original App</h2>
<p>After you&rsquo;re satisfied that quick rollbacks aren&rsquo;t needed, remove the original
route and stop the App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf unmap-route app-v1 myspace.example.com --hostname my-app
</span></span><span style="display:flex;"><span>$ kf stop app-v1
</span></span></code></pre></div><p>Or delete the App and all associated route mappings:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf delete app-v1
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2c95f335af52e4210d54a7a32f7f710">1.2.1.4 - Compare V2 and V3 Buildpacks</h1>
    <div class="lead">Learn how to decide wihch buildpacks to use.</div>
	<p>A <a href="https://buildpacks.io/">buildpack</a> converts source code into an executable, and is used to deliver a simple, reliable, and repeatable way to create containers. Kf supports both V2 and V3 buildpacks, and it is important to understand the differences between them.</p>
<h2 id="v2-buildpacks">V2 buildpacks</h2>
<p>Most Cloud Foundry applications already use V2 buildpacks. When using V2 buildpacks with Kf, the lifecycle binaries and the buildpacks are downloaded and configured from their git URLs. Kf then uses the <code>lifecycle</code> CLI to execute each buildpack against the source code.</p>
<h3 id="pros">Pros</h3>
<ul>
<li>Ready out of the box without pipeline or code changes.</li>
</ul>
<h3 id="cons">Cons</h3>
<ul>
<li>Legacy buildpack supersceded by V3.</li>
<li>Weaker performance and reliability. The Kf build pipeline requires more IO for V2 buildpacks.</li>
<li>Fewer community resources.</li>
<li>Kf only supports OSS git repos.</li>
</ul>
<h2 id="v3-buildpacks">V3 buildpacks</h2>
<p>V3 buildpacks are a Cloud Native Computing Foundation (CNCF) project with a well defined <a href="https://github.com/buildpacks/spec/blob/main/buildpack.md">spec</a>, a CLI (<a href="https://github.com/buildpacks/pack">pack</a>) and a growing community that is innovating around different languages and frameworks. Google Cloud also has its own set of <a href="https://github.com/GoogleCloudPlatform/buildpacks">OSS buildpacks</a>.</p>
<p>V3 buildpacks have two overarching OCI containers:</p>
<ul>
<li>Builder image</li>
<li>Run image</li>
</ul>
<h3 id="builder-image">Builder image</h3>
<p>The builder image is used while your source code is being built into a runnable container. The image has the necessary <code>detect</code> scripts and other utilities to compile source code.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Most buildpacks don&rsquo;t package the compilers with the builder image. Instead, they may have the build pipelines download any dependencies required to compile.
</aside>

<h3 id="run-image">Run image</h3>
<p>The run image is the base image that a container is built on. This means that it is the base image that will run when the App executes.</p>
<h3 id="layers">Layers</h3>
<p>V3 buildpacks use layers to compose the final container. Each buildpack included in a build is given the opportunity to manipulate the file system and environment variables of the App. This layering approach allows for buildpacks to be thinner and more generic.</p>
<p>V3 buildpacks are built on OCI containers. This requires that the V3 builder image be stored in a container registry that the Kf build pipeline has access to. The build pipeline uses the builder image to apply the underlying scripts to build the source code into a runnable container.</p>
<h3 id="pros-1">Pros</h3>
<ul>
<li>Google supported <a href="https://github.com/GoogleCloudPlatform/buildpacks">builder and run image</a>.</li>
<li>Works with various CI/CD runtimes like <a href="https://cloud.google.com/functions/docs/building/pack">Cloud Build</a>.</li>
<li>Growing community and <a href="https://registry.buildpacks.io/">buildpack registry</a>.</li>
</ul>
<h3 id="cons-1">Cons</h3>
<ul>
<li>May require code/process updates. For example, the Java buildpack requires source code while the V2 buildpack requires a jar file.</li>
<li>V3 buildpacks are newer and might require additional validation (is using community developed buildpacks).</li>
</ul>
<h2 id="kf-stacks">Kf Stacks</h2>
<h3 id="view-stacks">View Stacks</h3>
<p>When pushing an App, the build pipeline determines the buildpack based on the selected Stack (specified via the <code>--stack</code> flag or the manifest).</p>
<p>To see which Stacks are available in a Space first ensure a Space is targeted:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf target -s myspace
</span></span></code></pre></div><p>The <code>kf stacks</code> subcommand can then be used to list the Stacks:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf stacks
</span></span></code></pre></div><p>The output shows both V2 and V3 Stacks:</p>
<pre tabindex="0"><code>Getting stacks in Space: myspace
Version  Name                                Build Image                                                                                          Run Image
V2       cflinuxfs3                          cloudfoundry/cflinuxfs3@sha256:5219e9e30000e43e5da17906581127b38fa6417f297f522e332a801e737928f5      cloudfoundry/cflinuxfs3@sha256:5219e9e30000e43e5da17906581127b38fa6417f297f522e332a801e737928f5
V3       kf-v2-to-v3-shim                    gcr.io/kf-releases/v2-to-v3:v2.7.0                                                                   gcr.io/buildpacks/gcp/run:v1                                                                       This is a stack added by the integration tests to assert that v2-&gt;v3 shim works
V3       google                              gcr.io/buildpacks/builder:v1                                                                         gcr.io/buildpacks/gcp/run:v1                                                                       Google buildpacks (https://github.com/GoogleCloudPlatform/buildpacks)
V3       org.cloudfoundry.stacks.cflinuxfs3  cloudfoundry/cnb:cflinuxfs3@sha256:f96b6e3528185368dd6af1d9657527437cefdaa5fa135338462f68f9c9db3022  cloudfoundry/run:full-cnb@sha256:dbe17be507b1cc6ffae1e9edf02806fe0e28ffbbb89a6c7ef41f37b69156c3c2  A large Cloud Foundry stack based on Ubuntu 18.04
</code></pre><h2 id="v2-to-v3-buildpack-migration">V2 to V3 Buildpack Migration</h2>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> This feature is currently experimental and subject to change.
</aside>

<p>Kf provides a V3 stack to build applications that were built with standard V2 buildpacks, using a stack named  <code>kf-v2-to-v3-shim</code>. The <code>kf-v2-to-v3-shim</code> stack is created following the <a href="https://buildpacks.io/docs/operator-guide/create-a-stack/">standard V3 buildpacks API</a>. A Google maintained builder image is created with each Kf release, following the <a href="https://buildpacks.io/docs/operator-guide/create-a-builder/">standard buildpack process</a>. The builder image aggregates a list of V3 buildpacks created by the same process used with the <code>kf wrap-v2-buildpack</code> command. The V3 buildpack images are created using the standard V2 buildpack images. It&rsquo;s important to note that the V3 buildpacks do not contain the binary of the referenced V2 buildpacks. Instead, the V2 buildpack images are referenced, and the bits are downloaded at App build time (by running <code>kf push</code>).</p>
<p>At App build time, the V2 buildpack is downloaded from the corresponding git repository. When V3 detection runs, it delegates to the downloaded V2 detection script. For the first buildpack group that passes detection, it proceeds to the build step, which delegates the build execution to the downloaded V2 builder script.</p>
<p>The following V2 buildpacks are supported in the <code>kf-v2-to-v3-shim</code> stack:</p>
<table>
<thead>
<tr>
<th>Buildpack</th>
<th>Git Repository</th>
</tr>
</thead>
<tbody>
<tr>
<td>java_buildpack</td>
<td><a href="https://github.com/cloudfoundry/java-buildpack">https://github.com/cloudfoundry/java-buildpack</a></td>
</tr>
<tr>
<td>dotnet_core_buildpack</td>
<td><a href="https://github.com/cloudfoundry/dotnet-core-buildpack">https://github.com/cloudfoundry/dotnet-core-buildpack</a></td>
</tr>
<tr>
<td>nodejs_buildpack</td>
<td><a href="https://github.com/cloudfoundry/nodejs-buildpack">https://github.com/cloudfoundry/nodejs-buildpack</a></td>
</tr>
<tr>
<td>go_buildpack</td>
<td><a href="https://github.com/cloudfoundry/go-buildpack">https://github.com/cloudfoundry/go-buildpack</a></td>
</tr>
<tr>
<td>python_buildpack</td>
<td><a href="https://github.com/cloudfoundry/python-buildpack">https://github.com/cloudfoundry/python-buildpack</a></td>
</tr>
<tr>
<td>binary_buildpack</td>
<td><a href="https://github.com/cloudfoundry/binary-buildpack">https://github.com/cloudfoundry/binary-buildpack</a></td>
</tr>
<tr>
<td>nginx_buildpack</td>
<td><a href="https://github.com/cloudfoundry/nginx-buildpack">https://github.com/cloudfoundry/nginx-buildpack</a></td>
</tr>
</tbody>
</table>
<h4 id="option-1-migrate-apps-built-with-standard-v2-buildpacks">Option 1: Migrate Apps built with standard V2 buildpacks</h4>
<p>To build Apps with the <code>kf-v2-to-v3-shim</code> stack, use the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push myapp --stack kf-v2-to-v3-shim
</span></span></code></pre></div><p>The <code>kf-v2-to-v3-shim</code> stack will automatically detect the runtime with the wrapped V2 buildpacks. The resulting App image is created using the V3 standard and build pipeline, but the builder of the equivalent V2 buildpack.</p>
<h4 id="option-2-migrate-apps-built-with-custom-v2-buildpacks">Option 2: Migrate Apps built with custom V2 buildpacks</h4>
<p>Kf has a buildpack migration tool that can take a V2 buildpack and wrap it with a V3 buildpack. The wrapped buildpack can then be used anywhere V3 buildpacks are available.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf wrap-v2-buildpack gcr.io/your-project/v2-go-buildpack https://github.com/cloudfoundry/go-buildpack --publish
</span></span></code></pre></div><p>This will create a buildpack image named <code>gcr.io/your-project/v2-go-buildpack</code>. It can then be used to create a builder by following the <a href="https://buildpacks.io/docs/operator-guide/create-a-builder/">create a builder</a> docs.</p>
<p>This subcommand uses the following CLIs transparently:</p>
<ul>
<li><code>go</code></li>
<li><code>git</code></li>
<li><code>pack</code></li>
<li><code>unzip</code></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-149d70341c8f45f4db5d853c1df8199c">1.2.1.5 - App Manifest</h1>
    <div class="lead">Reference guide for the application manifest.yml format.</div>
	<p>App manifests provide a way for developers to record their App&rsquo;s execution environment in a declarative way.
They allow Apps to be deployed consistently and reproducibly.</p>
<h2 id="format">Format</h2>
<p>Manifests are YAML files in the root directory of the App. They <strong>must</strong> be named <code>manifest.yml</code> or <code>manifest.yaml</code>.</p>
<p>Kf App manifests are allowed to have a single top-level element: <code>applications</code>.
The <code>applications</code> element can contain one or more application entries.</p>
<h2 id="application-fields">Application fields</h2>
<p>The following fields are valid for objects under <code>applications</code>:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td><code>string</code></td>
<td>The name of the application. The app name should be lower-case alphanumeric characters and dashes. It must not start with a dash.</td>
</tr>
<tr>
<td><code>path</code></td>
<td><code>string</code></td>
<td>The path to the source of the app. Defaults to the manifest&rsquo;s directory.</td>
</tr>
<tr>
<td><code>buildpacks</code></td>
<td><code>string[]</code></td>
<td>A list of buildpacks to apply to the app.</td>
</tr>
<tr>
<td><code>stack</code></td>
<td><code>string</code></td>
<td>Base image to use for to use for apps created with a buildpack.</td>
</tr>
<tr>
<td><code>docker</code></td>
<td><code>object</code></td>
<td>A docker object. See the Docker Fields section for more information.</td>
</tr>
<tr>
<td><code>env</code></td>
<td><code>map</code></td>
<td>Key/value pairs to use as the environment variables for the app and build.</td>
</tr>
<tr>
<td><code>services</code></td>
<td><code>string[]</code></td>
<td>A list of service instance names to automatically bind to the app.</td>
</tr>
<tr>
<td><code>disk_quota</code></td>
<td><code>quantity</code></td>
<td>The amount of disk the application should get. Defaults to 1GiB.</td>
</tr>
<tr>
<td><code>memory</code></td>
<td><code>quantity</code></td>
<td>The amount of RAM to provide the app. Defaults to 1GiB.</td>
</tr>
<tr>
<td><code>cpu</code> †</td>
<td><code>quantity</code></td>
<td>The amount of CPU to provide the application. Defaults to 0.1 (1/10th of a CPU).</td>
</tr>
<tr>
<td><code>instances</code></td>
<td><code>int</code></td>
<td>The number of instances of the app to run. Defaults to 1.</td>
</tr>
<tr>
<td><code>routes</code></td>
<td><code>object</code></td>
<td>A list of routes the app should listen on. See the Route Fields section for more.</td>
</tr>
<tr>
<td><code>no-route</code></td>
<td><code>boolean</code></td>
<td>If set to true, the application will not be routable.</td>
</tr>
<tr>
<td><code>random-route</code></td>
<td><code>boolean</code></td>
<td>If set to true, the app will be given a random route.</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td><code>int</code></td>
<td>The number of seconds to wait for the app to become healthy.</td>
</tr>
<tr>
<td><code>health-check-type</code></td>
<td><code>string</code></td>
<td>The type of health-check to use <code>port</code>, <code>process</code>, <code>none</code>, or <code>http</code>. Default: <code>port</code></td>
</tr>
<tr>
<td><code>health-check-http-endpoint</code></td>
<td><code>string</code></td>
<td>The endpoint to target as part of the health-check. Only valid if <code>health-check-type</code> is <code>http</code>.</td>
</tr>
<tr>
<td><code>command</code></td>
<td><code>string</code></td>
<td>The command that starts the app. If supplied, this will be passed to the container entrypoint.</td>
</tr>
<tr>
<td><code>entrypoint</code> †</td>
<td><code>string</code></td>
<td>Overrides the app container&rsquo;s entrypoint.</td>
</tr>
<tr>
<td><code>args</code> †</td>
<td><code>string[]</code></td>
<td>Overrides the arguments the app container.</td>
</tr>
<tr>
<td><code>ports</code> †</td>
<td><code>object</code></td>
<td>A list of ports to expose on the container. If supplied, the first entry in this list is used as the default port.</td>
</tr>
</tbody>
</table>
<p>† Unique to Kf</p>
<h2 id="docker-fields">Docker fields</h2>
<p>The following fields are valid for <code>application.docker</code> objects:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>image</code></td>
<td><code>string</code></td>
<td>The docker image to use.</td>
</tr>
</tbody>
</table>
<h2 id="route-fields">Route fields</h2>
<p>The following fields are valid for <code>application.routes</code> objects:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>route</code></td>
<td><code>string</code></td>
<td>A route to the app including hostname, domain, and path.</td>
</tr>
<tr>
<td><code>appPort</code></td>
<td><code>int</code></td>
<td>(Optional) A custom port on the App the route will send traffic to.</td>
</tr>
</tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> If you specify an <code>appPort</code>, that port MUST also be declared in the <code>ports</code> field.
</aside>

<h2 id="port-fields">Port fields</h2>
<p>The following fields are valid for <code>application.ports</code> objects:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>port</code></td>
<td><code>int</code></td>
<td>The port to expose on the App&rsquo;s container.</td>
</tr>
<tr>
<td><code>protocol</code></td>
<td><code>string</code></td>
<td>The protocol of the port to expose. Must be <code>tcp</code>, <code>http</code> or <code>http2</code>. Default: <code>tcp</code></td>
</tr>
</tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The <code>protocol</code> field is a hint about the traffic that goes over the port.
The hint is used by the <a href="https://cloud.google.com/service-mesh/docs/overview">service mesh</a> for better tracing and metrics.
</aside>


<aside class="alert alert-danger" style="border-width: 1px 1px 1px 4px;">
<i class="fa-solid fa-triangle-exclamation"></i> <strong>Warning:</strong> Kf doesn&rsquo;t currently support TCP port-based routing. You must use a
<a href="https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/">Kubernetes LoadBalancer</a> if you want to expose a TCP port to the Internet. Ports are available on the cluster internal App address <code>&lt;app-name&gt;.&lt;space&gt;</code>.
</aside>


<h2 id="examples">Examples</h2>
<h3 id="minimal-app">Minimal App</h3>
<p>This is a bare-bones manifest that will build an App by auto-detecting
the buildpack based on the uploaded source, and deploy one instance of it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">applications</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-minimal-application</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="simple-app">Simple App</h3>
<p>This is a full manifest for a more traditional Java App.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">applications</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">account-manager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># only upload src/ on push</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">src</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># use the Java buildpack</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">buildpacks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">java</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># manually configure the buildpack&#39;s Java version</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">BP_JAVA_VERSION</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ENVIRONMENT</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PRODUCTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># use less disk and memory than default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disk_quota</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">512M</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">512M</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># bump up the CPU</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0.2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># make the app listen on three routes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">accounts.mycompany.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">accounts.datacenter.mycompany.internal</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mycompany.com/accounts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># set up a longer timeout and custom endpoint to validate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># when the app comes up</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">health-check-type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">health-check-http-endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/healthz</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># attach two services by name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">customer-database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">web-cache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="docker-app">Docker App</h3>
<p>Kf can deploy Docker containers as well as manifest deployed App.
These Docker Apps MUST listen on the <code>PORT</code> environment variable.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">applications</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">white-label-app</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># use a pre-built docker image (must listen on $PORT)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">docker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcr.io/my-company/white-label-app:123</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># add additional environment variables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ENVIRONMENT</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PRODUCTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disk_quota</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1G</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1G</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">white-label-app.mycompany.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="app-with-multiple-ports">App with multiple ports</h3>
<p>This App has multiple ports to expose an admin console, website, and SMTP server.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">applications</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b2b-server</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9090</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2525</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tcp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b2b-admin.mycompany.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">appPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9090</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b2b.mycompany.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># gets the default (first) port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="health-check-types">Health check types</h3>
<p>Kf supports three different health check types:</p>
<ol>
<li><code>port</code> (default)</li>
<li><code>http</code></li>
<li><code>process</code> (or <code>none</code>)</li>
</ol>
<p><code>port</code> and <code>http</code> set a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Kubernetes readiness and liveness
probe</a>
that ensures the application is ready before sending traffic to it.</p>
<p>The <code>port</code> health check will ensure the port found at <code>$PORT</code> is being
listened to. Under the hood Kf uses a TCP probe.</p>
<p>The <code>http</code> health check will use the configured value in
<code>health-check-http-endpoint</code> to check the application&rsquo;s health. Under the hood
Kf uses an HTTP probe.</p>
<p>A <code>process</code> health check only checks to see if the process running on the
container is alive. It does NOT set a Kubernetes readiness or liveness probe.</p>
<h2 id="known-differences">Known differences</h2>
<p>The following are known differences between Kf manifests and CF manifests:</p>
<ul>
<li>Kf does not support deprecated CF manifest fields. This includes all fields at the root-level of the manifest (other than applications) and routing fields.</li>
<li>Kf is missing support for the following v2 manifest fields:
<ul>
<li><code>docker.username</code></li>
</ul>
</li>
<li>Kf does not support auto-detecting ports for Docker containers.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9a54f404531eb77094696e5deff4f90">1.2.1.6 - App runtime</h1>
    <div class="lead">Reference guide for the application runtime container environment.</div>
	<p>The app runtime is the environment apps are executed in.</p>
<table>
<thead>
<tr>
<th></th>
<th>Buildpack Apps</th>
<th>Container Image Apps</th>
</tr>
</thead>
<tbody>
<tr>
<td>System libraries</td>
<td>Provided by the Stack</td>
<td>Provided in the container</td>
</tr>
<tr>
<td>Network access</td>
<td>Full access through Envoy sidecar</td>
<td>Full access through Envoy sidecar</td>
</tr>
<tr>
<td>File system</td>
<td>Ephemeral storage</td>
<td>Ephemeral storage</td>
</tr>
<tr>
<td>Language runtime</td>
<td>Supplied by the Stack or Buildpack</td>
<td>Built into the container</td>
</tr>
<tr>
<td>User</td>
<td>Specified by the Stack</td>
<td>Specified on the container</td>
</tr>
<tr>
<td>Isolation mechanism</td>
<td>Kubernetes Pod</td>
<td>Kubernetes Pod</td>
</tr>
<tr>
<td>DNS</td>
<td>Provided by Kubernetes</td>
<td>Provided by Kubernetes</td>
</tr>
</tbody>
</table>
<h2 id="environment-variables">Environment variables</h2>
<p>Environment variables are injected into the app at runtime by Kubernetes.
Variables are added based on the following order, where later values override
earlier ones with the same name:</p>
<ol>
<li>Space (set by administrators)</li>
<li>App (set by developers)</li>
<li>System (set by Kf)</li>
</ol>
<p>Kf provides the following system environment variables:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CF_INSTANCE_ADDR</code></td>
<td>The cluster-visible IP:PORT of the App instance.</td>
</tr>
<tr>
<td><code>CF_INSTANCE_GUID</code></td>
<td>The UUID of the App instance.</td>
</tr>
<tr>
<td><code>INSTANCE_GUID</code></td>
<td>Alias of <code>CF_INSTANCE_GUID</code>.</td>
</tr>
<tr>
<td><code>CF_INSTANCE_INDEX</code></td>
<td>The index number of the App instance, this will ALWAYS be 0.</td>
</tr>
<tr>
<td><code>INSTANCE_INDEX</code></td>
<td>Alias of <code>CF_INSTANCE_INDEX</code>.</td>
</tr>
<tr>
<td><code>CF_INSTANCE_IP</code></td>
<td>The cluster-visible IP of the App instance.</td>
</tr>
<tr>
<td><code>CF_INSTANCE_INTERNAL_IP</code></td>
<td>Alias of <code>CF_INSTANCE_IP</code></td>
</tr>
<tr>
<td><code>VCAP_APP_HOST</code></td>
<td>Alias of <code>CF_INSTANCE_IP</code></td>
</tr>
<tr>
<td><code>CF_INSTANCE_PORT</code></td>
<td>The cluster-visible port of the App instance. In Kf this is the same as <code>PORT</code>.</td>
</tr>
<tr>
<td><code>DATABASE_URL</code></td>
<td>The first URI found in a <code>VCAP_SERVICES</code> credential.</td>
</tr>
<tr>
<td><code>LANG</code></td>
<td>Required by Buildpacks to ensure consistent script load order.</td>
</tr>
<tr>
<td><code>MEMORY_LIMIT</code></td>
<td>The maximum amount of memory in MB the App can consume.</td>
</tr>
<tr>
<td><code>PORT</code></td>
<td>The port the App should listen on for requests.</td>
</tr>
<tr>
<td><code>VCAP_APP_PORT</code></td>
<td>Alias of <code>PORT</code>.</td>
</tr>
<tr>
<td><code>VCAP_APPLICATION</code></td>
<td>A JSON structure containing App metadata.</td>
</tr>
<tr>
<td><code>VCAP_SERVICES</code></td>
<td>A JSON structure specifying bound services.</td>
</tr>
</tbody>
</table>
<p>Service credentials from bound services get injected into Apps via the
<code>VCAP_SERVICES</code> environment variable. The variable is a valid JSON object with
the following structure.</p>
<h3 id="vcapservices">VCAPServices</h3>
<p>A JSON object where the keys are Service labels and the values are an array of
<code>VCAPService</code>. The array represents every bound
service with that label.
<a href="/kf/docs/v2.11/developer/backing-services/user-provided-services/">User provided services</a>
are placed under the label <code>user-provided</code>.</p>
<p><strong>Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.json" data-lang=".json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;mysql&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#a40000">...</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;postgresql&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#a40000">...</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;user-provided&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#a40000">...</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="vcapservice">VCAPService</h3>
<p>This type represents a single bound service instance.</p>
<p><strong>Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.json" data-lang=".json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;binding_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;instance_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;label&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;tags&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">string</span><span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;plan&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;credentials&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">object</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Fields</strong></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>binding_name</code></td>
<td><code>string</code></td>
<td>The name assigned to the service binding by the user.</td>
</tr>
<tr>
<td><code>instance_name</code></td>
<td><code>string</code></td>
<td>The name assigned to the service instance by the user.</td>
</tr>
<tr>
<td><code>name</code></td>
<td><code>string</code></td>
<td>The <code>binding_name</code> if it exists; otherwise the <code>instance_name</code>.</td>
</tr>
<tr>
<td><code>label</code></td>
<td><code>string</code></td>
<td>The name of the service offering.</td>
</tr>
<tr>
<td><code>tags</code></td>
<td><code>string[]</code></td>
<td>An array of strings an app can use to identify a service instance.</td>
</tr>
<tr>
<td><code>plan</code></td>
<td><code>string[]</code></td>
<td>The service plan selected when the service instance was created.</td>
</tr>
<tr>
<td><code>credentials</code></td>
<td><code>object</code></td>
<td>The service-specific credentials needed to access the service instance.</td>
</tr>
</tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Use the <code>tags</code> field to discover services in your App rather than filtering by
plan/label so you can swap implementations and providers per environment.
</aside>


<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The <code>credentials</code> field is <em>often</em> an object with string keys and values.
However, the values are allowed to be <a href="https://github.com/openservicebrokerapi/servicebroker/blob/v2.15/spec.md#body-9">any type</a>.
</aside>

<h3 id="vcap_application">VCAP_APPLICATION</h3>
<p>The<code>VCAP_APPLICATION</code> environment variable is a JSON object containing metadata about the App.</p>
<p><strong>Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.json" data-lang=".json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;application_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;12345&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;application_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my-app&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;application_uris&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;my-app.example.com&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;limits&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;disk&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;mem&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">256</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my-app&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;process_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;12345&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;process_type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;space_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my-ns&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;uris&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;my-app.example.com&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Fields</strong></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>application_id</code></td>
<td><code>string</code></td>
<td>The GUID identifying the App.</td>
</tr>
<tr>
<td><code>application_name</code></td>
<td><code>string</code></td>
<td>The name assigned to the App when it was pushed.</td>
</tr>
<tr>
<td><code>application_uris</code></td>
<td><code>string[]</code></td>
<td>The URIs assigned to the App.</td>
</tr>
<tr>
<td><code>limits</code></td>
<td><code>object</code></td>
<td>The limits to disk space, and memory permitted to the App. Memory and disk space limits are supplied when the App is deployed, either on the command line or in the App manifest. Disk and memory limits are represented as integers, with an assumed unit of MB.</td>
</tr>
<tr>
<td><code>name</code></td>
<td><code>string</code></td>
<td>Identical to <code>application_name</code>.</td>
</tr>
<tr>
<td><code>process_id</code></td>
<td><code>string</code></td>
<td>The UID identifying the process. Only present in running App containers.</td>
</tr>
<tr>
<td><code>process_type</code></td>
<td><code>string</code></td>
<td>The type of process. Only present in running App containers.</td>
</tr>
<tr>
<td><code>space_name</code></td>
<td><code>string</code></td>
<td>The human-readable name of the Space where the App is deployed.</td>
</tr>
<tr>
<td><code>uris</code></td>
<td><code>string[]</code></td>
<td>Identical to <code>application_uris</code>.</td>
</tr>
</tbody>
</table>
<p><strong>Missing Fields</strong></p>
<p>Some fields in <code>VCAP_APPLICATION</code> that are in Cloud Foundry are currently not supported in Kf.</p>
<p>Besides CF-specific and deprecated fields (<code>cf_api</code>, <code>host</code>, <code>users</code>) the fields that are not supported in Kf are:</p>
<ul>
<li><code>application_version</code> (identical to <code>version</code>)</li>
<li><code>organization_id</code></li>
<li><code>organization_name</code></li>
<li><code>space_id</code></li>
<li><code>start</code> (identical to <code>started_at</code>)</li>
<li><code>started_at_timestamp</code> (identical to <code>state_timestamp</code>)</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9e253740257aaf5fafb8377b39e5e3f3">1.2.1.7 - Build runtime</h1>
    <div class="lead">Reference guide for the application build container environment.</div>
	<p>The Build runtime is the environment Apps are built in.</p>
<table>
<thead>
<tr>
<th></th>
<th>Buildpack Builds</th>
<th>Docker Builds</th>
</tr>
</thead>
<tbody>
<tr>
<td>System libraries</td>
<td>Provided by the Stack</td>
<td>User supplied</td>
</tr>
<tr>
<td>Network access</td>
<td>Full access through Envoy sidecar</td>
<td>Full access through Envoy sidecar</td>
</tr>
<tr>
<td>File system</td>
<td>No storage</td>
<td>No storage</td>
</tr>
<tr>
<td>Language runtime</td>
<td>Provided by the Stack</td>
<td>User supplied</td>
</tr>
<tr>
<td>User</td>
<td>Specified by the Stack</td>
<td>User supplied</td>
</tr>
<tr>
<td>Isolation mechanism</td>
<td>Kubernetes Pod</td>
<td>Kubernetes Pod</td>
</tr>
<tr>
<td>DNS</td>
<td>Provided by Kubernetes</td>
<td>Provided by Kubernetes</td>
</tr>
</tbody>
</table>
<h2 id="environment-variables">Environment variables</h2>
<p>Environment variables are injected into the Build at runtime.
Variables are added based on the following order, where later values override
earlier ones with the same name:</p>
<ol>
<li>Space (set by administrators)</li>
<li>App (set by developers)</li>
<li>System (set by Kf)</li>
</ol>
<p>Kf provides the following system environment variables to Builds:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CF_INSTANCE_ADDR</code></td>
<td>The cluster-visible IP:PORT of the Build.</td>
</tr>
<tr>
<td><code>INSTANCE_GUID</code></td>
<td>Alias of <code>CF_INSTANCE_GUID</code>.</td>
</tr>
<tr>
<td><code>CF_INSTANCE_IP</code></td>
<td>The cluster-visible IP of the Build.</td>
</tr>
<tr>
<td><code>CF_INSTANCE_INTERNAL_IP</code></td>
<td>Alias of <code>CF_INSTANCE_IP</code></td>
</tr>
<tr>
<td><code>VCAP_APP_HOST</code></td>
<td>Alias of <code>CF_INSTANCE_IP</code></td>
</tr>
<tr>
<td><code>CF_INSTANCE_PORT</code></td>
<td>The cluster-visible port of the Build.</td>
</tr>
<tr>
<td><code>LANG</code></td>
<td>Required by Buildpacks to ensure consistent script load order.</td>
</tr>
<tr>
<td><code>MEMORY_LIMIT</code></td>
<td>The maximum amount of memory in MB the Build can consume.</td>
</tr>
<tr>
<td><code>VCAP_APPLICATION</code></td>
<td>A JSON structure containing App metadata.</td>
</tr>
<tr>
<td><code>VCAP_SERVICES</code></td>
<td>A JSON structure specifying bound services.</td>
</tr>
</tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The environment variables Kf provides to Builds are a subset of those provided
to <a href="/kf/docs/v2.11/developer/build-and-deploy/app-runtime/">App Runtime</a>.
</aside>


</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83f77835eae3d15dda612e1c86814bd0">1.2.2 - Backing services</h1>
    <div class="lead">Discover, create, and use backing services.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c2ebc22b9018da19d5d34e6e9c45330c">1.2.2.1 - Backing Services Overview</h1>
    <div class="lead">Learn about how Kf works with backing services.</div>
	<p>Backing services are any processes that the App contacts over the network during its operation.
In traditional operating systems, these services could have been accessed over
the network, a UNIX socket, or could even be a sub-process.
Examples include the following:</p>
<ul>
<li>Databases — for example: MySQL, PostgreSQL</li>
<li>File storage — for example: NFS, FTP</li>
<li>Logging services — for example: syslog endpoints</li>
<li>Traditional HTTP APIs — for example: Google Maps, WikiData, Parcel Tracking APIs</li>
</ul>
<p>Connecting to backing services over the network rather than installing them all
into the same machine allows developers to focus on their App, independent
security upgrades for different components, and flexibility to swap implementations.</p>
<h2 id="backing-services-in-kf">Backing services in Kf</h2>
<p>Kf supports two major types of backing services:</p>
<ul>
<li>
<p><strong>Managed services:</strong> These services are created by a service broker and are tied to the Kf cluster.</p>
</li>
<li>
<p><strong>User-provided services:</strong> These services are created outside of Kf, but get can be bound to apps in the same way
as managed services.</p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aaeb0115cc03519618bc12ca99dd6372">1.2.2.2 - Use managed services</h1>
    <div class="lead">Learn to use the marketplace to find a service, create it, and bind it to an app.</div>
	<h2 id="find-a-service">Find a service</h2>
<p>Use the <code>kf marketplace</code> command to find a service you want to use in your App.
Running the command without arguments will show all the service classes
available. A <strong>service class</strong> represents a specific type of service e.g. a
MySQL database or a Postfix SMTP relay.</p>
<pre tabindex="0"><code>$ kf marketplace
5 services can be used in Space &#34;test&#34;, use the --service flag to list the plans for a service

Broker      Name        Space      Status  Description
minibroker  mariadb                Active  Helm Chart for mariadb
minibroker  mongodb                Active  Helm Chart for mongodb
minibroker  mysql                  Active  Helm Chart for mysql
minibroker  postgresql             Active  Helm Chart for postgresql
minibroker  redis                  Active  Helm Chart for redis
</code></pre><p>Service classes can have multiple plans available. A <strong>service plan</strong> generally
corresponds to a version or pricing tier of the software. You can view the plans
for a specific service by supplying the service name with the marketplace
command:</p>
<pre tabindex="0"><code>$ kf marketplace --service mysql
Name    Free  Status  Description
5-7-14  true  Active  Fast, reliable, scalable, and easy to use open-source relational database system.
5-7-27  true  Active  Fast, reliable, scalable, and easy to use open-source relational database system.
5-7-28  true  Active  Fast, reliable, scalable, and easy to use open-source relational database system.
</code></pre><h2 id="provision-a-service">Provision a service</h2>
<p>Once you have identified a service class and plan to provision, you can create
an instance of the service using <code>kf create-service</code>:</p>
<pre tabindex="0"><code>$ kf create-service mysql 5-7-28 my-db
Creating service instance &#34;my-db&#34; in Space &#34;test&#34;
Waiting for service instance to become ready...
Success
</code></pre><p>Services are provisioned into a single Space. You can see the services in the
current Space by running <code>kf services</code>:</p>
<pre tabindex="0"><code>$ kf services
Listing services in Space: &#34;test&#34;
Name   ClassName  PlanName  Age   Ready  Reason
my-db  mysql      5-7-28    111s  True   &lt;nil&gt;
</code></pre><p>You can delete a service using <code>kf delete-service</code>:</p>
<pre tabindex="0"><code>$ kf delete-service my-db
</code></pre><h2 id="bind-a-service">Bind a service</h2>
<p>Once a service has been created, you can <strong>bind</strong> it to an App, which will
inject credentials into the App so the service can be used. You can create
the binding using <code>kf bind-service</code>:</p>
<pre tabindex="0"><code>$ kf bind-service my-app my-db
Creating service instance binding &#34;binding-my-app-my-db&#34; in Space &#34;test&#34;
Waiting for service instance binding to become ready...
Success
</code></pre><p>You can list all bindings in a Space using the <code>kf bindings</code> command:</p>
<pre tabindex="0"><code>$ kf bindings
Listing bindings in Space: &#34;test&#34;
Name                  App     Service  Age  Ready
binding-my-app-my-db  my-app  my-db    82s  True
</code></pre><p>Once a service is bound, restart the App using <code>kf restart</code> and the credentials
will be in the <a href="/kf/docs/v2.11/developer/build-and-deploy/app-runtime/#vcapservices"><code>VCAP_SERVICES</code></a> environment variable.</p>
<p>You can delete a service binding with the <code>kf unbind-service</code> command:</p>
<pre tabindex="0"><code>$ kf unbind-service my-app my-db
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-65eb33ea4f1b06e45c9630828e66567e">1.2.2.3 - Configure user-provided services</h1>
    <div class="lead">Learn how to inject existing services into your app.</div>
	<p>Users can leverage services that aren&rsquo;t available in the marketplace by creating user-provided service instances.
Once created, user-provided service instances behave like managed service instances created through <code>kf create-service</code>.
Creating, listing, updating, deleting, binding, and unbinding user-provided services are all supported in Kf.</p>
<h2 id="create-a-user-provided-service-instance">Create a user-provided service instance</h2>

<aside class="alert alert-success" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-lightbulb ml-2"></i> <strong>Tip:</strong> The alias for <code>kf create-user-provided-service</code> is <code>kf cups</code>.
</aside>

<p>The name given to a user-provided service must be unique across all service instances in a Space, including services created through a service broker.</p>
<h3 id="deliver-service-credentials-to-an-app">Deliver service credentials to an app</h3>
<p>A user-provided service instance can be used to deliver credentials to an App. For example, a database admin can have a set of credentials for an existing database managed outside of Kf, and these credentials include the URL, port, username, and password used to connect to the database.</p>
<p>The admin can create a user-provided service with the credentials and the developer can bind the service instance to the App. This allows the credentials to be shared without ever leaving the platform. Binding a service instance to an App has the same effect regardless of whether the service is a user-provided service or a marketplace service.</p>
<p>The App is configured with the credentials provided by the user, and the App runtime environment variable <a href="/kf/docs/v2.11/developer/build-and-deploy/app-runtime/#vcapservices"><code>VCAP_SERVICES</code></a> is populated with information about all of the bound services to that App.</p>
<p>A user-provided service can be created with credentials and/or a list of tags.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf cups my-db -p <span style="color:#4e9a06">&#39;{&#34;username&#34;:&#34;admin&#34;, &#34;password&#34;:&#34;test123&#34;, &#34;some-int-val&#34;: 1, &#34;some-bool&#34;: true}&#39;</span> -t <span style="color:#4e9a06">&#34;comma, separated, tags&#34;</span>
</span></span></code></pre></div><p>This will create the user-provided service instance <code>my-db</code> with the provided credentials and tags. The credentials passed in to the <code>-p</code> flag must be valid JSON (either inline or loaded from a file path).</p>
<p>To deliver the credentials to one or more Apps, the user can run <code>kf bind-service</code>.</p>
<p>Suppose we have an App with one bound service, the user-provided service <code>my-db</code> defined above. The <code>VCAP_SERVICES</code> environment variable for that App will have the following contents:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;user-provided&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my-db&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;instance_name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my-db&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;label&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user-provided&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;tags&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;comma&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;separated&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;tags&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;credentials&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;username&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test123&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;some-int-val&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;some-bool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="update-a-user-provided-service-instance">Update a user-provided service instance</h2>

<aside class="alert alert-success" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-lightbulb ml-2"></i> <strong>Tip:</strong> The alias for <code>kf update-user-provided-service</code> is <code>kf uups</code>.
</aside>

<p>A user-provided service can be updated with the <code>uups</code> command. New credentials and/or tags passed in completely overwrite existing ones. For example, if the user created the user-provided service <code>my-db</code> above, called <code>kf bind-service</code> to bind the service to an App, then ran the command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf uups my-db -p <span style="color:#4e9a06">&#39;{&#34;username&#34;:&#34;admin&#34;, &#34;password&#34;:&#34;new-pw&#34;, &#34;new-key&#34;: &#34;new-val&#34;}&#39;</span>
</span></span></code></pre></div><p>The updated credentials will only be reflected on the App after the user unbinds and rebinds the service to the App. No restart or restage of the App is required. The updated <code>VCAP_SERVICES</code> environment variable will have the following contents:</p>
<pre tabindex="0"><code>{
  &#34;user-provided&#34;: [
    {
      &#34;name&#34;: &#34;my-db&#34;,
      &#34;instance_name&#34;: &#34;my-db&#34;,
      &#34;label&#34;: &#34;user-provided&#34;,
      &#34;tags&#34;: [
        &#34;comma&#34;,
        &#34;separated&#34;,
        &#34;tags&#34;
      ],
      &#34;credentials&#34;: {
        &#34;username&#34;: &#34;admin&#34;,
        &#34;password&#34;: &#34;new-pw&#34;,
        &#34;new-key&#34;: &#34;new-val&#34;
      }
    }
  ]
}
</code></pre><p>The new credentials overwrite the old credentials, and the tags are unchanged because they were not specified in the update command.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcb66f5640af578e83d147a64abbd646">1.2.2.4 - User Provided Service Templates</h1>
    <div class="lead">Learn how to set up user provided services for MySQL, Redis, and RabbitMQ.</div>
	
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> You can leverage services that aren&rsquo;t listed in the marketplace by creating user-provided service instances that an App can bind to. Learn more about <a href="/kf/docs/v2.11/developer/backing-services/user-provided-services/">user-provided services</a>.
</aside>

<h2 id="before-you-begin">Before you begin</h2>
<ul>
<li>Ensure your service is running and accessible on the same network running your Kf cluster.</li>
<li>Ensure you have targeted the Space where you want to create the service.</li>
</ul>
<h2 id="create-the-user-provided-instance">Create the user-provided instance</h2>
<p>The following examples use the most common parameters used by applications to autoconfigure services.
Most libraries use tags to find the right bound service and a URI to connect.</p>
<h3 id="mysql">MySQL</h3>
<p>MySQL libraries usually expect the tag <code>mysql</code> and the following parameters:</p>
<dl>
<dt><code>uri</code></dt>
<dd>Example <code>mysql://username:password@host:port/dbname</code>. The <a href="https://dev.mysql.com/doc/refman/8.0/en/connecting-using-uri-or-key-value-pairs.html">MySQL documentation</a> can help with creating a URI string. The port is usually <code>3306</code>.</dd>
<dt><code>username</code></dt>
<dd>The connection username, required by some libraries even if included in <code>uri</code>.</dd>
<dt><code>password</code></dt>
<dd>The connection password, required by some libraries even if included in <code>uri</code>.</dd>
</dl>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf cups service-instance-name <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -p <span style="color:#4e9a06">&#39;{&#34;username&#34;:&#34;my-username&#34;, &#34;password&#34;:&#34;my-password&#34;, &#34;uri&#34;:&#34;mysql://my-username:my-password@mysql-host:3306/my-db&#34;}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -t <span style="color:#4e9a06">&#34;mysql&#34;</span>
</span></span></code></pre></div><h3 id="rabbitmq">RabbitMQ</h3>
<p>RabbitMQ libraries usually expect the tag <code>rabbitmq</code> and the following parameters:</p>
<dl>
<dt><code>uri</code></dt>
<dd>Example <code>amqp://username:password@host:port/vhost?query</code>. The <a href="https://www.rabbitmq.com/uri-spec.html">RabbitMQ documentation</a> can help with creating a URI string. The port is usually <code>5672</code>.</dd>
</dl>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf cups service-instance-name <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -p <span style="color:#4e9a06">&#39;{&#34;uri&#34;:&#34;amqp://username:password@host:5672&#34;}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -t <span style="color:#4e9a06">&#34;rabbitmq&#34;</span>
</span></span></code></pre></div><h3 id="redis">Redis</h3>
<p>Redis libraries usually expect the tag <code>redis</code> and the following parameters:</p>
<dl>
<dt><code>uri</code></dt>
<dd>Example <code>redis://:password@host:port/uery</code>. The <a href="https://www.iana.org/assignments/uri-schemes/prov/redis">IANA Redis URI documentation</a> can help with creating a URI string. The port is usually <code>6379</code>.</dd>
</dl>
<p>Example for Redis with no AUTH configured:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf cups service-instance-name <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -p <span style="color:#4e9a06">&#39;{&#34;uri&#34;:&#34;redis://redis-host:6379&#34;}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -t <span style="color:#4e9a06">&#34;redis&#34;</span>
</span></span></code></pre></div><p>Example for Redis with AUTH configured:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf cups service-instance-name <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -p <span style="color:#4e9a06">&#39;{&#34;uri&#34;:&#34;redis://:password@redis-host:6379&#34;}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -t <span style="color:#4e9a06">&#34;redis&#34;</span>
</span></span></code></pre></div><h2 id="bind-your-app">Bind your App</h2>
<p>Once the user-provided service has been created, you can bind your App to the
user provided service by name, just like a managed service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf bind-service application-name service-instance-name
</span></span></code></pre></div><h2 id="whats-next">What&rsquo;s next</h2>
<ul>
<li>Learn about <a href="/kf/docs/v2.11/developer/build-and-deploy/app-runtime/#vcapservices">how the credentials are injected into your app</a>.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7c5cfb1597b32604da9ea5cb7a9bb1d5">1.2.2.5 - Configure NFS volumes</h1>
    <div class="lead">Learn how to use an NFS volume as a mounted drive.</div>
	<p>Kf supports mounting NFS volumes using the <code>kf marketplace</code>.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Your administrator must have <a href="/kf/docs/v2.11/operator/service-brokers/nfs-platform-setup/">completed the NFS platform setup guide</a>.</li>
</ul>
<h2 id="create-an-nfs-service-instance">Create an NFS service instance</h2>
<p>Run <code>kf marketplace</code> to see available services. The built-in NFS service appears on the list if NFS is enabled on the platform.</p>
<pre tabindex="0"><code>Broker           Name  Namespace  Description
nfsvolumebroker  nfs              mount nfs shares
</code></pre><h2 id="mount-an-external-filesystem">Mount an external filesystem</h2>
<h3 id="create-a-service-instance">Create a service instance</h3>
<p>To mount to an existing NFS service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-service nfs existing SERVICE-INSTANCE-NAME -c <span style="color:#4e9a06">&#39;{&#34;share&#34;:&#34;SERVER/SHARE&#34;, &#34;capacity&#34;:&#34;CAPACITY&#34;}&#39;</span>
</span></span></code></pre></div><p>Replace variables with your values.</p>
<ul>
<li><var>SERVICE-INSTANCE-NAME</var> is the name you want for this NFS volume service instance.</li>
<li><var>SERVER/SHARE</var> is the NFS address of your server and share.</li>
<li><var>CAPACITY</var> uses the <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Kubernetes quantity</a> format.</li>
</ul>
<p>Confirm that the NFS volume service appears in your list of services. You can expect output similar to this example:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf services
...
Listing services in Space: demo-space
Name                Type      ClassName         PlanName  Age    Ready  Reason
filestore-nfs       volume    nfs               existing  6s     True   &lt;nil&gt;
...
</code></pre><h3 id="bind-your-service-instance-to-an-app">Bind your service instance to an App</h3>
<p>To bind an NFS service instance to an App, run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf bind-service YOUR-APP-NAME SERVICE-NAME -c <span style="color:#4e9a06">&#39;{&#34;uid&#34;:&#34;2000&#34;,&#34;gid&#34;:&#34;2000&#34;,&#34;mount&#34;:&#34;MOUNT-PATH&#34;,&#34;readonly&#34;:true}&#39;</span>
</span></span></code></pre></div><p>Replace variables with your values.</p>
<ul>
<li>
<p><var>YOUR-APP-NAME</var> is the name of the App for which you want to use the volume service.</p>
</li>
<li>
<p><var>SERVICE-NAME</var> is the name of the volume service instance you created in the previous step.</p>
</li>
<li>
<p><code>uid</code>:<var>UID</var> and <code>gid</code>:<var>GID</var> specify the directory permissions of the mounting share.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> For V2 buildpack Apps, the value for <code>uid</code> and <code>gid</code> is always 2000.
Otherwise, the user specified by <code>uid</code> and <code>gid</code> should be the <code>uid</code>
and <code>gid</code> of the running App process.
</aside>

</li>
<li>
<p><var>MOUNT-PATH</var> is the path the volume should be mounted to within your App.</p>
</li>
<li>
<p>(Optional) <code>&quot;readonly&quot;:true</code> is an optional JSON string that creates a read-only mount.
By default, Volume Services mounts a read-write file system.</p>
<p>Note: Your App automatically restarts when the NFS binding changes.</p>
</li>
</ul>
<p>You can list all bindings in a Space using the <code>kf bindings</code> command. You will see output similar to this example:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf bindings
...
Listing bindings in Space: demo-space
Name                                     App           Service             Age  Ready
binding-spring-music-filestore-nfs       spring-music  filestore-nfs       71s  True
...
</code></pre><h3 id="access-the-volume-service-from-your-app">Access the volume service from your App</h3>
<p>To access the volume service from your App, you must know which file path to use in your code.
You can view the file path in the details of the service binding, which are visible in the environment variables for your App.</p>
<p>View environment variables for your App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf vcap-services YOUR-APP-NAME
</span></span></code></pre></div><p>Replace <var>YOUR-APP-NAME</var> with the name of your App.</p>
<p>The following is example output of the <code>kf vcap-services</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf vcap-services YOUR-APP-NAME
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;nfs&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;instance_name&#34;</span>: <span style="color:#4e9a06">&#34;nfs-instance&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;nfs-instance&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;label&#34;</span>: <span style="color:#4e9a06">&#34;nfs&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;tags&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[]</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;plan&#34;</span>: <span style="color:#4e9a06">&#34;existing&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;credentials&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;capacity&#34;</span>: <span style="color:#4e9a06">&#34;1Gi&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;gid&#34;</span>: 2000,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;mount&#34;</span>: <span style="color:#4e9a06">&#34;/test/mount&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;share&#34;</span>: <span style="color:#4e9a06">&#34;10.91.208.210/test&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;uid&#34;</span>: <span style="color:#0000cf;font-weight:bold">2000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;volume_mounts&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#4e9a06">&#34;container_dir&#34;</span>: <span style="color:#4e9a06">&#34;/test/mount&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#4e9a06">&#34;device_type&#34;</span>: <span style="color:#4e9a06">&#34;shared&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#4e9a06">&#34;mode&#34;</span>: <span style="color:#4e9a06">&#34;rw&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Use the properties under <code>volume_mounts</code> for any information required by your App.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>container_dir</code></td>
<td>String containing the path to the mounted volume that you bound to your App.</td>
</tr>
<tr>
<td><code>device_type</code></td>
<td>The NFS volume release. This currently only supports shared devices. A shared device represents a distributed file system that can mount on all App instances simultaneously.</td>
</tr>
<tr>
<td><code>mode</code></td>
<td>String that informs what type of access your App has to NFS, either <code>ro</code> (read-only), or <code>rw</code> (read and write).</td>
</tr>
</tbody>
</table>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c16824af8fd2a461ef90c4f8160d9b6c">1.2.3 - Scaling</h1>
    <div class="lead">Learn to scale apps up or down.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b382e70e5bab4b7f5eb676e75ffdd352">1.2.3.1 - Scaling overview</h1>
    <div class="lead">Learn about how Kf scales apps.</div>
	<p>Kf leverages the Kubernetes Horizontal Pod Autoscaler (HPA)
to automatically scale the number of Pods in a App. When autoscaling is enabled
for an App, an HPA object is created and bound to the App object. It then dynamically
calculates the target scale and sets it for the App.</p>
<h2 id="how-kf-scaling-works">How Kf scaling works</h2>
<p>The number of Pods that are deployed for a Kf App is
controlled by its underlying Deployment object&rsquo;s <code>replicas</code> field. The target
number of Deployment replicas is set through the App&rsquo;s <code>replicas</code> field.</p>
<p>Scaling can be done manually with the <code>kf scale</code> command.
This command is disabled when autoscaling is enabled to avoid conflicting targets.</p>
<h2 id="how-the-kubernetes-horizontal-pod-autoscaler-works">How the Kubernetes Horizontal Pod Autoscaler works</h2>
<p>The Horizontal Pod Autoscaler (HPA) is implemented as a Kubernetes API resource
(the HPA object) and a control loop (the HPA controller) which periodically
calculates the number of desired replicas based on current resource utilization.
The HPA controller then passes the number to the target object that implements the
Scale subresource. The actual scaling is delegated to the underlying object and
its controller. You can find more information in the <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Kubernetes documentation</a>.</p>
<h3 id="how-the-autoscaler-determines-when-to-scale">How the Autoscaler determines when to scale</h3>
<p>Periodically, the HPA controller queries the resource utilization against
the metrics specified in each HorizontalPodAutoscaler definition. The controller
obtains the metrics from the resource metrics API for each Pod. Then the
controller calculates the utilization value as a percentage of the equivalent
resource request. The desired number of replicas is then calculated based on the
ratio of current percentage and desired percentage. You can read more about the
<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details">autoscaling algorithm</a> in the Kubernetes documentation.</p>
<h3 id="metrics">Metrics</h3>
<p>Kf uses HPA v1 which only supports CPU as the target metric.</p>
<h2 id="how-the-kubernetes-horizontal-autoscaler-works-with-kf">How the Kubernetes Horizontal Autoscaler works with Kf</h2>
<p>When autoscaling is enabled for a Kf App, the Kf
controller will create an HPA object based on the scaling limits and rules
specified on the App. Then the HPA controller fetches the specs from the HPA
object and scales the App accordingly.</p>
<p>The HPA object will be deleted if Autoscaling is disabled or if the
corresponding App is deleted.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8412b2ccff3bf6d3216d6875e40cd997">1.2.3.2 - Manage Autoscaling</h1>
    <div class="lead">Learn to use autoscaling for your app.</div>
	<p>Kf Apps can be automatically scaled based on CPU usage.
You can configure autoscaling limits for your Apps and the target CPU usage for
each App instance. Kf automatically scales your Apps up
and down in response to demand.</p>
<p>By default, autoscaling is disabled. Follow the steps below to enable autoscaling.</p>
<h2 id="view-apps">View Apps</h2>
<p>You can view the autoscaling status for an App using the <code>kf apps</code>
command. If autoscaling is enabled for an App, <code>Instances</code> includes the
autoscaling status.</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf apps

Name   Instances              Memory  Disk  CPU
app1   4 (autoscaled 4 to 5)  256Mi   1Gi   100m
app2   1                      256Mi   1Gi   100m
</code></pre><p>Autoscaling is enabled for <code>app1</code> with <code>min-instances</code> set to 4 and
<code>max-instances</code> set to 5. Autoscaling is disabled for <code>app2</code>.</p>
<h2 id="update-autoscaling-limits">Update autoscaling limits</h2>
<p>You can update the instance limits using the <code>kf update-autoscaling-limits</code>
command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf update-autoscaling-limits app-name min-instances max-instances
</span></span></code></pre></div><h2 id="create-autoscaling-rule">Create autoscaling rule</h2>
<p>You can create autoscaling rules using the <code>kf create-autoscaling-rule</code>
command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-autoscaling-rule app-name CPU min-threshold max-threshold
</span></span></code></pre></div><h2 id="delete-autoscaling-rules">Delete autoscaling rules</h2>
<p>You can delete all autoscaling rules with the
<code>kf delete-autoscaling-rule</code> command. Kf only supports
one autoscaling rule.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete-autoscaling-rules app-name
</span></span></code></pre></div><h2 id="enable-and-disable-autoscaling">Enable and disable autoscaling</h2>
<p>Autoscaling can be enabled by using <code>enable-autoscaling</code> and
disabled by using <code>disable-autoscaling</code>. When it is disabled, the
configurations, including limits and rules, are preserved.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf enable-autoscaling app-name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kf disable-autoscaling app-name
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-942fc5a9d62607b3fdeac4fd7cc64e68">1.2.4 - Service discovery</h1>
    <div class="lead">Connect to other Apps in the Kf cluster.</div>
	<p>This document is an overview of Kubernetes DNS-based service discovery
and how it can be used with Kf.</p>
<h2 id="when-to-use-kubernetes-service-discovery-with-kf">When to use Kubernetes service discovery with Kf</h2>
<p>Kubernetes service discovery can be used by applications that need to locate
backing services in a consistent way regardless of where the application is
deployed. For example, a team might want to use a common URI in their
configuration that always points at the local SMTP gateway to decouple code from
the environment it ran in.</p>
<p>Service discovery helps application teams by:</p>
<ul>
<li>Reducing the amount of per-environment configuration.</li>
<li>Decoupling client and server applications.</li>
<li>Allowing applications to be portable to new environments.</li>
</ul>
<p>You can use Kubernetes service discovery when:</p>
<ul>
<li>Applications use their container&rsquo;s DNS configurations to resolve hosts.</li>
<li>Applications are deployed with their backing services in the same Kubernetes cluster or namespace.</li>
<li>Backing services have an associated
<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes service</a>.
Kf creates these for each app.</li>
<li>Kubernetes NetworkPolicies allow traffic between an application and the
Kubernetes service it needs to communicate with. Kf
creates these policies in each Kf space.</li>
</ul>
<p>You <strong>should not</strong> use Kubernetes service discovery if:</p>
<ul>
<li>Applications need to failover between multiple clusters.</li>
<li>You override the DNS resolver used by your application.</li>
<li>Applications need specific types of load balancing.</li>
</ul>
<h2 id="how-kubernetes-service-discovery-works">How Kubernetes service discovery works</h2>
<p>Kubernetes service discovery works by
<a href="https://cloud.google.com/kubernetes-engine/docs/concepts/service-discovery">modifying the DNS configuration</a>
of containers running on a Kubernetes node. When an application looks up an
unqualified domain name, the local DNS resolver will first attempt to resolve
the name in the local cluster.</p>
<p>Domains without multiple parts will be resolved against the names of Kubernetes
services in the container&rsquo;s namespace. Each Kf app
creates a Kubernetes service with the same name. If two
Kf apps <code>ping</code> and <code>pong</code> were deployed in the same
Kf space, then <code>ping</code> could use the URL <code>http://pong</code> to
send traffic to the other service.</p>
<p>Domains with a single dot will be resolved against the Kubernetes services in
the Kubernetes namespace with the same name as the label after the dot. For
example, if there was a PostgreSQL database with a <code>customers</code> service in the
<code>database</code> namespace, an application in another namespace could
resolve it using <code>postgres://customers.database</code>.</p>
<h2 id="how-to-use-service-discovery-with-kf">How to use service discovery with Kf</h2>
<p>Kubernetes DNS based service discovery can be used in any
Kf app. Each Kf app creates a
Kubernetes service of the same name, and each Kf
space creates a Kubernetes namespace with the same name.</p>
<ul>
<li>Refer to a Kf app in the current space using
<code><var>protocol</var>://<var>app-name</var></code>.</li>
<li>Refer to a Kf app in a different space using
<code><var>protocol</var>://<var>app-name</var>.<var>space-name</var></code>.</li>
<li>Refer to a Kf app in the current space listening on
a custom port using
<code><var>protocol</var>://<var>app-name</var>:<var>port</var></code>.</li>
<li>Refer to a Kf app in a different space listening
a custom port using
<code><var>protocol</var>://<var>app-name</var>.<var>space-name</var>:<var>port</var></code>.</li>
</ul>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> For Kubernetes services managed by Kf, TCP port 80
always maps to the same port in the app&rsquo;s <code>PORT</code> environment variable. This is
even true if the Kf app doesn&rsquo;t serve HTTP traffic.
</aside>

<h2 id="best-practices">Best practices</h2>
<p>Applications that are going to be the target of DNS based service discovery
should have frequent <a href="/kf/docs/v2.11/developer/build-and-deploy/manifest/#health_check_types">health checks</a>
to ensure they are rapidly added and removed from the pool of hosts that accept
connections.</p>
<p>Applications using DNS based service discovery should not cache the IP addresses
of the resolved services because they are not guaranteed to be stable.</p>
<p>If environment specific services exist outside of the cluster, they can be
resolved using Kubernetes DNS if you set up
<a href="https://kubernetes.io/docs/concepts/services-networking/service/#externalname">ExternalName Kubernetes services</a>.
These Kubernetes services provide the same resolution capabilities, but return a
CNAME record to redirect requests to an external authority.</p>
<h2 id="comparison-to-eureka">Comparison to Eureka</h2>
<p>Eureka is an open source client-side load-balancer created by Netflix. It is
commonly used as part of the
<a href="https://docs.pivotal.io/spring-cloud-services/3-1/common/service-registry/index.html">Spring Cloud Services</a>
service broker. Eureka was
<a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance#what-is-eureka">built to be a regional load balancer and service discovery mechanism</a>
for services running in an environment that caused frequent disruptions to
workloads leading to unstable IP addresses.</p>
<p>Eureka is designed as a client/server model. Clients register themselves with
the server indicating which names they want to be associated with and
periodically send the server heartbeats. The server allows all connected clients
to resolve names.</p>
<p>In general, you should use Kubernetes DNS rather than Eureka in Kubernetes for
the following reasons:</p>
<ul>
<li>DNS works with all programming languages and applications without the need for libraries.</li>
<li>Your application&rsquo;s existing health check will be reused reducing combinations of errors.</li>
<li>Kubernetes manages the DNS server, allowing you to rely on fewer dependencies.</li>
<li>Kubernetes DNS respects the same policy and RBAC constraints as the rest of Kubernetes.</li>
</ul>
<p>There are a few times when deploying a Eureka server would be advantageous:</p>
<ul>
<li>You need service discovery across Kubernetes and VM based applications.</li>
<li>You need client based load-balancing.</li>
<li>You need independent health checks.</li>
</ul>
<h2 id="whats-next">What&rsquo;s next</h2>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/service-discovery">Read more about service discovery in GKE</a>.</li>
<li>Learn about <a href="https://cloud.google.com/service-directory">Service Directory</a>, a managed offering similar to Eureka.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-112457d24a74b66b91a3aad98b695483">1.2.5 - Configure routes and domains</h1>
    <div class="lead">Make your app reachable over the network.</div>
	<p>This page describes how routes and domains work in Kf, and how developers and administrators configure routes and domains for an App deployed on Kf cluster.</p>
<p>You must create domain and routes to give external access to your application.</p>
<h2 id="internal-routing">Internal routing</h2>
<p>Kf apps can communicate internally with other apps in the cluster directly using a service mesh without leaving the cluster network. By default, all traffic on the service mesh is encrypted using mutual TLS.</p>
<p>All apps deployed in the Kf cluster come with an internal endpoint configured by default. You can use the address <code><var>app-name</var>.<var>space-name</var>.svc.cluster.local</code> for internal communication between apps. To use this internal address no extra steps are required. Mutual TLS is enabled by default for internal routes. Note that this internal address is only accessible from the pods running the apps and not accessible from outside the cluster.</p>
<h3 id="app-load-balancing">App load balancing</h3>
<p>Traffic is routed by Istio to healthy instances of an App using a
<a href="https://en.wikipedia.org/wiki/Round-robin_DNS">round-robin</a>
policy. Currently, this policy can&rsquo;t be changed.</p>
<h2 id="route-capabilities">Route capabilities</h2>
<p>Routes tell the cluster&rsquo;s ingress gateway where to deliver traffic and what to
do if no Apps are available on the given address.
By default, if no App is available on a Route and the Route receives a request
it returns an <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503">HTTP 503 status code</a>.</p>
<p>Routes are comprised of three parts: host, domain, and path. For example, in
the URI <code>payroll.mydatacenter.example.com/login</code>:</p>
<ul>
<li>The host is <code>payroll</code></li>
<li>The domain is <code>mydatacenter.example.com</code></li>
<li>The path is <code>/login</code></li>
</ul>
<p>Routes <em>must</em> contain a domain, but the host and path is optional. Multiple
Routes can share the same host and domain if they specify different paths.
Multiple Apps can share the same Route and traffic will be split between them.
This is useful if you need to support legacy blue/green deployments. If
multiple Apps are bound to different paths, the priority is longest to
shortest path.</p>
<p>Warning: Kf doesn&rsquo;t currently support TCP port-based routing. You must use a
<a href="https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/">Kubernetes LoadBalancer</a>
if you want to expose a TCP port to the Internet. Ports are available on the cluster internal App address <code>&lt;app-name&gt;.&lt;space&gt;</code>.</p>
<h2 id="manage-routes">Manage routes</h2>
<p>The following sections describe how to use the <code>kf</code> CLI to manage Routes.</p>
<h3 id="list-routes">List routes</h3>
<p>Developers can list Routes for the current Space using the <code>kf routes</code>
command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.sh" data-lang=".sh"><span style="display:flex;"><span>$ kf routes
</span></span><span style="display:flex;"><span>Getting Routes in Space: my-space
</span></span><span style="display:flex;"><span>Found <span style="color:#0000cf;font-weight:bold">2</span> Routes in Space my-space
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOST    DOMAIN       PATH    APPS
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span>    example.com  /       <span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span>*       example.com  /login  uaa
</span></span></code></pre></div><h3 id="create-a-route">Create a route</h3>
<p>Developers can create Routes using the <code>kf create-route</code> command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.sh" data-lang=".sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create a Route in the targeted Space to match traffic for myapp.example.com/*</span>
</span></span><span style="display:flex;"><span>$ kf create-route example.com --hostname myapp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create a Route in the Space myspace to match traffic for myapp.example.com/*</span>
</span></span><span style="display:flex;"><span>$ kf create-route -n myspace example.com --hostname myapp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create a Route in the targeted Space to match traffic for myapp.example.com/mypath*</span>
</span></span><span style="display:flex;"><span>$ kf create-route example.com --hostname myapp --path /mypath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># You can also supply the Space name as the first parameter if you have</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># scripts that rely on the old cf style API.</span>
</span></span><span style="display:flex;"><span>$ kf create-route myspace example.com --hostname myapp <span style="color:#8f5902;font-style:italic"># myapp.example.com</span>
</span></span></code></pre></div><p>After a Route is created, if no Apps are bound to it then an <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503">HTTP 503 status code</a>
is returned for any matching requests.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Routes that share the same host and domain must be in the same Space.
</aside>

<h3 id="map-a-route-to-your-app">Map a route to your app</h3>
<p>Developers can make their App accessible on a Route using the <code>kf map-route</code>
command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.sh" data-lang=".sh"><span style="display:flex;"><span>$ kf map-route MYAPP mycluster.example.com --host myapp --path mypath
</span></span></code></pre></div>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> <code>map-route</code> creates the Route if it doesn&rsquo;t exist yet.
</aside>

<h3 id="unmap-a-route">Unmap a route</h3>
<p>Developers can remove their App from being accessible on a Route using the <code>kf unmap-route</code> command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.sh" data-lang=".sh"><span style="display:flex;"><span>$ kf unmap-route MYAPP mycluster.example.com --host myapp --path mypath
</span></span></code></pre></div><h3 id="delete-a-route">Delete a route</h3>
<p>Developers can delete a Route using the <code>kf delete-route</code> command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.sh" data-lang=".sh"><span style="display:flex;"><span>$ kf delete-route mycluster.example.com --host myapp --path mypath
</span></span></code></pre></div><p>Deleting a Route will stop traffic from being routed to all Apps listening on
the Route.</p>
<h3 id="manage-routes-declaratively-in-your-app-manifest">Manage routes declaratively in your app manifest</h3>
<p>Routes can be managed declaratively in your app manifest file. They will be
created if they do not yet exist.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.yaml" data-lang=".yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">applications</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-app</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">route</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">www.example.com/path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can read more about the supported
route properties in the <a href="manifest">manifest documentation</a>.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Declaring Routes in your manifest file only creates new Routes, it
does not delete Routes you created manually or as part of a previous push.
</aside>

<h2 id="routing-crds">Routing CRDs</h2>
<p>There are four types that are relevant to routing:</p>
<ul>
<li>VirtualService</li>
<li>Route</li>
<li>Service</li>
<li>App</li>
</ul>
<p>Each App has a Service, which is an abstract name given to all running instances
of your App. The name of the Service is the same as the App. A Route represents
a single external URL. Routes constantly watch for changes to Apps, when an App
requests to be added to a Route, the Route updates its list of Apps and then the
VirtualService. A VirtualService represents a single domain and merges a list of
all Routes in a Space that belong to that domain.</p>
<p>Istio reads the configuration on VirtualServices to determine how to route
traffic.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-08ccb5aed1b65bbb79ebfe9a95bdfda5">1.2.6 - Tasks</h1>
    <div class="lead">Learn how to run one-off jobs using Kf.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-fc8abef5d8b8b4cd00451c7fbf42f60e">1.2.6.1 - Tasks Overview</h1>
    <div class="lead">Understand how tasks work in Kf.</div>
	<h2 id="about-tasks">About Tasks</h2>
<p>Unlike Apps which run indefinitely and restart if the process terminates, Tasks run a process until it completes and then stop.
Tasks are run in their own containers and are based on the configuration and binary of an existing App.</p>
<p>Tasks are not accessible from routes, and should be used for one-off or scheduled recurring work necessary for the health of an
application.</p>
<h2 id="use-cases-for-tasks">Use cases for Tasks</h2>
<ul>
<li>Migrating a database</li>
<li>Running a batch job (scheduled/unscheduled)</li>
<li>Sending an email</li>
<li>Transforming data (ETL)</li>
<li>Processing data (upload/backup/download)</li>
</ul>
<h2 id="how-tasks-work">How Tasks work</h2>
<p>Tasks are executed asynchronously and run independently from the parent App or other Tasks running on the same App. An App created for running Tasks does not have routes created or assigned, and the <strong>Run</strong> lifecycle is skipped. The <strong>Source code upload</strong> and <strong>Build</strong> lifecycles still proceed and result in a container image used for running Tasks after pushing the App (see App lifecycles at <a href="/kf/docs/v2.11/developer/build-and-deploy/deploying-an-app/">Deploying an Application</a>).</p>
<p>The lifecycle of a Task is as follows:</p>
<ol>
<li>You push an App for running tasks with the <code>kf push APP_NAME --task</code> command.</li>
<li>You run a Task on the App with the <code>kf run-task APP_NAME</code> command. Task inherits the environment variables, service bindings, resource allocation, start-up command, and security groups bound to the App.</li>
<li>Kf creates a Tekton <a href="https://github.com/tektoncd/pipeline/blob/master/docs/pipelineruns.md">PipelineRun</a> with values from the App and parameters from the <code>run-task</code> command.</li>
<li>The Tekton PipelineRun creates a Kubernetes Pod which launches a container based on the configurations on the App and Task.</li>
<li>Task execution stops (Task exits or is terminated manually), the underlying Pod is either stopped or terminated. Pods of stopped Tasks are preserved and thus Task logs are accessible via the <code>kf logs APP_NAME --task</code> command.</li>
<li>If you terminate a Task before it stops, the Tekton PipelineRun is cancelled (see <a href="https://github.com/tektoncd/pipeline/blob/master/docs/pipelineruns.md#cancelling-a-pipelinerun">Cancelling a PipelineRun</a>), the underlying Pod together with the logs are deleted. The logs of termianted Tasks are delivered to the cluster level logging streams if configured (e.g. Stackdriver, Fluentd).</li>
<li>If the number of Tasks run on an App is greater than 500, the oldest Tasks are automatically deleted.</li>
</ol>
<h2 id="tasks-retention-policy">Tasks retention policy</h2>
<p>Tasks are created as custom resources in the Kubernetes cluster, therefore, it is important not to exhaust the space of the underlying <code>etcd</code> database. By default, Kf only keeps the latest 500 Tasks per each App. Once the number of Tasks reach 500, the oldest Tasks (together with the underlying Pods and logs) will be automatically deleted.</p>
<h2 id="task-logging-and-execution-history">Task logging and execution history</h2>
<p>Any data or messages the Task outputs to STDOUT or STDERR is available by using the <code>kf logs APP_NAME --task</code> command. Cluster level logging mechanism (such as Stackdriver, Fluentd) will deliver the Task logs to the configured logging destination.</p>
<h2 id="scheduling-tasks">Scheduling Tasks</h2>
<p>As described above, Tasks can be run asynchronously by using the <code>kf run-task APP_NAME</code> command.
Alternatively, you can schedule Tasks for execution by first creating a Job using
the <code>kf create-job</code> command, and then scheduling it with the
<code>kf schedule-job JOB_NAME</code> command. You can schedule that Job to automatically
run Tasks on a specified <a href="https://man7.org/linux/man-pages/man5/crontab.5.html">unix-cron</a> schedule.</p>
<h3 id="how-tasks-are-scheduled">How Tasks are scheduled</h3>
<p>Create and schedule a Job to run the Task. A Job describes the Task to execute
and automatically manages Task creation.</p>
<p>Tasks are created on the schedule even if previous executions of the Task are still running.
If any executions are missed for any reason, only the most recently missed execution
are executed when the system recovers.</p>
<p>Deleting a Job deletes all associated Tasks. If any associated Tasks were still
in progress, they are forcefully deleted without running to completion.</p>
<p>Tasks created by a scheduled Job are still subject to the
<a href="#tasks_retention_policy">Task retention policy</a>.</p>
<h3 id="differences-from-pcf-scheduler">Differences from PCF Scheduler</h3>
<p>PCF Scheduler allows multiple schedules for a single Job while Kf
only supports a single schedule per Job. You can replicate the PCF Scheduler
behavior by creating multiple Jobs, one for each schedule.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1fe7b60117f61a59570dc9806b2e2128">1.2.6.2 - Run Tasks</h1>
    <div class="lead">Learn how to use tasks to run one-off jobs.</div>
	<p>You can execute short-lived workflows by running them as Tasks in
Kf. Tasks are run under Apps, meaning that each Task must
have an associated App. Each Task execution uses the build artifacts from the
parent App. Because Tasks are short-lived, the App is not deployed as a
long-running application, and no routes should be created for the App or the Task.</p>
<h2 id="push-an-app-for-running-tasks">Push an App for running Tasks</h2>
<ol>
<li>
<p>Clone the <a href="https://github.com/cloudfoundry-samples/test-app">test-app repo</a> repo:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/cloudfoundry-samples/test-app test-app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> test-app
</span></span></code></pre></div></li>
<li>
<p>Push the App.</p>
<p>Push the App with the <code>kf push APP_NAME --task</code> command. The <code>--task</code> flag
indicates that the App is meant to be used for running Tasks, and thus no
routes are created on the App, and it is not deployed as a long-running
application:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push test-app --task
</span></span></code></pre></div></li>
<li>
<p>Confirm that no App instances or routes were created by listing the App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf apps
</span></span></code></pre></div><p>Notice that the App is not started and has no URLs:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">Listing Apps in Space: test-space
Name                     Instances  Memory  Disk  CPU   URLs
test-app                 stopped    1Gi     1Gi   100m  &lt;nil&gt;
</code></pre></li>
</ol>
<h2 id="run-a-task-on-the-app">Run a Task on the App</h2>
<p>When you run a Task on the App, you can optionally specify a start command by
using the <code>--command</code> flag. If no start command is specified, it uses the start
command specified on the App. If the App doesn&rsquo;t have a start command specified,
it looks up the CMD configuration of the container image. A start command must
exist in order to run the Task successfully.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf run-task test-app --command <span style="color:#4e9a06">&#34;printenv&#34;</span>
</span></span></code></pre></div><p>You see something similar to this, confirming that the Task was submitted:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">Task test-app-gd8dv is submitted successfully for execution.
</code></pre><p>The Task name is automatically generated, prefixed with the App name, and
suffixed with an arbitrary string. The Task name is a unique identifier for
Tasks within the same cluster.</p>
<h2 id="specify-task-resource-limits">Specify Task resource limits</h2>
<p>Resource limits (such as CPU cores/Memory limit/Disk quota) can be specified in
the App (during <code>kf push</code>) or during the <code>kf run-task</code> command. The limits
specified in the <code>kf run-task</code> command take prededence over the limits specified
on the App.</p>
<p>To specify resource limits in an App, you can use the <code>--cpu-cores</code>,
<code>--memory-limit</code>, and <code>--disk-quota</code> flags in the <code>kf push</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push test-app --command <span style="color:#4e9a06">&#34;printenv&#34;</span> --cpu-cores<span style="color:#ce5c00;font-weight:bold">=</span>0.5 --memory-limit<span style="color:#ce5c00;font-weight:bold">=</span>2G --disk-quota<span style="color:#ce5c00;font-weight:bold">=</span>5G --task
</span></span></code></pre></div><p>To override these limits in the App, you can use the <code>--cpu-cores</code>,
<code>--memory-limit</code>, and <code>--disk-quota</code> flags in the <code>kf run-task</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf run-task test-app --command <span style="color:#4e9a06">&#34;printenv&#34;</span> --cpu-cores<span style="color:#ce5c00;font-weight:bold">=</span>0.5 --memory-limit<span style="color:#ce5c00;font-weight:bold">=</span>2G --disk-quota<span style="color:#ce5c00;font-weight:bold">=</span>5G
</span></span></code></pre></div><h2 id="specify-a-custom-display-name-for-a-task">Specify a custom display name for a Task</h2>
<p>You can optionally use the <code>--name</code> flag to specify a custom display name for a
Task for easier identification/grouping:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf run-task test-app --command &#34;printenv&#34; --name foo
Task test-app-6swct is submitted successfully for execution.

$ kf tasks test-app
Listing Tasks in Space: test space
Name              ID  DisplayName        Age    Duration  Succeeded  Reason
test-app-6swct    3   foo                1m     21s       True       &lt;nil&gt;
</code></pre><h2 id="manage-tasks">Manage Tasks</h2>
<p>View all Tasks of an App with the <code>kf tasks APP_NAME</code> command:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf tasks test-app
Listing Tasks in Space: test space
Name              ID  DisplayName        Age    Duration  Succeeded  Reason
test-app-gd8dv    1   test-app-gd8dv     1m     21s       True       &lt;nil&gt;
</code></pre><h2 id="cancel-a-task">Cancel a Task</h2>
<p>Cancel an active Task by using the <code>kf terminate-task</code> command:</p>
<ul>
<li>
<p>Cancel a Task by Task name:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf terminate-task test-app-6w6mz
Task &#34;test-app-6w6mz&#34; is successfully submitted for termination
</code></pre></li>
<li>
<p>Or cancel a Task by <code><var>APP_NAME</var></code> + Task ID:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf terminate-task test-app 2
Task &#34;test-app-6w6mz&#34; is successfully submitted for termination
</code></pre></li>
</ul>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> You can only cancel Tasks that are pending/running. Completed Tasks are not cancellable.
</aside>

<p>Cancelled Tasks have <code>PipelineRunCancelled</code> status.</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf tasks test-app
Listing Tasks in Space: test space
Name              ID  DisplayName        Age    Duration  Succeeded  Reason
test-app-gd8dv    1   test-app-gd8dv     1m     21s       True       &lt;nil&gt;
test-app-6w6mz    2   test-app-6w6mz     38s    11s       False      PipelineRunCancelled
</code></pre><h2 id="view-task-logs">View Task logs</h2>
<p>View logs of a Task by using the <code>kf logs APP_NAME --task</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kf logs test-app --task
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-52b92bfa0949442cec57f0a34cd75406">1.2.6.3 - Schedule Tasks</h1>
    <div class="lead">Learn how to schedule tasks to run periodic jobs.</div>
	<p>You can execute short-lived workflows by running them as <a href="/kf/docs/v2.11/developer/tasks/task/">Tasks</a>.
<a href="/kf/docs/v2.11/developer/tasks/run-task/#push_an_app_for_running_tasks">Running Tasks</a>
describes how to run Tasks under Apps.</p>
<p>You can also schedule Tasks to run at recurring intervals
specified using the <a href="https://man7.org/linux/man-pages/man5/crontab.5.html">unix-cron</a> format.
With scheduled Tasks, you first push an App running the Task as you do with an unscheduled Task,
and then create a Job to schedule the Task.</p>
<p>You can define a schedule so that your Task runs multiple times a day or on specific
days and months.</p>
<h2 id="push-an-app-for-running-scheduled-tasks">Push an App for running scheduled Tasks</h2>
<ol>
<li>Clone the <a href="https://github.com/cloudfoundry-samples/test-app">test-app repo</a>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/cloudfoundry-samples/test-app test-app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> test-app
</span></span></code></pre></div><ol>
<li>
<p>Push the App.</p>
<p>Push the App with the <code>kf push APP_NAME --task</code> command. The <code>--task</code> flag indicates that the App is meant to be used for running Tasks, and thus no routes will be created on the App and it will not be deployed as a long-running application.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push test-app --task
</span></span></code></pre></div></li>
<li>
<p>Confirm that no App instances or routes were created by listing the App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf apps
</span></span></code></pre></div><p>Notice that the App is not started and has no URLs:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">Listing Apps in Space: test-space
Name                     Instances  Memory  Disk  CPU   URLs
test-app                 stopped    1Gi     1Gi   100m  &lt;nil&gt;
</code></pre></li>
</ol>
<h2 id="create-a-job">Create a Job</h2>
<p>To run a Task on a schedule, you must first create a Job that describes the Task:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-job test-app test-job <span style="color:#4e9a06">&#34;printenv&#34;</span>
</span></span></code></pre></div><p>The Job starts suspended or unscheduled, and does not create Tasks until it is
manually executed by <code>kf run-job</code> or scheduled by <code>kf schedule-task</code>.</p>
<h3 id="run-a-job-manually">Run a Job manually</h3>
<p>Jobs can be run ad hoc similar to running Tasks by <code>kf run-task</code>. This option
can be useful for testing the Job before scheduling or running as needed in addition
to the schedule.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf run-job test-job
</span></span></code></pre></div><p>This command runs the Task defined by the Job a single time immediately.</p>
<h2 id="schedule-a-job">Schedule a Job</h2>
<p>To schedule the Job for execution, you must provide a unix-cron schedule in the
<code>kf schedule-job</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf schedule-job test-job <span style="color:#4e9a06">&#34;* * * * *&#34;</span>
</span></span></code></pre></div><p>This command triggers the Job to automatically create Tasks on the specified schedule.
In this example a Task runs every minute.</p>
<p>You can update a Job&rsquo;s schedule by running <code>kf schedule-task</code> with a new schedule.
Jobs in Kf can only have a single cron schedule. This differs
from the PCF Scheduler, which allows multiple schedules for a single Job.
If you require multiple cron schedules, then you can achieve that with multiple Jobs.</p>
<h2 id="manage-jobs-and-schedules">Manage Jobs and schedules</h2>
<p>View all Jobs, both scheduled and unscheduled, in the current Space by using
the <code>kf jobs</code> command:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf jobs
Listing Jobs in Space: test space
Name               Schedule    Suspend  LastSchedule  Age  Ready  Reason
test-job           * * * * *   &lt;nil&gt;    16s           2m   True   &lt;nil&gt;
unscheduled-job    0 0 30 2 *  true     16s           2m   True   &lt;nil&gt;
</code></pre>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The <code>unscheduled-job</code> has a default schedule set (<code>0 0 30 2 *</code>).
This schedule is not active because the Job is suspended and is only present as a
placeholder schedule for unscheduled Jobs.
</aside>

<p>Additionally, you can view only Jobs that are actively scheduled with
the <code>kf job-schedules</code> command.</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf job-schedules
Listing job schedules in Space: test space
Name           Schedule   Suspend  LastSchedule  Age  Ready  Reason
test-job       * * * * *  &lt;nil&gt;    16s           2m   True   &lt;nil&gt;
</code></pre><p>Notice how the <code>unscheduled-job</code> is not listed in the <code>kf job-schedules</code> output.</p>
<h3 id="cancel-a-jobs-schedule">Cancel a Job&rsquo;s schedule</h3>
<p>You can stop a scheduled Job with the <code>kf delete-job-schedule</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete-job-schedule test-job
</span></span></code></pre></div><p>This command suspends the Job and stops it from creating Tasks on the previous schedule.
The Job is not deleted and can be scheduled again by <code>kf schedule-job</code> to continue execution.</p>
<h3 id="delete-a-job">Delete a Job</h3>
<p>The entire Job can be deleted with the <code>kf delete-job</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete-job test-job
</span></span></code></pre></div><p>This command deletes the Job and all Tasks that were created by the Job,
both scheduled and manual executions. If any Tasks are still running, this command
forcefully deletes them.</p>
<p>If you want to ensure that running Tasks are not interrupted, then first delete
the Jobs schedule with <code>kf delete-job-schedule</code>, wait for all Tasks to complete,
and then delete the job by calling <code>kf delete-job</code>.</p>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-71a90347dd73976aef782a044da2dda6">1.3 - Operate and Maintain Kf</h1>
    <div class="lead">Learn to run and maintain Kf as a platform.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-676fe26aec89a6298c30c8bde719f98c">1.3.1 - Service brokers</h1>
    <div class="lead">Learn to install and operate backing service marketplaces for Kf.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-57a67dff900071f2cffcad23543f9c9e">1.3.1.1 - Service Brokers Overview</h1>
    
	<p>Kf supports binding and provisioning apps to <a href="https://www.openservicebrokerapi.org/">Open Service Broker (OSB)</a> services.</p>
<p>Any compatible service broker can be installed using the <code>create-service-broker</code> command, but only the <a href="/kf/docs/v2.11/operator/service-brokers/cloud-sb-overview/">Kf Cloud Service Broker</a> is fully supported.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Kf only supports a subset of the types of services
that Open Service Brokers provide. Specifically, it only supports credential
services.
</aside>

<p>Special services such as syslog drains, volume services, route services,
service keys, and shared services aren&rsquo;t currently supported.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9a3de66316708be4c05787cd2dd1aba9">1.3.1.2 - About Kf Cloud Service Broker</h1>
    
	<p>The Kf Cloud Service Broker is a Service Broker bundle that includes the open source
<a href="https://github.com/cloudfoundry-incubator/cloud-service-broker">Cloud Service Broker</a>
and <a href="https://github.com/cloudfoundry-incubator/csb-brokerpak-gcp">Google Cloud Brokerpak</a>.
It is made available as a public Docker image and ready to deploy as a
Kubernetes service in Kf clusters. Once the
Kf Cloud Service Broker service is deployed in a cluster, developers can provision Google Cloud
backing services through the Kf Cloud Service Broker service, and bind the backing services to Kf Apps.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Kf Cloud Service Brokeris not customizable, and the default
Google Cloud Brokerpak is included. If you would like to use a custom
Brokerpak, you can follow the steps in the
<a href="https://github.com/cloudfoundry-incubator/csb-brokerpak-gcp/blob/main/docs/gcp-installation.md">open source Cloud Service Broker Google Cloud installation guide</a>.
</aside>

<h2 id="requirements">Requirements</h2>
<ul>
<li>Kf Cloud Service Broker requires a MySQL instance and a service account for accessing the MySQL instance and Google Cloud backing services to be provisioned. Connection from the Kf Cloud Service Broker to the MySQL instance goes through the <a href="https://cloud.google.com/sql/docs/mysql/sql-proxy">Cloud SQL Auth Proxy</a>.</li>
<li>Requests to access Google Cloud services (for example: Cloud SQL for MySQL or Cloud Memorystore for Redis) are authenticated via <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a>.</li>
</ul>
<h2 id="override-brokerpak-defaults">Override Brokerpak defaults</h2>
<p>Brokerpaks are essentially a Terraform plan and related dependencies in a tar
file. You can inspect the Terraform plans to see what the defaults are, and then
you can tell Kf Cloud Service Broker to override them when creating new services.</p>
<p>For example, the <a href="https://github.com/cloudfoundry-incubator/csb-brokerpak-gcp/blob/main/terraform/cloud-sql-provision.tf">Terraform plan for MySQL</a> includes a variable called <code>authorized_network</code>. If not overridden, the <code>default</code> VPC will be used. If you&rsquo;d like to override the default, you can pass that during service creation. Here are some examples:</p>
<ol>
<li>Override the compute region <code>config</code>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> kf create-service csb-google-postgres small spring-music-postgres-db -c <span style="color:#4e9a06">&#39;{&#34;config&#34;:&#34;YOUR_COMPUTE_REGION&#34;}&#39;</span>
</span></span></code></pre></div><ol>
<li>Override the <code>authorized_network</code> and compute region <code>config</code>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> kf create-service csb-google-postgres small spring-music-postgres-db -c <span style="color:#4e9a06">&#39;{&#34;config&#34;:&#34;YOUR_COMPUTE_REGION&#34;,&#34;authorized_network&#34;:&#34;YOUR_CUSTOM_VPC_NAME&#34;}&#39;</span>
</span></span></code></pre></div><p>You can learn more by reading the <a href="https://github.com/cloudfoundry-incubator/csb-brokerpak-gcp/blob/main/docs/mysql-plans-and-config.md">MySQL Plans and Configs</a> documentation.</p>
<h2 id="architecture">Architecture</h2>
<p>The following Kf Cloud Service Broker architecture shows how instances are created.</p>

<figure>
    <img src="./kf-csb-architecture.svg"
         alt="Kf Cloud Service Broker architecture"/> 
</figure>

<ul>
<li>The Kf Cloud Service Broker (CSB) is installed in its own namespace.</li>
<li>On installation, a MySQL instance must be provided to persist
business logic used by Kf Cloud Service Broker. Requests are sent securely
from the Kf Cloud Service Broker pod to the MySQL instance via
the MySQL Auth Proxy.</li>
<li>On service provisioning, a Kf Service custom resource
is created. The reconciler of the Kf Service
provisions Google Cloud backing services using the Open Service Broker API.</li>
<li>When a request to provision/deprovision backing resources is received,
Kf Cloud Service Broker sends resource creation/deletion requests to the
corresponding Google Cloud service, and these requests are authenticated
with Workload Identity. It also persists the business logics (e.g. mapping of
Kf services to backing services, service bindings) to
the MySQL instance.</li>
<li>On backing service creation success, the backing service is bound to an App
via <a href="/kf/docs/v2.11/developer/build-and-deploy/app-runtime/#vcapservices">VCAP_SERVICES</a>.</li>
</ul>
<h2 id="whats-next">What&rsquo;s next?</h2>
<ul>
<li><a href="/kf/docs/v2.11/operator/service-brokers/deploying-cloud-sb/">Deploy Kf Cloud Service Broker</a>.</li>
<li><a href="/kf/docs/v2.11/developer/backing-services/managed-services/">Learn how to list and provision services</a>.</li>
</ul>
<p>{% endblock %}</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5446c3e6e9dd77ccf2bb6d4380fbad8c">1.3.1.3 - Deploy Kf Cloud Service Broker</h1>
    
	<p>This page shows you how to deploy Kf Cloud Service Broker and use it to provision or deprovision backing resources.
Read about the <a href="/kf/docs/v2.11/operator/service-brokers/cloud-sb-overview/">concepts and architecture</a> to learn more about the Kf Cloud Service Broker.</p>
<h2 id="create_env_variables">Create environment variables</h2>
<ul>
<li>
<p><strong>Linux</strong></p>
<pre class="devsite-click-to-copy" translate="no">
export PROJECT_ID=<var>YOUR_PROJECT_ID</var>
export CLUSTER_PROJECT_ID=<var>YOUR_PROJECT_ID</var>
export CLUSTER_NAME=<var>kf-cluster</var>
export INSTANCE_NAME=<var>cloud-service-broker</var>
export COMPUTE_REGION=<var>us-central1</var>
</pre>
</li>
<li>
<p><strong>Windows PowerShell</strong></p>
<pre class="devsite-click-to-copy" translate="no">
Set-Variable -Name PROJECT_ID -Value <var>YOUR_PROJECT_ID</var>
Set-Variable -Name CLUSTER_PROJECT_ID -Value <var>YOUR_PROJECT_ID</var>
Set-Variable -Name CLUSTER_NAME -Value <var>kf-cluster</var>
Set-Variable -Name INSTANCE_NAME -Value <var>cloud-service-broker</var>
Set-Variable -Name COMPUTE_REGION -Value <var>us-central1</var>
</pre>
</li>
</ul>
<h2 id="set-up-the-kf-cloud-service-broker-database">Set up the Kf Cloud Service Broker database</h2>
<ol>
<li>
<p>Create a MySQL instance.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> <pre><code>Read [Creating and managing MySQL users](https://cloud.google.com/sql/docs/mysql/create-manage-users) for Google Cloud SQL and set a secure password for the default `root` user.
</code></pre>

</aside>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gcloud sql instances create <span style="color:#4e9a06">${</span><span style="color:#000">INSTANCE_NAME</span><span style="color:#4e9a06">}</span> --cpu<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> --memory<span style="color:#ce5c00;font-weight:bold">=</span>7680MB --require-ssl --region<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">COMPUTE_REGION</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div></li>
<li>
<p>Create a database named <code>servicebroker</code> in the MySQL instance.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Document the database name since it is used in later steps.
</aside>

<pre class="devsite-click-to-copy" translate="no">
gcloud sql databases create servicebroker -i ${INSTANCE_NAME}</pre>
</li>
<li>
<p>Create a username and password to be used by the broker.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Document these values since they will be used in later steps.
</aside>

<pre class="devsite-click-to-copy" translate="no">
gcloud sql users create <var>csbuser</var> -i ${INSTANCE_NAME} --password=<var>csbpassword</var></pre>
</li>
</ol>
<h2 id="set-up-a-google-service-account-for-the-broker">Set up a Google Service Account for the broker</h2>
<ol>
<li>Create a Google Service Account.</li>
</ol>
  <pre class="devsite-click-to-copy" translate="no">
  gcloud iam service-accounts create csb-${CLUSTER_NAME}-sa \
      --project=${CLUSTER_PROJECT_ID} \
      --description="GSA for CSB at ${CLUSTER_NAME}" \
      --display-name="csb-${CLUSTER_NAME}"</pre>
<ol>
<li>Grant <code>roles/cloudsql.client</code> permissions to the Service Account. This is required to connect the service broker pod to the CloudSQL for MySQL instance through the CloudSQL Proxy.</li>
</ol>
  <pre class="devsite-click-to-copy" translate="no">
  gcloud projects add-iam-policy-binding ${CLUSTER_PROJECT_ID} \
      --member="serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/cloudsql.client"</pre>
<ol>
<li>Grant additional Google Cloud permissions to the Service Account.</li>
</ol>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> In the example below, we grant IAM roles required to provision an instance of CloudSQL and Cloud Memorystore.
You must grant this service account the appropriate roles to provision instances of other Google Cloud managed services listed in <code>kf marketplace</code>.
</aside>

  <pre class="devsite-click-to-copy" translate="no">
  gcloud projects add-iam-policy-binding ${CLUSTER_PROJECT_ID} \
      --member="serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/compute.networkUser"</pre>
  <pre class="devsite-click-to-copy" translate="no">
  gcloud projects add-iam-policy-binding ${CLUSTER_PROJECT_ID} \
      --member="serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/cloudsql.admin"</pre>
  <pre class="devsite-click-to-copy" translate="no">
  gcloud projects add-iam-policy-binding ${CLUSTER_PROJECT_ID} \
      --member="serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/redis.admin"</pre>
<ol>
<li>Verify the permissions.</li>
</ol>

<aside class="alert alert-danger" style="border-width: 1px 1px 1px 4px;">
<i class="fa-solid fa-triangle-exclamation"></i> <strong>Warning:</strong> Replace the <code>CSB_SERVICE_ACCOUNT_NAME</code> variable in the YAML below with the full service account resolved from <code>csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com</code>.
</aside>


  <pre class="devsite-click-to-copy" translate="no">
  gcloud projects get-iam-policy ${CLUSTER_PROJECT_ID} \
      --filter='bindings.members:serviceAccount:"<var>CSB_SERVICE_ACCOUNT_NAME</var>"' \
      --flatten="bindings[].members"</pre>
<h2 id="set-up-workload-identity-for-the-broker">Set up Workload Identity for the broker</h2>
<ol>
<li>Bind the Google Service Account with the Kubernetes Service Account.</li>
</ol>
  <pre class="devsite-click-to-copy" translate="no">
  gcloud iam service-accounts add-iam-policy-binding "csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com" \
      --project=${CLUSTER_PROJECT_ID} \
      --role="roles/iam.workloadIdentityUser" \
      --member="serviceAccount:${CLUSTER_PROJECT_ID}.svc.id.goog[kf-csb/csb-user]"</pre>
<ol>
<li>Verify the binding.</li>
</ol>
  <pre class="devsite-click-to-copy" translate="no">
  gcloud iam service-accounts get-iam-policy "csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com" \
      --project=${CLUSTER_PROJECT_ID}</pre>
<h2 id="kubernetes_secret">Set up a Kubernetes Secret to share configuration with the broker</h2>
<ol>
<li>Create a config.yml file.</li>
</ol>
<p>Note: Replace the default user/password if desired. Ensure you have set the <code>CLUSTER_PROJECT_ID</code> in the <a href="#create_env_variables">Create environment variables</a> step.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt; EOF &gt;&gt; ./config.yml
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">gcp:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  credentials: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  project: ${CLUSTER_PROJECT_ID}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">db:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  host: 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  password: csbpassword
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  user: csbuser
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">api:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  user: servicebroker
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  password: password
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><ol>
<li>Create the <code>kf-csb</code> namespace.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl create ns kf-csb
</span></span></code></pre></div><ol>
<li>Create the Kubernetes Secret.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl create secret generic csb-secret --from-file<span style="color:#ce5c00;font-weight:bold">=</span>config.yml -n kf-csb
</span></span></code></pre></div><h2 id="install-the-kf-cloud-service-broker">Install the Kf Cloud Service Broker</h2>
<ol>
<li>Download the <code>kf-csb.yml</code>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gsutil cp gs://kf-releases/csb/v<span style="color:#ce5c00;font-weight:bold">{{</span>this_kf_csb_version<span style="color:#ce5c00;font-weight:bold">}}</span>/kf-csb.yaml /tmp/kf-csb.yaml
</span></span></code></pre></div><ol>
<li>Edit <code>/tmp/kf-csb.yaml</code> and replace placeholders with final values. In the example below, <code>sed</code> is used.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#34;s|&lt;GSA_NAME&gt;|csb-</span><span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">-sa@</span><span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_PROJECT_ID</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">.iam.gserviceaccount.com|g&#34;</span> /tmp/kf-csb.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#34;s|&lt;INSTANCE_CONNECTION_NAME&gt;|</span><span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_PROJECT_ID</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">COMPUTE_REGION</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">INSTANCE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">|g&#34;</span> /tmp/kf-csb.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#34;s|&lt;DB_PORT&gt;|3306|g&#34;</span> /tmp/kf-csb.yaml
</span></span></code></pre></div><ol>
<li>Apply yaml for Kf Cloud Service Broker.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl apply -f /tmp/kf-csb.yaml
</span></span></code></pre></div><ol>
<li>Verify the Cloud Service Broker installation status.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl get pods -n kf-csb
</span></span></code></pre></div><h2 id="create-a-service-broker">Create a service broker</h2>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The user/password must match what you entered in the <a href="#kubernetes_secret">Kubernetes secret</a> step earlier.
</aside>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-service-broker cloud-service-broker servicebroker password http://csb-controller.kf-csb/
</span></span></code></pre></div><h2 id="validate-installation">Validate installation</h2>
<p>Check for available services in the marketplace.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf marketplace
</span></span></code></pre></div><p>If everything is installed and configured correctly, you should see the following:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf marketplace

Broker                Name                          Namespace  Description
cloud-service-broker  csb-google-bigquery                      A fast, economical and fully managed data warehouse for large-scale data analytics.
cloud-service-broker  csb-google-dataproc                      Dataproc is a fully-managed service for running Apache Spark and Apache Hadoop clusters in a simpler, more cost-efficient way.
cloud-service-broker  csb-google-mysql                         Mysql is a fully managed service for the Google Cloud Platform.
cloud-service-broker  csb-google-postgres                      PostgreSQL is a fully managed service for the Google Cloud Platform.
cloud-service-broker  csb-google-redis                         Cloud Memorystore for Redis is a fully managed Redis service for the Google Cloud Platform.
cloud-service-broker  csb-google-spanner                       Fully managed, scalable, relational database service for regional and global application data.
cloud-service-broker  csb-google-stackdriver-trace             Distributed tracing service
cloud-service-broker  csb-google-storage-bucket                Google Cloud Storage that uses the Terraform back-end and grants service accounts IAM permissions directly on the bucket.
</code></pre><h2 id="clean-up">Clean up</h2>
<ol>
<li>Delete cloud-service-broker.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete-service-broker cloud-service-broker
</span></span></code></pre></div><ol>
<li>Delete CSB components.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl delete ns kf-csb
</span></span></code></pre></div><ol>
<li>
<p>Delete the broker&rsquo;s database instance.</p>
 <pre class="devsite-click-to-copy" translate="no">
 gcloud sql instances delete ${INSTANCE_NAME} --project=${CLUSTER_PROJECT_ID}</pre>
</li>
<li>
<p>Remove the IAM policy bindings.</p>
 <pre class="devsite-click-to-copy" translate="no">
 gcloud projects remove-iam-policy-binding ${CLUSTER_PROJECT_ID} \
 --member='serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com' \
 --role=roles/cloudsql.client</pre>
 <pre class="devsite-click-to-copy" translate="no">
 gcloud projects remove-iam-policy-binding ${CLUSTER_PROJECT_ID} \
 --member='serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com' \
 --role=roles/compute.networkUser</pre>
 <pre class="devsite-click-to-copy" translate="no">
 gcloud projects remove-iam-policy-binding ${CLUSTER_PROJECT_ID} \
 --member='serviceAccount:csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com' \
 --role=roles/redis.admin</pre>
</li>
<li>
<p>Remove the GSA.</p>
 <pre class="devsite-click-to-copy" translate="no">
 gcloud iam service-accounts delete csb-${CLUSTER_NAME}-sa@${CLUSTER_PROJECT_ID}.iam.gserviceaccount.com \
   --project=${CLUSTER_PROJECT_ID}</pre>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0ed1f2553ce17ae3693a557beaea071d">1.3.1.4 - Set up NFS platform</h1>
    
	<p>Kf supports Kubernetes native NFS, and exposes them with a dedicated <code>nfsvolumebroker</code> service broker for developers to consume. This broker has an <code>nfs</code> service offering which has a service plan named <code>existing</code>.</p>
<p>Use <code>kf marketplace</code> to see the service offering:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf marketplace
...
Broker           Name  Namespace  Description
nfsvolumebroker  nfs              mout nfs shares
...
</code></pre><p>Use <code>kf marketplace -s nfs</code> to see the service plan:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kf marketplace -s nfs
...
Broker           Name      Free  Description
nfsvolumebroker  existing  true  mount existing nfs server
...
</code></pre><h2 id="requirements">Requirements</h2>
<p>You need an NFS volume that can be accessed by your Kubernetes cluster. For example <a href="https://cloud.google.com/filestore">Cloud Filestore</a> which Google&rsquo;s managed NFS solution that provides access to clusters in the same gcloud project.</p>
<h2 id="prepare-nfs">Prepare NFS</h2>
<p>If you have an existing NFS service, you can use that. If you want a Google managed NFS service, <a href="https://cloud.google.com/filestore/docs/creating-instances">create a Filestore instance</a> and Kf will automaticlaly configure the cluster to use it.</p>
<p>Warning: You only need to create the NFS instance. Kf will create relevant Kubernetes objects, including PersistentVolume and PersistentVolumeClaims. Do not manually mount the volume.</p>
<h2 id="whats-next">What&rsquo;s next?</h2>
<ul>
<li><a href="/kf/docs/v2.11/developer/backing-services/nfs-getting-started/">Configure NFS volumes</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-eb59913b8a37858863152c1befc303fb">1.3.2 - Customizing Kf</h1>
    <div class="lead">Learn about how to configure cluster-wide settings.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b156f3a85a418456ea8aeb7c077af36d">1.3.2.1 - Customizing Overview</h1>
    <div class="lead">Learn about how Kf uses configuration.</div>
	<p>Kf supports customizing some cluster wide configurations by manipulating the <code>kfsystem</code> custom rsource.</p>

<aside class="alert alert-danger" style="border-width: 1px 1px 1px 4px;">
<i class="fa-solid fa-triangle-exclamation"></i> <strong>Warning:</strong> Changes will be instantly pushed to all Kf resources, test any customization options before using them in production.
</aside>



</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2de7bc87b8e461d33fe1259e2cf92256">1.3.2.2 - Cluster Configuration</h1>
    <div class="lead">Learn to configure your Kf cluster&rsquo;s settings.</div>
	
<aside class="alert alert-danger" style="border-width: 1px 1px 1px 4px;">
<i class="fa-solid fa-triangle-exclamation"></i> <strong>Warning:</strong> Changes will be instantly pushed to all Kf resources, test any customization options before using them in production.
</aside>


<p>Kf uses a Kubernetes configmap named <code>config-defaults</code> in
the <code>kf</code> namespace to store cluster wide configuration settings.
This document explains its structure and fields.</p>
<h2 id="structure-of-the-config-defaults-configmap">Structure of the config-defaults configmap</h2>
<p>The configmap contains three types of key/value pairs in the <code>.data</code> field:</p>
<ul>
<li>Comment keys prefixed by <code>_</code> contain examples, notes, and warnings.</li>
<li>String keys contain plain text values.</li>
<li>Object keys contain a JSON or YAML value that has been encoded as a string.</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">_note</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;This is some note&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">stringKey</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;This is a string key that&#39;s not encoded as JSON or YAML.&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">objectKey</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - &#34;These keys contain nested YAML or JSON.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - 123.45</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span></code></pre></div>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Kubernetes requires all configmap values to be strings.
Kf validates the structure of the fields before the
object is updated.
</aside>

<h2 id="example-section">Example section</h2>
<p>The example section under the <code>_example</code> key contains explanations for other
fields and examples. Changes to this section have no effect.</p>
<h2 id="space-container-registry">Space container registry</h2>
<p>The <code>spaceContainerRegistry</code> property is a plain text value that specifies the
default container registry each space uses to store built images.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spaceContainerRegistry</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcr.io/my-project</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="space-cluster-domains">Space cluster domains</h2>
<p>The <code>spaceClusterDomains</code> property is a string encoded YAML array of domain objects.</p>
<p>Each space in the cluster adds all items in the array to its list of
domains that developers can bind their apps to.</p>
<table class="properties responsive">
  <thead>
    <tr>
      <th colspan="2">Fields</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>domain</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>The domain name to make available. May contain one of the following substitutions:</p>
        <ul>
          <li><code>$(SPACE_NAME)</code> - Replaced in each space with the name of the space.</li>
          <li><code>$(CLUSTER_INGRESS_IP)</code> - The IP address of the cluster ingress gateway.</li>
        </ul>
      </td>
    </tr>
    <tr>
      <td><code>gatewayName</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>(Optional)</p>
        <p>
          Overrides the Istio gateway routes will be bound to.
          Defaults to <code>kf/external-gateway</code>, but any
          other gateway in the <code>kf</code> namespace may be used.
        </p>
      </td>
    </tr>
  </tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> All domains should contain the <code>$(SPACE_NAME)</code> substitution to prevent
Apps in different namespaces from listening to the same hostname which causes
undefined behavior.
</aside>

<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spaceClusterDomains</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  # Support canonical and vanity domains
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - domain: $(SPACE_NAME).prod.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - domain: $(SPACE_NAME).kf.us-east1.prod.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  # Using a dynamic DNS resolver
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - domain: $(SPACE_NAME).$(CLUSTER_INGRESS_IP).nip.io
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  # Creating an internal domain only visible within the cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - domain: $(SPACE_NAME)-apps.internal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    gatewayName: kf/internal-gateway</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span></code></pre></div><h2 id="buildpacks-v2-lifecycle-builder">Buildpacks V2 lifecycle builder</h2>
<p>The <code>buildpacksV2LifecycleBuilder</code> property contains the version of the Cloud Foundry
<code>builder</code> binary used execute buildpack v2 builds.</p>
<p>The value is a Git reference. To use a specific version, append an <code>@</code> symbol
followed by a Git SHA to the end.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">buildpacksV2LifecycleBuilder</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;code.cloudfoundry.org/buildpackapplifecycle/builder@GIT_SHA&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="buildpacks-v2-lifecycle-launcher">Buildpacks V2 lifecycle launcher</h2>
<p>The <code>buildpacksV2LifecycleLauncher</code> property contains the version of the Cloud Foundry
<code>launcher</code> binary built into every buildpack V2 application.</p>
<p>The value is a Git reference. To use a specific version, append an <code>@</code> symbol
followed by a Git SHA to the end.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">buildpacksV2LifecycleLauncher</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;code.cloudfoundry.org/buildpackapplifecycle/launcher@GIT_SHA&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="buildpacks-v2-list">Buildpacks V2 list</h2>
<p>The <code>spaceBuildpacksV2</code> property is a string encoded YAML array that holds an ordered
list of default buildpacks that are used to build applications compatible with
the V2 buildpacks process.</p>
<table class="properties responsive">
  <thead>
    <tr>
      <th colspan="2">Fields</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>name</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>A short name developers can use to reference the buildpack by in their application manifests.</p>
      </td>
    </tr>
    <tr>
      <td><code>url</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>The URL used to fetch the buildpack.</p>
      </td>
    </tr>
    <tr>
      <td><code>disabled</code></td>
      <td>
        <p><code class="apitype">boolean</code></p>
        <p>Used to prevent this buildpack from executing.</p>
      </td>
    </tr>
  </tbody>
</table>
<h2 id="stacks-v2-list">Stacks V2 list</h2>
<p>The <code>spaceBuildpacksV2</code> property is a string encoded YAML array that holds an
ordered list of stacks that can be used with Cloud Foundry compatible builds.</p>
<table class="properties responsive">
  <thead>
    <tr>
      <th colspan="2">Fields</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>name</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>A short name developers can use to reference the stack by in their application manifests.</p>
      </td>
    </tr>
    <tr>
      <td><code>image</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>
          URL of the container image to use as the stack.
          For more information, see <a href="https://kubernetes.io/docs/concepts/containers/images">https://kubernetes.io/docs/concepts/containers/images</a>.
        </p>
      </td>
    </tr>
  </tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Use images tagged with SHAs to improve caching.
</aside>

<h2 id="stacks-v3-list">Stacks V3 list</h2>
<p>The <code>spaceStacksV3</code> property is a string encoded YAML array that holds an ordered
list of stacks that can be used with
<a href="https://buildpacks.io/">Cloud Native Buildpack</a>
builds.</p>
<table class="properties responsive">
  <thead>
    <tr>
      <th colspan="2">Fields</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>name</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>A short name developers can use to reference the stack by in their application manifests.</p>
      </td>
    </tr>
    <tr>
      <td><code>description</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>A short description of the stack shown when running <code>kf stacks</code>.</p>
      </td>
    </tr>
    <tr>
      <td><code>buildImage</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>
          URL of the container image to use as the builder.
          For more information, see <a href="https://kubernetes.io/docs/concepts/containers/images">https://kubernetes.io/docs/concepts/containers/images</a>.
        </p>
      </td>
    </tr>
    <tr>
      <td><code>runImage</code></td>
      <td>
        <p><code class="apitype">string</code></p>
        <p>
          URL of the container image to use as the base for all apps built with .
          For more information, see <a href="https://kubernetes.io/docs/concepts/containers/images">https://kubernetes.io/docs/concepts/containers/images</a>.
        </p>
      </td>
    </tr>
    <tr>
      <td><code>nodeSelector</code></td>
      <td>
        <p><code class="apitype">map (key: string, value: string)</code></p>
        <p>(Optional)</p>
        <p>
          A NodeSelector used to indicate which nodes applications built with
          this stack can run on.
        </p>
      </td>
    </tr>
  </tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Use images tagged with SHAs to improve caching.
</aside>

<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spaceStacksV3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  - name: heroku-18
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    description: The official Heroku stack based on Ubuntu 18.04
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    buildImage: heroku/pack:18-build
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    runImage: heroku/pack:18
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    nodeSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">       kubernetes.io/os: windows</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span></code></pre></div><h2 id="default-to-v3-stack">Default to V3 Stack</h2>
<p>The <code>spaceDefaultToV3Stack</code> property contains a quoted value <code>true</code> or <code>false</code>
indicating whether spaces should use V3 stacks if a user doesn&rsquo;t specify one.</p>
<h2 id="feature-flags">Feature flags</h2>
<p>The <code>featureFlags</code> property contains a string encoded YAML map of feature flags
that can enable and disable features of Kf.</p>
<p>Flag names that aren&rsquo;t supported by Kf will be ignored.</p>
<table>
<thead>
<tr>
<th>Flag Name</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>disable_custom_builds</code></td>
<td><code>false</code></td>
<td>Disable developer access to arbitrary Tekton build pipelines.</td>
</tr>
<tr>
<td><code>enable_dockerfile_builds</code></td>
<td><code>true</code></td>
<td>Allow developers to build source code from dockerfiles.</td>
</tr>
<tr>
<td><code>enable_custom_buildpacks</code></td>
<td><code>true</code></td>
<td>Allow developers to specify external buildpacks in their applications.</td>
</tr>
<tr>
<td><code>enable_custom_stacks</code></td>
<td><code>true</code></td>
<td>Allow developers to specify custom stacks in their applications.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">featureFlags</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  disable_custom_builds: false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  enable_dockerfile_builds: true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  enable_some_feature: true</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c86bc86c018c6665f7e1bad06988b6f">1.3.2.3 - Customizing Kf Features</h1>
    <div class="lead">Learn to configure your Kf cluster&rsquo;s settings.</div>
	
<aside class="alert alert-danger" style="border-width: 1px 1px 1px 4px;">
<i class="fa-solid fa-triangle-exclamation"></i> <strong>Warning:</strong> Changes will be instantly pushed to all Kf resources, test any customization options before using them in production.
</aside>


<h2 id="build-retention">Build Retention</h2>
<p>You can control how many Kf Builds are kept before being garbage collected.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> This example sets the retention to 1 Build. Change the value as needed.
</aside>

<pre class="devsite-terminal devsite-click-to-copy" translate="no">
kubectl patch \
kfsystem kfsystem \
--type='json' \
-p="[{'op': 'replace', 'path': '/spec/kf/config/buildRetentionCount', 'value': <var>1</var>}]"
</pre>
<h2 id="enable-or-disable-the-istio-sidecar">Enable or Disable the Istio Sidecar</h2>
<p>If you do not require the Istio sidecar for the Build pods, then they can be disabled by setting the value to <code>true</code>. Enable by setting the value to <code>false</code>.</p>
<pre class="devsite-terminal devsite-click-to-copy" translate="no">
kubectl patch \
kfsystem kfsystem \
--type='json' \
-p="[{'op': 'replace', 'path': '/spec/kf/config/buildDisableIstioSidecar', 'value': <var>true</var>}]"
</pre>
<h2 id="build-pod-resource-limits">Build Pod Resource Limits</h2>
<p>The default pod resource size can be increased from the default to accommodate very large builds. The units for the value are in <code>Mi</code> or <code>Gi</code>.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> This is only applicable for built-in Tasks (which is normal for a <code>kf push</code> build). For V2 buildpack builds, this will be set on two steps and one for V3 buildpacks or Dockerfiles. This means that for a V2 build the required Pod size will be double the limit. For example, if the memory limit is 1Gi, then the pod will require 2Gi.
</aside>

<pre class="devsite-terminal devsite-click-to-copy" translate="no">
kubectl patch \
kfsystem kfsystem \
--type='json' \
-p="[{'op': 'replace', 'path': '/spec/kf/config/buildPodResources', 'value': {'limits': {'memory': '<var>234Mi</var>'}}}]"
</pre>
<p>Read <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Kubernetes container resource docs</a>  for more information about container resource management.</p>
<h2 id="self-signed-certificates-for-service-brokers">Self Signed Certificates for Service Brokers</h2>
<p>If you want to use self signed certificates for TLS (<code>https</code> instead of <code>http</code>) for the service broker URL, the Kf controller requires the CA certificate. To configure Kf for this scenario, create an immutable Kubernetes secret in the <code>kf</code> namespace and update the <code>kfsystem.spec.kf.config.secrets.controllerCACerts.name</code> object to point to it.</p>
<ol>
<li>
<p>Create a secret to store the self-signed certificate.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Customize the secret name if desired, or leave the default name of <code>cacerts</code>. Replace <code>/path/to/cert/certs.pem</code> with the path to the self-signed certificate.
</aside>

 <pre class="devsite-terminal devsite-click-to-copy" translate="no">
 kubectl create secret generic <var>cacerts</var> -nkf --from-file <var>/path/to/cert/certs.pem</var>
 </pre>
</li>
<li>
<p>Make the secret immutable.</p>
 <pre class="devsite-terminal devsite-click-to-copy" translate="no">
 kubectl patch -nkf secret <var>cacerts</var> \
     --type='json' \
     -p="[{'op':'add','path':'/immutable','value':true}]"
 </pre>
</li>
<li>
<p>Update kfsystem to point to the secret.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> This will cause the controller pod to be re-deployed with the certs mounted as a volume.
</aside>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl patch <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  kfsystem kfsystem <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;json&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -p<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;[{&#39;op&#39;:&#39;add&#39;,&#39;path&#39;:&#39;/spec/kf/config/secrets&#39;,&#39;value&#39;:{&#39;controllerCACerts&#39;:{&#39;name&#39;:&#39;&lt;var&gt;cacerts&lt;/var&gt;&#39;}}}]&#34;</span>
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ee9aef4d5863cf3b7971485e6a86039f">1.3.3 - Kf dependencies and architecture</h1>
    
	<p>Kf requires Kubernetes and several other OSS projects to
run. Some of the dependencies are satisfied with Google-managed services—for
example, GKE provides Kubernetes.</p>
<h2 id="dependencies">Dependencies</h2>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/release-notes">GKE</a></li>
<li><a href="https://cloud.google.com/service-mesh/docs">Anthos Service Mesh</a></li>
<li><a href="https://github.com/tektoncd/pipeline">Tekton Pipelines</a></li>
</ul>

<figure>
    <img src="./kf-components-diagram.svg"
         alt="Diagram showing how Kf components interact."/> 
</figure>

<h2 id="get-crd-details">Get CRD details</h2>
<p>Kf supports the <code>kubectl</code>  subcommand <code>explain</code>. It allows you to list the fields in Kf CRDs to understand how to create Kf objects via automation instead of manually via the CLI. This command is designed to be used with <a href="https://github.com/GoogleContainerTools/kpt-config-sync">ConfigSync</a> to automate creation and management of resources like Spaces across many clusters. You can use this against any of the <a href="#components">component <code>kinds</code> below</a>.</p>
<p>In this example, we examine the <code>kind</code> called <code>space</code> in the <code>spaces</code> CRD:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl explain space.spec
</span></span></code></pre></div><p>The output looks similar to this:</p>
<pre tabindex="0"><code>$ kubectl explain space.spec
KIND:     Space
VERSION:  kf.dev/v1alpha1

RESOURCE: spec &lt;Object&gt;

DESCRIPTION:
     SpaceSpec contains the specification for a space.

FIELDS:
   buildConfig  &lt;Object&gt;
     BuildConfig contains config for the build pipelines.

   networkConfig        &lt;Object&gt;
     NetworkConfig contains settings for the space&#39;s networking environment.

   runtimeConfig        &lt;Object&gt;
     RuntimeConfig contains settings for the app runtime environment.
</code></pre><h2 id="components">Kf components</h2>
<p>Kf installs several of its own Kubernetes
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resources</a>
and <a href="https://kubernetes.io/docs/concepts/workloads/controllers/">controllers</a>.
The custom resources effectively serve as the Kf API and
are used by the <code>kf</code> CLI to interact with the system. The controllers use
Kf&rsquo;s CRDs to orchestrate the other components in the
system.</p>
<p>You can view the CRDs installed and used by Kf by running
the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl api-resources --api-group<span style="color:#ce5c00;font-weight:bold">=</span>kf.dev
</span></span></code></pre></div><p>The output of that command is as follows:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">NAME                      SHORTNAMES   APIGROUP   NAMESPACED   KIND
apps                                   kf.dev     true         App
builds                                 kf.dev     true         Build
clusterservicebrokers                  kf.dev     false        ClusterServiceBroker
routes                                 kf.dev     true         Route
servicebrokers                         kf.dev     true         ServiceBroker
serviceinstancebindings                kf.dev     true         ServiceInstanceBinding
serviceinstances                       kf.dev     true         ServiceInstance
spaces                                 kf.dev     false        Space
</code></pre><h3 id="apps">Apps</h3>
<p>Apps represent a <a href="https://12factor.net/">twelve-factor application</a>
deployed to Kubernetes. They encompass source code, configuration, and the
current state of the application. Apps are responsible for reconciling:</p>
<ul>
<li>Kf Builds</li>
<li>Kf Routes</li>
<li>Kubernetes Deployments</li>
<li>Kubernetes Services</li>
<li>Kubernetes ServiceAccounts</li>
<li>Kubernetes Secrets</li>
</ul>
<p>You can list Apps using Kf or <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf apps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get apps -n space-name
</span></span></code></pre></div><h3 id="builds">Builds</h3>
<p>Builds combine the source code and build configuration for Apps. They provision
Tekton TaskRuns with the correct steps to actuate a Buildpack V2, Buildpack V3,
or Dockerfile build.</p>
<p>You can list Builds using Kf or <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf builds
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get builds -n space-name
</span></span></code></pre></div><h3 id="clusterservicebrokers">ClusterServiceBrokers</h3>
<p>ClusterServiceBrokers hold the connection information necessary to extend
Kf with a service broker. They are responsible for
fetching the catalog of services the broker provides and displaying them in
the output of <code>kf marketplace</code>.</p>
<p>You can list ClusterServiceBrokers using <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl get clusterservicebrokers
</span></span></code></pre></div><h3 id="routes">Routes</h3>
<p>Routes are a high level structure that contain HTTP routing rules. They are
responsible for reconciling Istio VirtualServices.</p>
<p>You can list Routes using Kf or <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf routes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get routes -n space-name
</span></span></code></pre></div><h3 id="servicebrokers">ServiceBrokers</h3>
<p>ServiceBrokers hold the connection information necessary to extend
Kf with a service broker. They are responsible for
fetching the catalog of services the broker provides and displaying them in
the output of <code>kf marketplace</code>.</p>
<p>You can list ServiceBrokers using <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl get servicebrokers -n space-name
</span></span></code></pre></div><h3 id="serviceinstancebinding">ServiceInstanceBinding</h3>
<p>ServiceInstanceBindings hold the parameters to create a binding on a service
broker and the credentials the broker returns for the binding. They are
responsible for calling the bind API on the broker to bind the service.</p>
<p>You can list ServiceInstanceBindings using Kf or <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf bindings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get serviceinstancebindings -n space-name
</span></span></code></pre></div><h3 id="serviceinstance">ServiceInstance</h3>
<p>ServiceInstances hold the parameters to create a service on a service broker.
They are responsible for calling the provision API on the broker to create the
service.</p>
<p>You can list ServiceInstances using Kf or <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf services
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get serviceinstances -n space-name
</span></span></code></pre></div><h3 id="spaces">Spaces</h3>
<p>Spaces hold configuration information similar to Cloud Foundry organizations and
spaces. They are responsible for:</p>
<ul>
<li>Creating the Kubernetes Namespace that other Kf resources are provisioned into.</li>
<li>Creating Kubernetes NetworkPolicies to enforce network connection policies.</li>
<li>Holding configuration and policy for Builds, Apps, and Routes.</li>
</ul>
<p>You can list Spaces using Kf or <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf spaces
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get spaces
</span></span></code></pre></div><h2 id="kf-rbac--permissions">Kf RBAC / Permissions</h2>
<p>The following sections list permissions for Kf and its
components to have correct access at the cluster level.
These permissions are required and enabled by default in Kf; do
not attempt to disable them.</p>
<table>
  <thead>
  <tr>
  <th><strong>Components</strong></th>
  <th><strong>Namespace</strong></th>
  <th><strong>Service Account</strong></th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><code>controller</code></td>
  <td>kf</td>
  <td>controller</td>
  <tr>
  <td><code>subresource-apiserver</code></td>
  <td>kf</td>
  <td>controller</td>
  </tr>
  <tr>
  <td><code>webhook</code></td>
  <td>kf</td>
  <td>controller</td>
  </tr>
  <tr>
  <td><code>appdevexperience-operator</code></td>
  <td>appdevexperience</td>
  <td>appdevexperience-operator</td>
  </tr>
  </tbody>
</table>
<p>Note that the <code>appdevexperience-operator</code> service account has the same set of
permissions as <code>controller</code>. The operator is what deploys all Kf
components, including custom resource definitions and controllers.</p>
<h3 id="rbac-for-kf-service-accounts">RBAC for Kf service accounts</h3>
<p>The following <code>apiGroup</code> definitions detail which access control
permissions components in {{product_name}} have on which API groups and resources for both the <code>controller</code>
and <code>appdevexperience-operator</code> service accounts.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;authentication.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">tokenreviews</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;authorization.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">subjectaccessreviews</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">pods</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">services</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">persistentvolumeclaims</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">persistentvolumes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">endpoints</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">events</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">configmaps</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">services</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">services/status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;apps&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deployments</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">daemonsets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">replicasets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">statefulsets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;apps&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deployments/finalizers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;rbac.authorization.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">clusterroles</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">roles</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">clusterrolebindings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">rolebindings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">escalate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deletecollection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">bind</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;apiregistration.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">apiservices</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;pubsub.cloud.google.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">topics </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">topics/status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">namespaces</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">namespaces/finalizers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">serviceaccounts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;autoscaling&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">horizontalpodautoscalers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;coordination.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">leases</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;batch&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">jobs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">cronjobs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deletecollection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;messaging.cloud.google.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">channels</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;pubsub.cloud.google.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">pullsubscriptions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;pubsub.cloud.google.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000;font-weight:bold">[</span><span style="color:#000">pullsubscriptions/status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;events.cloud.google.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;keda.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;admissionregistration.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">mutatingwebhookconfigurations</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">validatingwebhookconfigurations</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;extensions&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ingresses</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ingresses/status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>*<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">endpoints/restricted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;certificates.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">certificatesigningrequests</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">certificatesigningrequests/approval</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">certificatesigningrequests/status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;apiextensions.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">customresourcedefinitions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;networking.k8s.io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">networkpolicies</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deletecollection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">update</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">nodes/status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The following table lists how the RBAC permissions are used in Kf,
where:</p>
<ul>
<li><strong>view</strong> includes the verbs: get, list, watch</li>
<li><strong>modify</strong> includes the verbs: create, update, delete, patch</li>
</ul>
<table>
  <thead>
  <tr>
  <th><strong>Permissions</strong></th>
  <th><strong>Reasons</strong></th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td>Can view all <code>secrets</code></td>
  <td>Kf reconcilers need to read secrets for functionalities such as space creation and service instance binding.</td>
  <tr>
  <td>Can modify <code>pods</code></td>
  <td>Kf reconcilers need to modify pods for functionalities such as building/pushing Apps and Tasks.</td>
  </tr>
  <tr>
  <td>Can modify <code>secrets</code></td>
  <td>Kf reconcilers need to modify secrets for functionalities such as building/pushing Apps and Tasks and service instance binding.</td>
  </tr>
  <tr>
  <td>Can modify <code>configmaps</code></td>
  <td>Kf reconcilers need to modify configmaps for functionalities such as building/pushing Apps and Tasks.</td>
  </tr>
  <tr>
  <td>Can modify <code>endpoints</code></td>
  <td>Kf reconcilers need to modify endpoints for functionalities such as building/pushing Apps and route binding.</td>
  </tr>
  <tr>
  <td>Can modify <code>services</code></td>
  <td>Kf reconcilers need to modify pods for functionalities such as building/pushing Apps and route binding.</td>
  </tr>
  <tr>
  <td>Can modify <code>events</code></td>
  <td>Kf controller creates and emits events for the resources
    managed by Kf.</td>
  </tr>
  <tr>
  <td>Can modify <code>serviceaccounts</code></td>
  <td>Kf needs to modify service accounts for App deployments.</td>
  </tr>
  <tr>
  <td>Can modify <code>endpoints/restricted</code></td>
  <td>Kf needs to modify endpoints for App deployments.</td>
  </tr>
  <tr>
  <td>Can modify <code>deployments</code></td>
  <td>Kf needs to modify deployments for functionalities such as pushing Apps.</td>
  </tr>
  <tr>
  <td>Can modify <code>mutatingwebhookconfiguration</code></td>
  <td>Mutatingwebhookconfiguration is needed by {{mesh_name}}, a Kf dependency, for admission webhooks.</td>
  </tr>
  <tr>
  <td>Can modify
    <code>customresourcedefinitions customresourcedefinitions/status</code></td>
  <td>Kf manages resources through Custom Resources such as Apps, Spaces and Builds.</td>
  </tr>
  <tr>
  <td>Can modify <code>horizontalpodautoscalers</code></td>
  <td>Kf supports autoscaling based on Horizontal Pod Autoscalers.</td>
  </tr>
  <tr>
  <td>Can modify <code>namespace/finalizer</code></td>
  <td>Kf needs to set owner reference of webhooks.</td>
  </tr>
  </tbody>
</table>
<h2 id="third_party_libraries">Third-party libraries</h2>
<p>Third-party library source code and licenses can be found in the <code>/third_party</code>
directory of any Kf container image.</p>
<p>You can also run <code>kf third-party-licenses</code> to view the third-party licenses for
the version of the Kf CLI that you downloaded.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-835c09d088daa498f7f4edc9aca34410">1.3.4 - Kf reference architecture diagrams</h1>
    <div class="lead">Learn about common ways of deploying and managing Kf clusters.</div>
	<p>Kf can benefit from the rich ecosystem of Anthos and GKE, including automation, managed backing services, and development tools.</p>
<h2 id="gke-reference-architecture">GKE reference architecture</h2>
<p>Kf clusters are managed just like any other GKE cluster, and access resources in the same way.</p>

<figure>
    <img src="./gke-reference-diagram.svg"
         alt="GKE and Kf cluster architecture."/> 
</figure>

<h2 id="configsync">ConfigSync</h2>
<p>Kf can work with
<a href="https://github.com/GoogleContainerTools/kpt-config-sync">ConfigSync</a> to
automate Space creation across any number of clusters.
Create new namespaces on non-Kf clusters, and Spaces on Kf clusters.
You can also manage Spaces by removing the Kf CLI from Space management, if desired. Use <code>kubectl explain</code> to <a href="/kf/docs/v2.11/operator/kf-dependencies/#get_crd_details">get Kf CRD specs</a> to fully manage your product configuration via GitOps.</p>

<figure>
    <img src="./config-sync-reference-diagram.svg"
         alt="Config Sync and Kf cluster architecture."/> 
</figure>


</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-84debb8217acd435c5d68f3dcf614a6b">1.3.5 - Logging and Monitoring</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-dbee04d71aa54a688f7ea60028e06371">1.3.5.1 - Create and user monitoring dashboards.</h1>
    
	<p>You can use <a href="https://cloud.google.com/monitoring/dashboards">Google Cloud Monitoring dashboards</a> to create custom dashboards and charts. Kf comes with a default template which can be used to create dashboards to monitor the performance of your applications.</p>
<h2 id="application-performance-dashboard">Application performance dashboard</h2>
<p>Run the following commands to deploy a dashboard in your monitoring workspace in <a href="https://cloud.google.com/monitoring/dashboards">Cloud monitoring dashboards</a> to monitor performance of your apps. This dashboard has application performance metrics like requests/sec, round trip latency, HTTP error codes, and more.</p>
<pre class="devsite-terminal" suppresswarning="true" translate="no">
<code class="devsite-terminal">git clone https://github.com/google/kf</code>
<code class="devsite-terminal">cd ./kf/dashboards</code>
<code class="devsite-terminal">./create-dashboard.py my-dashboard my-cluster my-space</code>
</pre>
<h2 id="system-resources-and-performance-dashboard">System resources and performance dashboard</h2>
<p>You can view all the system resources and performance metrics such as list of nodes, pods, containers and much more using a built-in dashboard. Click the link below to access the system dashboard.</p>
  <a href="https://console.cloud.google.com/monitoring/dashboards/resourceList/kubernetes" target="_blank" class="button button-primary" track-type="tasks" track-name="consoleLink" track-metadata-position="body" track-metadata-end-goal="connectToSerialConsole" >
    System dashboard</a></p></li>
</ol>
<p>More details about this dashboard can be found <a href="https://cloud.google.com/stackdriver/docs/solutions/gke/observing">here</a>.</p>
<h2 id="create-slo-and-alerts">Create SLO and alerts</h2>
<p>You can create <a href="https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/ui/create-slo">SLOs</a> and <a href="https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/ui/create-alert">Alerts</a> on available metrics to monitor performance and availability of both system and applications. For example, you can use the metrics <code>istio.io/service/server/response_latencies</code> to setup an alert on the application roundtrip latency.</p>
<h2 id="configure-dashboard-access-control">Configure dashboard access control</h2>
<p>Follow <a href="https://cloud.google.com/monitoring/access-control">these instructions</a> to provide dashboard access to developers and other members on the team. The role <code>roles/monitoring.dashboardViewer</code> provides read-only access to dashboards.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5a85a7965fdcfe4cf8ad48fec38d5940">1.3.5.2 - Logging and monitoring</h1>
    
	<p>Kf can use GKE&rsquo;s Google Cloud integrations
to send a log of events to your Cloud Monitoring and Cloud Logging project for observability. For more information, see
<a href="https://cloud.google.com/monitoring/kubernetes-engine">Overview of GKE operations</a>.</p>
<p>Kf deploys two server side components:</p>
<ol>
<li>Controller</li>
<li>Webhook</li>
</ol>
<p>To view the logs for these components, use the following Cloud Logging query:</p>
<pre tabindex="0"><code>resource.type=&#34;k8s_container&#34;
resource.labels.project_id=&lt;PROJECT ID&gt;
resource.labels.location=&lt;GCP ZONE&gt;
resource.labels.cluster_name=&lt;CLUSTER NAME&gt;
resource.labels.namespace_name=&#34;kf&#34;
labels.k8s-pod/app=&lt;controller OR webhook&gt;
</code></pre>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Replace the values inside the &lt;&gt; with the correct values.
</aside>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-feab5808045e2631f70969b913fafe31">1.3.5.3 - Logging and monitoring overview</h1>
    
	<p>By default, Kf includes native integration with <a href="https://cloud.google.com/monitoring">Cloud Monitoring</a> and <a href="https://cloud.google.com/logging/docs">Cloud Logging</a>. When you create a cluster, both Monitoring and Cloud Logging are enabled by default. This integration lets you monitor your running clusters and help analyze your system and application performance using advanced profiling and tracing
capabilities.</p>
<p>Application level performance metrics is provided by <a href="https://cloud.google.com/service-mesh/docs/proxy-injection">Istio sidecar injection</a> which is injected alongside applications deployed via Kf. You can also create <a href="https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/ui/create-slo">SLO</a> and <a href="https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/ui/create-alert">Alerts</a> using this default integration to monitor performance and availability of both system and applications.</p>
<p>Ensure the following are setup on your cluster:</p>
<ul>
<li>
<p><a href="https://cloud.google.com/monitoring">Cloud Monitoring</a> and <a href="https://cloud.google.com/logging/docs">Cloud Logging</a> are enabled on the Kf cluster by default unless you disabled them explicitly, so no extra step is required.</p>
</li>
<li>
<p><a href="https://cloud.google.com/service-mesh/docs/proxy-injection">Istio sidecar injection</a> is enabled.  Sidecar proxy will inject application level <a href="https://cloud.google.com/monitoring/api/metrics_istio">performance metrics</a>.</p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ca8fa32dfcb17c91cbd11356f47a4f4f">1.3.5.4 - View logs</h1>
    
	<p>Kf provides you with several types of logs. This document describes these logs and how to access them.</p>
<h2 id="application-logs">Application logs</h2>
<p>All logs written to standard output <code>stdout</code> and standard error <code>stderr</code>, are uploaded to <a href="https://cloud.google.com/logging">Cloud Logging</a> and stored under the log name <code>user-container</code>.</p>
<p>Open <a href="https://cloud.google.com/logging/docs/view/logs-explorer-interface">Cloud Logging</a> and run the following query:</p>
<pre class="devsite-click-to-copy" translate="no">
resource.type="k8s_container"
log_name="projects/<var>YOUR_PROJECT_ID</var>/logs/user-container"
resource.labels.project_id=<var>YOUR_PROJECT_ID</var>
resource.labels.location=<var>GCP_COMPUTE_ZONE (e.g. us-central1-a)</var>
resource.labels.cluster_name=<var>YOUR_CLUSTER_NAME</var>
resource.labels.namespace_name=<var>YOUR_KF_SPACE_NAME</var>
resource.labels.pod_name:<var>YOUR_KF_APP_NAME</var></pre>
<p>You should see all your application logs written on standard <code>stdout</code> and standard error <code>stderr</code>.</p>
<h2 id="access-logs-for-your-applications">Access logs for your applications</h2>
<p>Kf provides access logs using <a href="https://cloud.google.com/service-mesh/docs/proxy-injection">Istio sidecar injection</a>. Access logs are stored under the log name <code>server-accesslog-stackdriver</code>.</p>
<p>Open <a href="https://cloud.google.com/logging/docs/view/logs-explorer-interface">Cloud Logging</a> and run the following query:</p>
<pre class="devsite-click-to-copy" translate="no">
resource.type="k8s_container"
log_name="projects/<var>YOUR_PROJECT_ID</var>/logs/server-accesslog-stackdriver"
resource.labels.project_id=<var>YOUR_PROJECT_ID</var>
resource.labels.location=<var>GCP_COMPUTE_ZONE (e.g. us-central1-a)</var>
resource.labels.cluster_name=<var>YOUR_CLUSTER_NAME</var>
resource.labels.namespace_name=<var>YOUR_KF_SPACE_NAME</var>
resource.labels.pod_name:<var>YOUR_KF_APP_NAME</var></pre>
<p>You should see access logs for your application. Sample access log:</p>
<pre class="devsite-click-to-copy" translate="no">
{
  "insertId": "166tsrsg273q5mf",
  "httpRequest": {
    "requestMethod": "GET",
    "requestUrl": "http://test-app-38n6dgwh9kx7h-c72edc13nkcm.***. ***.nip.io/",
    "requestSize": "738",
    "status": 200,
    "responseSize": "3353",
    "remoteIp": "10.128.0.54:0",
    "serverIp": "10.48.0.18:8080",
    "latency": "0.000723777s",
    "protocol": "http"
  },
  "resource": {
    "type": "k8s_container",
    "labels": {
      "container_name": "user-container",
      "project_id": ***,
      "namespace_name": ***,
      "pod_name": "test-app-85888b9796-bqg7b",
      "location": "us-central1-a",
      "cluster_name": ***
    }
  },
  "timestamp": "2020-11-19T20:09:21.721815Z",
  "severity": "INFO",
  "labels": {
    "source_canonical_service": "istio-ingressgateway",
    "source_principal": "spiffe://***.svc.id.goog/ns/istio-system/sa/istio-ingressgateway-service-account",
    "request_id": "0e3bac08-ab68-408f-9b14-0aec671845bf",
    "source_app": "istio-ingressgateway",
    "response_flag": "-",
    "route_name": "default",
    "upstream_cluster": "inbound|80|http-user-port|test-app.***.svc.cluster.local",
    "destination_name": "test-app-85888b9796-bqg7b",
    "destination_canonical_revision": "latest",
    "destination_principal": "spiffe://***.svc.id.goog/ns/***/sa/sa-test-app",
    "connection_id": "82261",
    "destination_workload": "test-app",
    "destination_namespace": ***,
    "destination_canonical_service": "test-app",
    "upstream_host": "127.0.0.1:8080",
    "log_sampled": "false",
    "mesh_uid": "proj-228179605852",
    "source_namespace": "istio-system",
    "requested_server_name": "outbound_.80_._.test-app.***.svc.cluster.local",
    "source_canonical_revision": "asm-173-6",
    "x-envoy-original-dst-host": "",
    "destination_service_host": "test-app.***.svc.cluster.local",
    "source_name": "istio-ingressgateway-5469f77856-4n2pw",
    "source_workload": "istio-ingressgateway",
    "x-envoy-original-path": "",
    "service_authentication_policy": "MUTUAL_TLS",
    "protocol": "http"
  },
  "logName": "projects/*/logs/server-accesslog-stackdriver",
  "receiveTimestamp": "2020-11-19T20:09:24.627065813Z"
}
</pre>
<h2 id="audit-logs">Audit logs</h2>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/audit-logging">Audit Logs</a> provides a
chronological record of calls that have been made to the Kubernetes API Server. Kubernetes audit log entries are useful for investigating suspicious API requests, for collecting statistics, or for creating monitoring alerts for unwanted API calls.</p>
<p>Open <a href="https://cloud.google.com/logging/docs/view/logs-explorer-interface">Cloud Logging</a> and run the following query:</p>
<pre class="devsite-click-to-copy" translate="no">
resource.type="k8s_container"
log_name="projects/<var>YOUR_PROJECT_ID</var>/logs/cloudaudit.googleapis.com%2Factivity"
resource.labels.project_id=<var>YOUR_PROJECT_ID</var>
resource.labels.location=<var>GCP_COMPUTE_ZONE (e.g. us-central1-a)</var>
resource.labels.cluster_name=<var>YOUR_CLUSTER_NAME</var>
protoPayload.request.metadata.name=<var>YOUR_APP_NAME</var>
protoPayload.methodName:"deployments."</pre>
<p>You should see a trace of calls being made to the Kubernetes API server.</p>
<h2 id="configure-logging-access-control">Configure logging access control</h2>
<p>Follow <a href="https://cloud.google.com/logging/docs/access-control">these instructions</a> to provide logs access to developers and other members on the team. The role <code>roles/logging.viewer</code> provides read-only access to logs.</p>
<h2 id="use-logs-router">Use Logs Router</h2>
<p>You can also use <a href="https://cloud.google.com/logging/docs/routing/overview">Logs Router</a> to route the logs to supported destinations.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2adb428c5ca36c2ceb9e1e03ad76231">1.3.6 - Networking</h1>
    <div class="lead">Learn about common cluster networking setups.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-7a417b00bb28a3931ab1fd45e7c32f1a">1.3.6.1 - Set up a custom domain</h1>
    <div class="lead">Learn to set up a DNS domain apps can use on your cluster.</div>
	<p>All Kf Apps that serve HTTP traffic to users or applications
outside of the cluster must be associated with a domain name.</p>
<p>Kf has three locations where domains can be configured.
Ordered by precedence, they are:</p>
<ol>
<li>Apps</li>
<li>Spaces</li>
<li>The <code>config-defaults</code> ConfigMap in the <code>kf</code> Namespace</li>
</ol>
<h2 id="edit-the-config-defaults-configmap">Edit the <code>config-defaults</code> ConfigMap</h2>
<p>The <code>config-defaults</code> ConfigMap holds cluster-wide settings for Kf and can be edited by cluster administrators.
The values in the ConfigMap are read by the Spaces controller and modify their configuration.
Domain values are reflected in the Space&rsquo;s <code>status.networkConfig.domains</code> field.</p>
<p>To modify Kf cluster&rsquo;s domain, edit the <code>config-defaults</code> ConfigMap in the <code>kf</code> Namespace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl edit configmap config-defaults -n kf
</span></span></code></pre></div><p>Add or update the entry for the <code>spaceClusterDomain</code> key like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spaceClusterDomain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-domain.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>To validate the configuration was updated correctly, check the domain value in a Space:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf space SPACE_NAME -o <span style="color:#4e9a06">&#34;jsonpath={.status.networkConfig.domains[][&#39;domain&#39;]}&#34;</span>
</span></span></code></pre></div><p>The output will look similar to:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">Getting Space some-space
some-space.my-domain.com
</code></pre><p>Each Space prefixes the cluster domains with its own name.
This prevents conflicts between Apps.</p>

<aside class="alert alert-danger" style="border-width: 1px 1px 1px 4px;">
<i class="fa-solid fa-triangle-exclamation"></i> <strong>Warning:</strong> Updating the <code>spaceClusterDomain</code> in <code>config-defaults</code> will immediately be
reflected on all Spaces and Apps that haven&rsquo;t overridden the domain.
</aside>


<h2 id="assign-space-domains">Assign Space domains</h2>
<p>Spaces are the authoritative location for domain configuration.
You can assign domains and sub-domains to each Space for developers to use.
The field for configuring domains is <code>spec.networkConfig.domains</code>.</p>
<p>Use <code>kf space</code> to view the domains assigned to a Space:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf space SPACE_NAME
</span></span></code></pre></div><p>In the output, the <code>Spec</code> field contains specific configuration for the Space
and the <code>Status</code> field reflects configuration for the Space with cluster-wide
defaults appended to the end:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">...
Spec:
  Network Config:
    Domains:
      Domain: my-space.mycompany.com
...
Status:
  Network Config:
    Domains:
      Domain: my-space.mycompany.com
      Domain: my-space.prod.us-east1.kf.mycompany.com
</code></pre>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Apps will use the <strong>first</strong> domain the status if developers don&rsquo;t specify a domain.
</aside>

<h3 id="add-or-remove-domains-using-the-cli">Add or remove domains using the CLI</h3>
<p>The <code>kf</code> CLI supports mutations on Space domains. Each command outputs
a diff between the old and new configurations.</p>
<p>Add a new domain with <code>kf configure-space append-domain</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf configure-space append-domain SPACE_NAME myspace.mycompany.com
</span></span></code></pre></div><p>Add or make an existing domain the default with <code>kf configure-space set-default-domain</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf configure-space set-default-domain SPACE_NAME myspace.mycompany.com
</span></span></code></pre></div><p>And finally, remove a domain:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf configure-space remove-domain SPACE_NAME myspace.mycompany.com
</span></span></code></pre></div>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> You can override a cluster domains by inserting a new domain on the <code>spec</code> with the same <code>domain</code>.
This ensures the space won&rsquo;t be updated if the cluster domain changes.
</aside>

<h2 id="use-apps-to-specify-domains">Use Apps to specify domains</h2>
<p>Apps can specify domains as part of their configuration.
Routes are mapped to Apps during <code>kf push</code> using the following logic:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">let current_routes  = The set of routes already on the app
let manifest_routes = The set of routes defined by the manifest
let flag_routes     = The set of routes supplied by the --route flag(s)
let no_route        = Whether the manifest has no-route:true or --no-route is set
let random_route    = Whether the manifest has random-route:true or --random-route is set

let new_routes = Union(current_routes, manifest_routes, flag_routes)

if new_routes.IsEmpty() then
  if random_route then
    new_routes.Add(CreateRandomRoute())
  else
    new_routes.Add(CreateDefaultRoute())
  end
end

if no_route then
  new_routes.RemoveAll()
end

return new_routes
</code></pre><p>If an App doesn&rsquo;t specify a Route, or requests a random Route, the first domain
on the Space is used. If the first domain on a Space changes, all Apps in the
Space using the default domain are updated to reflect it.</p>
<h2 id="customize-domain-templates">Customize domain templates</h2>
<p>Kf supports variable substitution in domains. Substitution allows a single
cluster-wide domain to be customized per-Space and to react to changes to the
ingress IP. Substitution is performed on variables with the syntax <code>$(VARIABLE_NAME)</code>
that occur in a domain.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CLUSTER_INGRESS_IP</code></td>
<td>The IPV4 address of the cluster ingress.</td>
</tr>
<tr>
<td><code>SPACE_NAME</code></td>
<td>The name of the Space.</td>
</tr>
</tbody>
</table>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Use the <code>SPACE_NAME</code> variable in domains to allow developers in different
Spaces to avoid DNS conflicts if they push Apps with the same name.
</aside>

<h3 id="examples">Examples</h3>
<p>The following examples demonstrate how domain variables can be used to support
a variety of different organizational structures and cluster patterns.</p>
<ul>
<li>
<p>Using a wildcard DNS service like <a href="https://nip.io/">nip.io</a>:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$(SPACE_NAME).$(CLUSTER_INGRESS_IP).nip.io
</code></pre></li>
<li>
<p>Domain for an organization with centrally managed DNS:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$(SPACE_NAME).cluster-name.example.com
</code></pre></li>
<li>
<p>Domain for teams who manage their own DNS:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">cluster-name.$(SPACE_NAME).example.com
</code></pre></li>
<li>
<p>Domain for a cluster with warm failover and external circuit breaker:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$(SPACE_NAME)-failover.cluster-name.example.com
</code></pre></li>
</ul>
<h2 id="differences-between-kf-and-cf">Differences between Kf and CF</h2>
<ul>
<li>Kf Spaces prefix the cluster-wide domain with the Space name.</li>
<li>Kf does not check for domain conflicts on user-specified routes.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-02e4f4812df4620e950d845e9b74bf7c">1.3.6.2 - Set up HTTPS ingress</h1>
    <div class="lead">Learn to set up a TLS certificate to enable HTTPS.</div>
	<p>You can secure the ingress gateway with HTTPS by using simple TLS, and enable HTTPS connections to specific webpages. In addition, you can redirect HTTP connections to HTTPS.</p>
<p>HTTPS creates a secure channel over an insecure network, protecting against man-in-the-middle attacks and encrypting traffic between the client and server. To prepare a web server to accept HTTPS connections, an administrator must create a public key certificate for the server. This certificate must be signed by a trusted certificate authority for a web browser to accept it without warning.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> These instructions supplement the Istio instructions to <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress">configure a TLS ingress gateway</a>, and assume that a valid certificate and private key for the server have already been created.
</aside>

<p>Edit the gateway named external-gateway in the <code>kf</code> namespace using the built-in Kubernetes editor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl edit gateway -n kf external-gateway
</span></span></code></pre></div><ol>
<li>Assuming you have a certificate and key for your service, create a Kubernetes secret for the ingress gateway. Make sure the secret name does not begin with <code>istio</code> or <code>prometheus</code>. For this example, the secret is named <code>myapp-https-credential</code>.</li>
<li>Under <code>servers:</code></li>
<li>Add a section for port 443.</li>
<li>Under <code>tls:</code>, set the <code>credentialName</code> to the name of the secret you just created.</li>
<li>Under <code>hosts:</code>, add the host name of the service you want to secure with HTTPS. This can be set to an entire domain using a wildcard (e.g. <code>*.example.com</code>) or scoped to just one hostname (e.g. <code>myapp.example.com</code>).</li>
<li>There should already be a section under <code>servers:</code> for port 80 HTTP. Keep this section in the Gateway definition if you would like all traffic to come in as HTTP.</li>
<li>To redirect HTTP to HTTPS, add the value <code>httpsRedirect: true</code> under <code>tls</code> in the HTTP server section. See the <a href="https://istio.io/latest/docs/reference/config/networking/gateway/">Istio Gateway documentation</a> for reference. Note that adding this in the section where <code>hosts</code> is set to <code>*</code> means that <strong>all</strong> traffic is redirected to HTTPS. If you only want to redirect HTTP to HTTPS for a single app/domain, add a separate HTTP section specifying the redirect.</li>
</ol>
<p>Shown below is an example of a Gateway <code>spec</code> that sets up HTTPS for <code>myapp.example.com</code> and redirects HTTP to HTTPS for that host:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">istio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ingressgateway</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">servers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">myapp.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HTTPS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">tls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">credentialName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myapp-https-credential</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SIMPLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">myapp.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http-my-app</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HTTP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">tls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">httpsRedirect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HTTP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-73a1d3010499b813fad95f898bb1d8a8">1.3.6.3 - Set up network policies</h1>
    <div class="lead">Learn to set up a Kubernetes NetworkPolicies to configure traffic.</div>
	<p>Kf integrates tightly with Kubernetes and Istio to
provide robust network policy enforcement.</p>
<p>By default, Kf workloads are run in the Kubernetes cluster and resolve addresses
using <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">Kubernetes DNS</a>.
This DNS resolver will first attempt to resolve addresses within the cluster,
and only if none are found will attempt external resolution.</p>
<p>Each Kf App gets run with an Envoy sidecar injected by <a href="https://istio.io/">Istio</a>
or the <a href="https://cloud.google.com/anthos/service-mesh">Anthos Service Mesh</a> (ASM).
This sidecar proxies all network traffic in and out of the Kubernetes Pod.</p>
<p>Each Kubernetes Pod is executed on a Node, a physical or virtual machine
responsible for managing the container images that make up a Pod. Nodes exist on
a physical or virtual network.</p>
<p>Together, these form a hierarchy of systems you can apply network policies.
These are listed below from least to most granular.</p>
<h2 id="network-level-policies">Network level policies</h2>
<p>Workload protection starts with the network your GKE cluster is installed on.</p>
<p>If you&rsquo;re running Kf on a GKE cluster on GCP, Kf recommends:</p>
<ul>
<li>Placing your GKE cluster on a <a href="https://cloud.google.com/vpc/docs">Virtual Private Cloud</a> (VPC) network.
<ul>
<li>With <a href="https://cloud.google.com/vpc/docs/configure-private-google-access">Private Google Access</a> enabled.</li>
</ul>
</li>
<li>Using <a href="https://cloud.google.com/nat">Cloud NAT</a> to control egress.</li>
</ul>
<h2 id="node-level-policies">Node level policies</h2>
<p>You can set up policies for containers running on the Node using Kubernetes NetworkPolicies.
These are the closest mapping to Cloud Foundry network policies that exist in Kubernetes.</p>
<p>NetworkPolicies are backed by a Kubernetes add-on. If you set up your own GKE
cluster, you will need to <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy">enable NetworkPolicy enforcement</a>.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> NetworkPolicies applied by <a href="https://www.projectcalico.org/">Project Calico</a>
filter on a per-connection basis. On Linux they are backed by <a href="https://en.wikipedia.org/wiki/Iptables">iptables</a>.
Like any firewall, <strong>they are not a substitute of authentication and authorization</strong>.
</aside>

<p>Kf labels Apps with <code>kf.dev/networkpolicy=app</code> and builds with <code>kf.dev/networkpolicy=build</code>.
This allows you to target NetworkPolicies directly at Pods running Apps or Builds.</p>
<p>Each Kf Space creates two NetworkPolicies to start with, one targeting Apps and
one targeting Builds. You can change the configuration on the Space&rsquo;s
<code>spec.networkConfig.(app|build)NetworkPolicy.(in|e)gress</code> fields.
These fields can be set to one of the following values:</p>
<table>
<thead>
<tr>
<th>Enum Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PermitAll</code></td>
<td>Allows all traffic.</td>
</tr>
<tr>
<td><code>DenyAll</code></td>
<td>Denies all traffic.</td>
</tr>
</tbody>
</table>
<p>By default Kf uses a permissive network policy. This allows the following
functionality that Kf uses:</p>
<ul>
<li>North/South routing to the cluster ingress gateway</li>
<li>Egress to the Internet e.g. to fetch Buildpacks</li>
<li>East/West routing between Apps</li>
<li>Access to the Kubernetes DNS server</li>
<li>Access to container registries</li>
<li>Direct access to the VPC network</li>
<li>Access to Google services like Cloud Logging</li>
<li>Access to the Workload Identity server for automatic rotating credentials</li>
</ul>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Setting a default <code>DenyAll</code> policy will break existing and new Apps and Builds
unless you create additional NetworkPolicies to add back the connections listed
above.
</aside>

<h2 id="service-mesh-policies">Service mesh policies</h2>
<p>If you need fine-grained networking control, authentication, authorization, and
observability you can apply policies using <a href="https://cloud.google.com/service-mesh/docs/overview">Anthos Service Mesh</a>.</p>
<p>A service mesh is an infrastructure layer that enables managed, observable and
secure communication across your services, letting you create robust enterprise
applications made up of many microservices on your chosen infrastructure.</p>
<p>You can see the <a href="https://cloud.google.com/service-mesh/docs/supported-features">list of supported features here</a>.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cbe31da3743a949ac1b65626af3b367b">1.3.7 - Security</h1>
    <div class="lead">Learn about security considerations for your Kf cluster.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-618739ac86f5ed17603f48ea81584abf">1.3.7.1 - Security Overview</h1>
    <div class="lead">Unerstand Kf&rsquo;s security posture.</div>
	<p>Kf aims to provide a similar developer experience to Cloud Foundry, replicating the build, push, and deploy lifecycle. It does this by building a developer UX layer on top of widely-known, broadly used and adopted technologies like Kubernetes, Istio, and container registries rather than by implementing all the pieces from the ground up.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Kf should be used in a GCP Project dedicated to your evaluation. See <a href="#important-considerations">Important considerations</a> for more information.
</aside>

<p>When making security decisions, Kf aims to provide complete solutions that are native to their respective components and can be augmented with other mechanisms. Breaking that down:</p>
<ul>
<li><strong>Complete solutions</strong> means that Kf tries not to provide partial solutions that can lead to a false sense of security.</li>
<li><strong>Native</strong> means that the solutions should be a part of the component rather than a Kf construct to prevent breaking changes.</li>
<li><strong>Can be augmented</strong> means the approach Kf takes should work seamlessly with other Kubernetes and Google Cloud tooling for defense in depth.</li>
</ul>
<h2 id="important-considerations">Important considerations</h2>
<p>In addition to the <a href="#current-limitations">Current limitations</a> described below, it is important that you read through and understand the items outlined in this section.</p>
<h3 id="workload-identity">Workload Identity</h3>
<p>By default, Kf uses <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a> to provide secure delivery and rotation of the Service Account credentials used by Kf to interact with your Google Cloud Project. Workload Identity achieves this by mapping a Kubernetes Service Account (KSA) to a Google Service Account (GSA). The Kf controller runs in the <code>kf</code> namespace and uses a KSA named <code>controller</code> mapped to your GSA to do the following things:</p>
<ol>
<li>Write metrics to Stackdriver</li>
<li>When a new Kf space is created (<code>kf create-space</code>), the Kf controller creates a new KSA named <code>kf-builder</code> in the new space and maps it to the same GSA.</li>
<li>The <code>kf-builder</code> KSA is used by Tekton to push and pull container images to Google Container Registry (gcr.io)</li>
</ol>
<p>This diagram illustrates those interactions:</p>

<figure>
    <img src="./wi_overview.svg"
         alt="Workload identity overview diagram"/> 
</figure>

<h3 id="current-limitations">Current limitations</h3>
<ul>
<li>
<p>Kf doesn&rsquo;t provide pre-built RBAC roles. Until
Kf provides this, use
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control">RBAC</a>.</p>
</li>
<li>
<p>A developer pushing an app with Kf can also create
Pods (with <code>kubectl</code>) that can use the <code>kf-builder</code> KSA with the permissions
of its associated GSA.</p>
</li>
<li>
<p>Deploying to Kf requires write access to a container
registry. Deploy Kf in a dedicated project without
access to production resources. Grant developers access to push code to the
Artifact Repository by
<a href="https://cloud.google.com/container-registry/docs/access-control">granting them <code>roles/storage.admin</code></a>
on the project or buckets that Artifact Repository uses.</p>
</li>
<li>
<p>Kf uses the same Pod to fetch, build, and store images.
Assume that any credentials that you provide can be known by the authors and
publishers of the buildpacks you use.</p>
</li>
<li>
<p>Kf doesn&rsquo;t support quotas to protect against noisy
neighbors. Use Kubernetes
<a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">resource quotas</a>.</p>
</li>
</ul>
<h2 id="other-resources">Other resources</h2>
<h3 id="google-cloud">Google Cloud</h3>
<h4 id="general">General</h4>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/security-overview">GKE security overview</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/multitenancy-overview">GKE cluster multi-tenancy</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/iam">GKE and Cloud IAM policies</a></li>
</ul>
<h4 id="recommended-protections">Recommended protections</h4>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/protecting-cluster-metadata">Protecting cluster metadata</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control">Role-based access control</a></li>
</ul>
<h4 id="advanced-protections">Advanced protections</h4>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods">GKE Sandbox</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy">Network policies</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-304425574fd6e3f21a7dd1619983268f">1.3.7.2 - Role-based access control</h1>
    <div class="lead">Learn about how to share a Kf cluster using roles.</div>
	<p>Kf provides a set of Kubernetes roles that allow multiple teams to share a Kf cluster.
This page describes the roles and best practices to follow when using them.</p>
<h2 id="when-to-use-kf-roles">When to use Kf roles</h2>
<p>Kf roles allow multiple teams to share a Kubernetes
cluster with Kf installed. The roles provide access to
individual Kf Spaces.</p>
<p>Use Kf roles to share access to a cluster if the
following are true:</p>
<ul>
<li>The cluster is used by trusted teams.</li>
<li>Workloads on the cluster share the same assumptions about the level of
security provided by the environment.</li>
<li>The cluster exists in a Google Cloud project that is tightly controlled.</li>
</ul>
<p>Kf roles will not:</p>
<ul>
<li>Protect your cluster from untrusted developers or workloads. See the
<a href="https://cloud.google.com/blog/products/containers-kubernetes/exploring-container-security-the-shared-responsibility-model-in-gke-container-security-shared-responsibility-model-gke">GKE shared responsibility model</a>
for more information.</li>
<li>Provide isolation for your workloads. See the
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster">guide to harden your cluster</a>
for more information.</li>
<li>Prevent
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control">additional Kubernetes roles</a>
from being defined that interact with Kf.</li>
<li>Prevent access from <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/iam">administrators who have access to the Google Cloud project or cluster</a>.</li>
</ul>
<h2 id="roles">Kf roles</h2>
<p>The following sections describe the Kubernetes RBAC Roles provided by
Kf and how they interact with GKE IAM.</p>
<h3 id="predefined_roles">Predefined roles</h3>
<p>Kf provides several predefined Kubernetes roles to help
you provide access to different subjects that perform different roles. Each
predefined role can be bound to a subject within a Kubernetes Namespace managed
by a Kf Space.</p>
<p>When a subject is bound to a role within a Kubernetes Namespace, their access is
limited to objects that exist in the Namespace that match the grants listed in
the role. In Kf, some resources are defined at the cluster
scope. Kf watches for changes to subjects in the Namespace
and grants additional, limited, roles at the cluster scope.</p>
<table>
<thead>
<tr>
<th>Role</th>
<th>Title</th>
<th>Description</th>
<th>Scope</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>space-auditor</code></td>
<td>Space Auditor</td>
<td>Allows read-only access to a Space.</td>
<td>Space</td>
</tr>
<tr>
<td><code>space-developer</code></td>
<td>Space Developer</td>
<td>Allows application developers to deploy and manage applications within a Space.</td>
<td>Space</td>
</tr>
<tr>
<td><code>space-manager</code></td>
<td>Space Manager</td>
<td>Allows administration and the ability to manage auditors, developers, and managers in a Space.</td>
<td>Space</td>
</tr>
<tr>
<td><code>SPACE_NAME-manager</code></td>
<td>Dynamic Space Manager</td>
<td>Provides write access to a single Space object, automatically granted to all subjects with the <code>space-manager</code> role within the named Space.</td>
<td>Cluster</td>
</tr>
<tr>
<td><code>kf-cluster-reader</code></td>
<td>Cluster Reader</td>
<td>Allows read-only access to cluster-scoped Kf objects, automatically granted to all <code>space-auditor</code>, <code>space-developer</code>, and <code>space-manager</code>.</td>
<td>Cluster</td>
</tr>
</tbody>
</table>
<p>Information about the policy rules that make up each predefined role can be found in the
<a href="/kf/docs/v2.11/operator/security/kubernetes-roles/">Kf roles reference documentation</a>.</p>
<h3 id="interaction_with_iam">Google Cloud IAM roles</h3>
<p>Kf roles provide access control for objects within a
Kubernetes cluster. Subjects must also be granted an Cloud IAM role to
authenticate to the cluster:</p>
<ul>
<li>
<p><strong>Platform administrators</strong> should be granted the <code>roles/container.admin</code> Cloud IAM role.
This will allow them to install, upgrade, and delete Kf as well as create, and delete
cluster scoped Kf objects like <a href="kf-dependencies#custom-resources">Spaces or ClusterServiceBrokers</a>.</p>
</li>
<li>
<p><strong>Kf end-users</strong> should be granted the <code>roles/container.viewer</code> Cloud IAM role.
This role will allow them to authenticate to a cluster with limited permissions that can be expanded using
Kf roles.</p>
</li>
</ul>
<p>Google Cloud IAM offers additional <a href="https://cloud.google.com/iam/docs/understanding-roles#predefined_roles">predefined Roles</a>
for GKE to solve more advanced use cases.</p>
<h2 id="map-cloud-foundry-roles-to-kf">Map Cloud Foundry roles to Kf</h2>
<p><a href="https://docs.cloudfoundry.org/concepts/roles.html">Cloud Foundry provides roles</a>
are similar to Kf&rsquo;s <a href="#predefined_roles">predefined roles</a>.
Cloud Foundry has two major types of roles:</p>
<ul>
<li>Roles assigned by the User Account and Authentication (UAA) subsystem that provide
coarse-grained OAuth scopes applicable to all Cloud Foundry API endpoints.</li>
<li>Roles granted within the Cloud Controller API (CAPI) that provide fine-grained
access to API resources.</li>
</ul>
<h3 id="uaa-roles">UAA roles</h3>
<p>Roles provided by UAA are most similar to project scoped Google Cloud IAM roles:</p>
<ul>
<li><strong>Admin</strong> users in Cloud Foundry can perform administrative activities for all
Cloud Foundry organizations and spaces. The role is most similar to the
<code>roles/container.admin</code> Google Cloud IAM role.</li>
<li><strong>Admin read-only</strong> users in Cloud Foundry can access all Cloud Foundry API
endpoints. The role is most similar to the <code>roles/container.admin</code>
Google Cloud IAM role.</li>
<li><strong>Global auditor</strong> users in Cloud Foundry have read access to all Cloud Foundry API
endpoints except for secrets.
There is no equivalent Google Cloud IAM role, but you can create a
<a href="https://cloud.google.com/iam/docs/creating-custom-roles">custom role</a> with similar permissions.</li>
</ul>
<h3 id="cloud-controller-api-roles">Cloud Controller API roles</h3>
<p>Roles provided by CAPI are most similar to Kf roles granted within a cluster
to subjects that have the <code>roles/container.viewer</code> Google Cloud IAM role on the owning project:</p>
<ul>
<li><strong>Space auditors</strong> in Cloud Foundry have read-access to resources in a CF space.
The role is most similar to the <code>space-auditor</code> Kf role.</li>
<li><strong>Space developers</strong> in Cloud Foundry have the ability to deploy and manage
applications in a CF space.
The role is most similar to the <code>space-developer</code> Kf role.</li>
<li><strong>Space managers</strong> in Cloud Foundry can modify settings for the CF space and
assign users to roles.
The role is most similar to the <code>space-manager</code> Kf role.</li>
</ul>
<h2 id="whats-next">What&rsquo;s next</h2>
<ul>
<li>Learn more about <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/security-overview">GKE security in the Security Overview</a>.</li>
<li>Make sure you understand the <a href="https://cloud.google.com/blog/products/containers-kubernetes/exploring-container-security-the-shared-responsibility-model-in-gke-container-security-shared-responsibility-model-gke">GKE shared responsibility
model</a>.</li>
<li>Learn more about <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/access-control">access control</a> in GKE.</li>
<li>Read the <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/multitenancy-overview">GKE multi-tenancy overview</a>.</li>
<li>Learn about <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster">hardening your GKE cluster</a>.</li>
<li>Understand the <a href="/kf/docs/v2.11/operator/security/kubernetes-roles/">Kubernetes permissions that make up each Kf predefined role</a>.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-40ff7467b86eb5796edbb4944e3340fe">1.3.7.3 - Configure role-based access control</h1>
    <div class="lead">Learn to grant users different roles on a cluster.</div>
	<p>The following steps guide you through configuring role-based access control (RBAC) in a Kf Space.</p>
<h2 id="before-you-begin">Before you begin</h2>
<p>Please follow the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control">GKE RBAC guide</a> before continuing with the following steps.</p>
<h2 id="configure-identity-and-access-management-iam">Configure Identity and Access Management (IAM)</h2>
<p>In addition to permissions granted through Kf RBAC, users, groups, or service accounts must also be authenticated to view GKE clusers at the project level. This requirement is the same as for configuring GKE RBAC, meaning users/groups must have at least the <code>container.clusters.get</code> IAM permission in the project containing the cluster. This permission is included by the <code>container.clusterViewer</code> role, and other more privilleged roles. For more information, review <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#iam-interaction">Interaction with Identity and Access Management</a>.</p>
<p>Assign <code>container.clusterViewer</code> to a user or group.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gcloud projects add-iam-policy-binding <span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_PROJECT_ID</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --role<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;container.clusterViewer&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --member<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">MEMBER</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>Example member values are:</p>
<ul>
<li>user:test-user@gmail.com</li>
<li>group:admins@example.com</li>
<li>serviceAccount:test123@example.domain.com</li>
</ul>
<h2 id="manage-space-membership-as-spacemanager">Manage Space membership as SpaceManager</h2>
<p>The cluster admin role, or members with <strong>SpaceManager</strong> role, can assign role to a user, group or service account.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf set-space-role MEMBER -t <span style="color:#ce5c00;font-weight:bold">[</span>Group<span style="color:#000;font-weight:bold">|</span>ServiceAccount<span style="color:#000;font-weight:bold">|</span>User<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The cluster admin role, or members with <strong>SpaceManager</strong> role, can remove a member from a role.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf unset-space-role MEMBER -t <span style="color:#ce5c00;font-weight:bold">[</span>Group<span style="color:#000;font-weight:bold">|</span>ServiceAccount<span style="color:#000;font-weight:bold">|</span>User<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>You can view members and their roles within a Space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf space-users
</span></span></code></pre></div><h3 id="examples">Examples</h3>
<p>Assign <strong>SpaceDeveloper</strong> role to a user.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf set-space-role alice@example.com SpaceDeveloper
</span></span></code></pre></div><p>Assign <strong>SpaceDeveloper</strong> role to a group.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf set-space-role devs@example.com SpaceDeveloper -t Group
</span></span></code></pre></div><p>Assign <strong>SpaceDeveloper</strong> role to a Service Account.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf set-space-role sa-dev@example.domain.com SpaceDeveloper -t ServiceAccount
</span></span></code></pre></div><h2 id="app-development-as-spacedeveloper">App development as SpaceDeveloper</h2>
<p>Members with <strong>SpaceDeveloper</strong> role can perform Kf App development operations within the Space.</p>
<p>To push an App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push app_name -p <span style="color:#ce5c00;font-weight:bold">[</span>PATH_TO_APP_ROOT_DIRECTORY<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>To view logs of an App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf logs app_name
</span></span></code></pre></div><p>SSH into a Kubernetes Pod running the App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf ssh app_name
</span></span></code></pre></div><p>View available service brokers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf marketplace
</span></span></code></pre></div><h2 id="view-apps-as-spacemanager-or-spaceauditor">View Apps as SpaceManager or SpaceAuditor</h2>
<p>Members with <strong>SpaceManager</strong> or <strong>SpaceAuditor</strong> role could view available Apps within the Space:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf apps
</span></span></code></pre></div><h2 id="view-kf-spaces-within-a-cluster">View Kf Spaces within a cluster</h2>
<p>All roles (<strong>SpaceManager</strong>, <strong>SpaceDeveloper</strong>, and <strong>SpaceAuditor</strong>) can view available Kf Spaces within a cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf spaces
</span></span></code></pre></div><p>View Space members and their roles within a Space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf space-users
</span></span></code></pre></div><h2 id="impersonation-flags">Impersonation flags</h2>
<p>To verify a member&rsquo;s permission, a member with more priviliaged permission can test another member&rsquo;s permissions using the impersonation flags: <code>--as</code> and <code>--as-group</code>.</p>
<p>For example, as a cluster admin, you can verify if a user (username: bob) has permission to push an App.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push APP_NAME --as bob
</span></span></code></pre></div><p>Verify a group (<code>manager-group@example.com</code>) has permission to assign permission to other members.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf set-space-role bob SpaceDeveloper --as-group manager-group@example.com
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4497b76abb619113621471039e747061">1.3.7.4 - Enable compute isolation</h1>
    <div class="lead">Isolate the underlying nodes certain apps or builds are scheuled onto.</div>
	<p>Kf Apps can be deployed on dedicated nodes in the cluster.
This feature is required if you have the circumstances where you might want more
control on a node where an App Pod lands. For example:</p>
<ul>
<li>If you are sharing the same cluster for different Apps but want dedicated
nodes for a particular App.</li>
<li>If you want dedicated nodes for a given organization (Kf Space).</li>
<li>If you want to target a specific operating system like Windows.</li>
<li>If you want to co-locate Pods from two different services that frequently
communicate.</li>
</ul>
<p>To enable compute isolation, Kf uses the Kubernetes <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node">nodeSelector</a>. To
use this feature, first add labels on the nodes or node pools where you want
your App Pods to land and then add the same qualifying labels on the Kf Space.
All the Apps installed in this Space then land on the nodes with matching labels.</p>
<p>Kf creates a Kubernetes pod to execute each Kf Build, the buildNodeSelector feature can be used to isolate compute resources to execute only the Build pods. One use case is to isolate Build pods to run on nodes with SSD, while running the App pods on other nodes. The BuildNodeSelectors feature provides compute resource optimization and flexibility in the cluster. Please refer to chapter &lsquo;Configure BuildNodeSelectors and a build node pool&rsquo; on this page.</p>
<h2 id="configure-nodeselector-in-a-kf-cluster">Configure nodeSelector in a Kf cluster</h2>
<p>By default, compute isolation is disabled. Use the following procedure
to configure labels and nodeSelector.</p>
<ol>
<li>
<p>Add a label (<code>distype=ssd</code>) on the node where you want your application pods to
land.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl label nodes nodeid <span style="color:#000">disktype</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd
</span></span></code></pre></div></li>
<li>
<p>Add the same label on the Kf Space. All Apps deployed in this Space
will then land on the qualifying nodes.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf configure-space set-nodeselector space-name disktype ssd
</span></span></code></pre></div><p>You can add multiple labels by running the same command again.</p>
</li>
<li>
<p>Check the label is configured.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf configure-space get-nodeselector space-name
</span></span></code></pre></div></li>
<li>
<p>Delete the label from the space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf configure-space unset-nodeselector space-name disktype
</span></span></code></pre></div></li>
</ol>
<h2 id="override-nodeselector-for-kf-stacks">Override nodeSelector for Kf stacks</h2>
<p>Deployment of Kf Apps can be further targeted based
on what stack is being used to build and package the App. For
example, if you want your applications built with <code>spaceStacksV2</code> to land on
nodes with Linux kernel 4.4.1., <code>nodeSelector</code> values on a stack override the
values configured on the Space.</p>
<p>To configure the <code>nodeSelector</code> on a stack:</p>
<ol>
<li>
<p>Edit the <code>config-defaults</code> of your Kf cluster and add the labels.</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ kubectl -n kf edit configmaps config-defaults
</code></pre></li>
<li>
<p>Add <code>nodeSelector</code> to the stacks definition.</p>
<pre tabindex="0"><code class="language-none" data-lang="none">.....
.....
spaceStacksV2: |
- name:  cflinuxfs3
        image: cloudfoundry/cflinuxfs3
        nodeSelector:
              OS_KERNEL: LINUX_4.4.1 
.....
.....
</code></pre></li>
</ol>
<h2 id="configure-buildnodeselectors-and-a-build-node-pool">Configure BuildNodeSelectors and a Build node pool</h2>
<p>Build node selectors are only effective at overriding the node selectors for the Build pods, they do not affect App pods. For example, if you specify both the node selectors on the Space and the Build node selectors in Kfsystem, App pods will have the Space node selectors while the Build pods will have the Build node selectors from Kfsystem; if node selectors are only specified in the Space, both the App and Build pods will have the node selector from the Space.</p>
<ol>
<li>
<p>Add labels (<code>disktype:ssd</code> for example) on the nodes that you want your Build pods to be assigned to.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl label nodes nodeid <span style="color:#000">disktype</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd
</span></span></code></pre></div></li>
<li>
<p>Add/update Build node selectors (in the format of <code>key:value</code> pairs) by patching KfSystem CR.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl patch kfsystem kfsystem --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;json&#39;</span> -p<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;[{&#39;</span>op<span style="color:#4e9a06">&#39;: &#39;</span>replace<span style="color:#4e9a06">&#39;, &#39;</span>path<span style="color:#4e9a06">&#39;: &#39;</span>/spec/kf/config/buildNodeSelectors<span style="color:#4e9a06">&#39;, &#39;</span>value<span style="color:#4e9a06">&#39;: {&lt;key&gt;:&lt;value&gt;}}]&#39;</span>
</span></span></code></pre></div><p>For example, to add <code>disktype=ssd</code> as the Build node selector:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl patch kfsystem kfsystem --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;json&#39;</span> -p<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;[{&#39;</span>op<span style="color:#4e9a06">&#39;: &#39;</span>replace<span style="color:#4e9a06">&#39;, &#39;</span>path<span style="color:#4e9a06">&#39;: &#39;</span>/spec/kf/config/buildNodeSelectors<span style="color:#4e9a06">&#39;, &#39;</span>value<span style="color:#4e9a06">&#39;: {&#34;disktype&#34;:&#34;ssd&#34;}}]&#39;</span>
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f4376724fa27ad233014070cf3e62b66">1.3.7.5 - Kubernetes Roles</h1>
    <div class="lead">Understand how Kf uses Kubernetes&rsquo; RBAC to assign roles.</div>
	<p>The following sections describe the <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Kubernetes ClusterRoles</a>
that are created by Kf and lists the permissions that are
contained in each ClusterRole.</p>
<h2 id="space-developer">Space developer role</h2>
<p>The Space developer role aggregates permissions application developers use
to deploy and manage applications within a Kf Space.</p>
<p>You can retrieve the permissions granted to Space developers on your cluster
using the following command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl describe clusterrole space-developer
</span></span></code></pre></div><p>The default installation of Kf provides the following
permissions:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">PolicyRule:
  Resources                               Non-Resource URLs  Resource Names  Verbs
  ---------                               -----------------  --------------  -----
  events                                  []                 []              [*]
  secrets                                 []                 []              [*]
  *.kf.dev                                []                 []              [*]
  networkpolicies.networking.k8s.io       []                 []              [*]
  pods/exec                               []                 []              [create]
  *.upload.kf.dev                         []                 []              [create]
  pods/log                                []                 []              [get list watch]
  pods                                    []                 []              [get list watch]
  rolebindings.rbac.authorization.k8s.io  []                 []              [get list watch]
</code></pre><h2 id="space-auditor">Space auditor role</h2>
<p>The Space auditor role aggregates read-only permissions that auditors and
automated tools use to validate applications within a
Kf Space.</p>
<p>You can retrieve the permissions granted to Space auditors on your cluster
using the following command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl describe clusterrole space-auditor
</span></span></code></pre></div><p>The default installation of Kf provides the following
permissions:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">PolicyRule:
  Resources                               Non-Resource URLs  Resource Names  Verbs
  ---------                               -----------------  --------------  -----
  events                                  []                 []              [*]
  apps.kf.dev                             []                 []              [get list watch]
  rolebindings.rbac.authorization.k8s.io  []                 []              [get list watch]
</code></pre><h2 id="space-manager">Space manager role</h2>
<p>The Space manager role aggregates permissions that allow delegation of duties to
others within a Kf Space.</p>
<p>You can retrieve the permissions granted to Space managers on your cluster
using the following command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl describe clusterrole space-manager
</span></span></code></pre></div><p>The default installation of Kf provides the following
permissions:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">PolicyRule:
  Resources                               Non-Resource URLs  Resource Names     Verbs
  ---------                               -----------------  --------------     -----
  clusterroles.rbac.authorization.k8s.io  []                 [space-auditor]    [bind]
  clusterroles.rbac.authorization.k8s.io  []                 [space-developer]  [bind]
  clusterroles.rbac.authorization.k8s.io  []                 [space-manager]    [bind]
  rolebindings.rbac.authorization.k8s.io  []                 []                 [get list update patch watch]
  apps.kf.dev                             []                 []                 [get list watch]
</code></pre>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> Subjects bound to the <code>space-manager</code> ClusterRole within a
Kf Space are also granted write access to that Space.
</aside>

<h2 id="dynamic-space-manager">Dynamic Space manager role</h2>
<p>Each Kf Space creates a ClusterRole with the name
<code>SPACE_NAME-manager</code>, where
<code>SPACE_NAME-manager</code> is called the dynamic manager role.</p>
<p>Kf
automatically grants all subjects with the <code>space-manager</code> role within the
Space the dynamic manager role at the cluster scope. The permissions for the
dynamic manager role allow Space managers to update settings on the Space with
the given name.</p>
<p>You can retrieve the permissions granted to the dynamic manager role for any
Space on your cluster using the following command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl describe clusterrole SPACE_NAME-manager
</span></span></code></pre></div><p>The default installation of Kf provides the following
permissions:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">PolicyRule:
  Resources      Non-Resource URLs  Resource Names  Verbs
  ---------      -----------------  --------------  -----
  spaces.kf.dev  []                 [SPACE_NAME]    [get list watch update patch]
</code></pre><h2 id="kf-cluster-reader">Kf cluster reader role</h2>
<p>Kf automatically grants the <code>kf-cluster-reader</code> role to all users on a
cluster that already have the <code>space-developer</code>, <code>space-auditor</code>, or <code>space-manager</code>
role within a Space.</p>
<p>You can retrieve the permissions granted to Space Kf
cluster readers on your cluster using the following command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl describe clusterrole kf-cluster-reader
</span></span></code></pre></div><p>The default installation of Kf provides the following
permissions:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">PolicyRule:
  Resources                     Non-Resource URLs  Resource Names  Verbs
  ---------                     -----------------  --------------  -----
  namespaces                    []                 [kf]            [get list watch]
  clusterservicebrokers.kf.dev  []                 []              [get list watch]
  spaces.kf.dev                 []                 []              [get list watch]
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-340fae6dd8d6497edae52aa4e6cac4ff">1.3.8 - Stacks and Buildpacks</h1>
    
	<p>Learn about configuring stacks and buildpacks for your platform.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6dc2637a3c7511c15b5eea65056a667c">1.3.8.1 - Customize stacks</h1>
    
	<p>The Stack configuration can be updated by editing the <code>kfsystem</code> Custom Resource:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl edit kfsystem kfsystem
</span></span></code></pre></div><p>This example sets the Google Cloud buildpacks a V3 Stack:</p>
<pre tabindex="0"><code>spec:
  kf:
    config:
      spaceStacksV3:
      - name: google
        description: Google buildpacks (https://github.com/GoogleCloudPlatform/buildpacks)
        buildImage: gcr.io/buildpacks/builder:v1
        runImage: gcr.io/buildpacks/gcp/run:v1
</code></pre><p>This new Stack can now be pushed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push myapp --stack google
</span></span></code></pre></div><p>This example configures the Ruby V2 buildpack and sets the build pipeline defaults to use V2 Stacks:</p>
<pre tabindex="0"><code>spec:
  kf:
    config:
      spaceDefaultToV3Stack: false
      spaceBuildpacksV2:
      - name: ruby_buildpack
        url: https://github.com/cloudfoundry/ruby-buildpack
      spaceStacksV2:
      - name: cflinuxfs3
        image: cloudfoundry/cflinuxfs3@sha256:5219e9e30000e43e5da17906581127b38fa6417f297f522e332a801e737928f5
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7b5d652a95409ea35a6e10e2bce40600">1.3.8.2 - Customize stacks and buildpacks</h1>
    
	<p>Buildpacks are used by Kf to turn an application&rsquo;s source
code into an executable image. Cloud Native buildpacks use the latest
<a href="https://github.com/buildpack/spec">Buildpack API v3</a>.
Companies are actively adding v3 support to existing buildpacks.</p>
<p>Kf supports buildpacks that conform to both <a href="https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html">V2</a>
and <a href="https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html">V3</a>
of the Buildpack API specification.</p>
<h2 id="compare-v2-and-v3-buildpacks">Compare V2 and V3 buildpacks</h2>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">V2 buildpacks</th>
<th style="text-align:left">V3 buildpacks</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Alternate names</td>
<td style="text-align:left">Cloud Foundry buildpacks</td>
<td style="text-align:left">Cloud Native buildpacks (CNB), Builder Images</td>
</tr>
<tr>
<td style="text-align:left">Status</td>
<td style="text-align:left">Being replaced</td>
<td style="text-align:left">Current</td>
</tr>
<tr>
<td style="text-align:left">Ownership</td>
<td style="text-align:left">Cloud Foundry</td>
<td style="text-align:left"><a href="https://buildpacks.io">Buildpacks.io</a></td>
</tr>
<tr>
<td style="text-align:left">Stack</td>
<td style="text-align:left">Shared by builder and runtime</td>
<td style="text-align:left">Optionally different for builder and runtime</td>
</tr>
<tr>
<td style="text-align:left">Local development</td>
<td style="text-align:left">Not possible</td>
<td style="text-align:left">Yes, with the <a href="https://buildpacks.io"><code>pack</code> CLI</a></td>
</tr>
<tr>
<td style="text-align:left">Custom buildpacks</td>
<td style="text-align:left">Available at runtime</td>
<td style="text-align:left">Must be built into the builder</td>
</tr>
</tbody>
</table>
<h2 id="buildpack-lifecycle">Buildpack lifecycle</h2>
<table>
<thead>
<tr>
<th>Step</th>
<th>Cloud Foundry</th>
<th>Kf with buildpacks V2</th>
<th>Kf with buildpacks V3</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source location</td>
<td>BITS service</td>
<td>Container registry</td>
<td>Container registry</td>
</tr>
<tr>
<td>Buildpack location</td>
<td>BOSH/HTTP</td>
<td>HTTP</td>
<td>Container registry</td>
</tr>
<tr>
<td>Stack location</td>
<td>BOSH</td>
<td>Container registry</td>
<td>Container registry</td>
</tr>
<tr>
<td>Result</td>
<td>Droplet (App binary without stack)</td>
<td>Image (Droplet on a stack)</td>
<td>Image</td>
</tr>
<tr>
<td>Runtime</td>
<td>Droplet glued on top of stack and run</td>
<td>Run produced image</td>
<td>Run produced image</td>
</tr>
</tbody>
</table>
<p>Kf <em>always</em> produces a full, executable image as a result of its build process.
Cloud Foundry, on the other hand, produces parts of an executable image at build time and the rest is added at runtime.</p>
<p>Kf chose to follow the model of always producing a full image for the following reasons:</p>
<ul>
<li>Images can be exported, run locally, and inspected statically</li>
<li>Better security and auditing with tools like <a href="https://cloud.google.com/binary-authorization/">binary authorization</a></li>
<li>App deployments are reproducible</li>
</ul>
<h2 id="kf-and-buildpacks">Kf and buildpacks</h2>
<p>Kf stores its global list of buildpacks and stacks in the
<code>config-defaults</code> ConfigMap in the <code>kf</code> Namespace. Modification of the buildpacks and stacks properties should be done at the <code>kfsystem</code> Custom Resource, the Kf operator automatically updates the <code>config-defaults</code> ConfigMap based on the values set at <code>kfsystem</code>.</p>
<p>Each Space reflects these buildpacks in its status field.
For a Space named <code>buildpack-docs</code> you could run the following to see the full
Space configuration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf space buildpack-docs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Getting Space buildpack-docs
</span></span><span style="display:flex;"><span>API Version:  kf.dev/v1alpha1
</span></span><span style="display:flex;"><span>Kind:         Space
</span></span><span style="display:flex;"><span>Metadata:
</span></span><span style="display:flex;"><span>  Creation Timestamp:  2020-02-14T15:09:52Z
</span></span><span style="display:flex;"><span>  Name:                buildpack-docs
</span></span><span style="display:flex;"><span>  Self Link:           /apis/kf.dev/v1alpha1/spaces/buildpack-docs
</span></span><span style="display:flex;"><span>  UID:                 0cf1e196-4f3c-11ea-91a4-42010a80008d
</span></span><span style="display:flex;"><span>Status:
</span></span><span style="display:flex;"><span>  Build Config:
</span></span><span style="display:flex;"><span>    Buildpacks V2:
</span></span><span style="display:flex;"><span>    - Name:      staticfile_buildpack
</span></span><span style="display:flex;"><span>      URL:       https://github.com/cloudfoundry/staticfile-buildpack
</span></span><span style="display:flex;"><span>      Disabled:  <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>    - Name:      java_buildpack
</span></span><span style="display:flex;"><span>      URL:       https://github.com/cloudfoundry/java-buildpack
</span></span><span style="display:flex;"><span>      Disabled:  <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>    Stacks V2:
</span></span><span style="display:flex;"><span>    - Image:  cloudfoundry/cflinuxfs3
</span></span><span style="display:flex;"><span>      Name:   cflinuxfs3
</span></span><span style="display:flex;"><span>    Stacks V3:
</span></span><span style="display:flex;"><span>    - Build Image:  cloudfoundry/cnb:cflinuxfs3
</span></span><span style="display:flex;"><span>      Description:  A large Cloud Foundry stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>      Name:         org.cloudfoundry.stacks.cflinuxfs3
</span></span><span style="display:flex;"><span>      Run Image:    cloudfoundry/run:full-cnb
</span></span></code></pre></div><p>Under the <code>Build Config</code> section there are three fields to look at:</p>
<ul>
<li>Buildpacks V2 contains a list of V2 compatible buildpacks in the order they&rsquo;ll be run</li>
<li>Stacks V2 indicates the stacks that can be chosen to trigger a V2 buildpack build</li>
<li>Stacks V3 indicates the stacks that can be chosen to trigger a V3 buildpack build</li>
</ul>
<p>You can also list the stacks with <code>kf stacks</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf stacks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Getting stacks in Space: buildpack-docs
</span></span><span style="display:flex;"><span>Version  Name                                Build Image                  Run Image                  Description
</span></span><span style="display:flex;"><span>V2       cflinuxfs3                          cloudfoundry/cflinuxfs3      cloudfoundry/cflinuxfs3
</span></span><span style="display:flex;"><span>V3       org.cloudfoundry.stacks.cflinuxfs3  cloudfoundry/cnb:cflinuxfs3  cloudfoundry/run:full-cnb  A large Cloud Foundry stack based on Ubuntu 18.04
</span></span></code></pre></div><p>Because V3 build images already have their buildpacks built-in, you must use <code>kf buildpacks</code> to get the list:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf buildpacks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Getting buildpacks in Space: buildpack-docs
</span></span><span style="display:flex;"><span>Buildpacks <span style="color:#204a87;font-weight:bold">for</span> V2 stacks:
</span></span><span style="display:flex;"><span>  Name                   Position  URL
</span></span><span style="display:flex;"><span>  staticfile_buildpack   <span style="color:#0000cf;font-weight:bold">0</span>         https://github.com/cloudfoundry/staticfile-buildpack
</span></span><span style="display:flex;"><span>  java_buildpack         <span style="color:#0000cf;font-weight:bold">1</span>         https://github.com/cloudfoundry/java-buildpack
</span></span><span style="display:flex;"><span>V3 Stack: org.cloudfoundry.stacks.cflinuxfs3:
</span></span><span style="display:flex;"><span>  Name                                        Position  Version     Latest
</span></span><span style="display:flex;"><span>  org.cloudfoundry.jdbc                       <span style="color:#0000cf;font-weight:bold">0</span>         v1.0.179    <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  org.cloudfoundry.jmx                        <span style="color:#0000cf;font-weight:bold">1</span>         v1.0.180    <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  org.cloudfoundry.go                         <span style="color:#0000cf;font-weight:bold">2</span>         v0.0.2      <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  org.cloudfoundry.tomcat                     <span style="color:#0000cf;font-weight:bold">3</span>         v1.1.102    <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  org.cloudfoundry.distzip                    <span style="color:#0000cf;font-weight:bold">4</span>         v1.0.171    <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  org.cloudfoundry.springboot                 <span style="color:#0000cf;font-weight:bold">5</span>         v1.1.2      <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><h2 id="customize-v3-buildpacks">Customize V3 buildpacks</h2>
<p>You can customize the buildpacks that are available to your developers by
creating your own builder image with exactly the buildpacks they should have
access to. You can also use builder images published by other authors.</p>
<h3 id="use-a-third-party-builder-image">Use a third-party builder image</h3>
<p>A list of published CNB stacks is available from the
<a href="https://buildpacks.io/docs/install-pack/">Buildpack CLI <code>pack</code></a>.
As of this writing, <code>pack suggest-stacks</code> outputs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pack suggest-stacks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Stacks maintained by the community:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Stack ID: heroku-18
</span></span><span style="display:flex;"><span>    Description: The official Heroku stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>    Maintainer: Heroku
</span></span><span style="display:flex;"><span>    Build Image: heroku/pack:18-build
</span></span><span style="display:flex;"><span>    Run Image: heroku/pack:18
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Stack ID: io.buildpacks.stacks.bionic
</span></span><span style="display:flex;"><span>    Description: A minimal Cloud Foundry stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>    Maintainer: Cloud Foundry
</span></span><span style="display:flex;"><span>    Build Image: cloudfoundry/build:base-cnb
</span></span><span style="display:flex;"><span>    Run Image: cloudfoundry/run:base-cnb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Stack ID: org.cloudfoundry.stacks.cflinuxfs3
</span></span><span style="display:flex;"><span>    Description: A large Cloud Foundry stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>    Maintainer: Cloud Foundry
</span></span><span style="display:flex;"><span>    Build Image: cloudfoundry/build:full-cnb
</span></span><span style="display:flex;"><span>    Run Image: cloudfoundry/run:full-cnb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Stack ID: org.cloudfoundry.stacks.tiny
</span></span><span style="display:flex;"><span>    Description: A tiny Cloud Foundry stack based on Ubuntu 18.04, similar to distroless
</span></span><span style="display:flex;"><span>    Maintainer: Cloud Foundry
</span></span><span style="display:flex;"><span>    Build Image: cloudfoundry/build:tiny-cnb
</span></span><span style="display:flex;"><span>    Run Image: cloudfoundry/run:tiny-cnb
</span></span></code></pre></div><p>To modify Kf to use the stack published by Heroku, edit
<code>kfsystem</code> Custom Resource, which automatically updates the <code>config-defaults</code> ConfigMap in the <code>kf</code> Namespace.
Add an entry to the <code>spaceStacksV3</code> key like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl edit kfsystem kfsystem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spaceStacksV3: <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  - name: org.cloudfoundry.stacks.cflinuxfs3
</span></span><span style="display:flex;"><span>    description: A large Cloud Foundry stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>    buildImage: cloudfoundry/cnb:cflinuxfs3
</span></span><span style="display:flex;"><span>    runImage: cloudfoundry/run:full-cnb
</span></span><span style="display:flex;"><span>  - name: heroku-18
</span></span><span style="display:flex;"><span>    description: The official Heroku stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>    buildImage: heroku/pack:18-build
</span></span><span style="display:flex;"><span>    runImage: heroku/pack:18
</span></span></code></pre></div><p>Then, run <code>stacks</code> again:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf stacks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Getting stacks in Space: buildpack-docs
</span></span><span style="display:flex;"><span>Version  Name                                Build Image                  Run Image                  Description
</span></span><span style="display:flex;"><span>V2       cflinuxfs3                          cloudfoundry/cflinuxfs3      cloudfoundry/cflinuxfs3
</span></span><span style="display:flex;"><span>V3       org.cloudfoundry.stacks.cflinuxfs3  cloudfoundry/cnb:cflinuxfs3  cloudfoundry/run:full-cnb  A large Cloud Foundry stack based on Ubuntu 18.04
</span></span><span style="display:flex;"><span>V3       heroku-18                           heroku/pack:18-build         heroku/pack:18             The official Heroku stack based on Ubuntu 18.04
</span></span></code></pre></div><h3 id="create-your-own-builder-image">Create your own builder image</h3>
<p>The <a href="https://buildpacks.io/docs/install-pack/">Buildpack CLI <code>pack</code></a>
is used to create your own builder image. You can follow <code>pack</code>&rsquo;s
<a href="https://buildpacks.io/docs/using-pack/working-with-builders/">Working with builders using <code>create-builder</code></a>
documentation to create your own builder image. After it&rsquo;s created, push it to a
container registry and add it to the <code>kfsystem</code> Custom Resource.</p>
<h2 id="set-a-default-stack">Set a default stack</h2>
<p>Apps will be assigned a default stack if one isn&rsquo;t supplied in their manifest.
The default stack is the first in the V2 or V3 stacks list. Unless overridden,
a V2 stack is chosen for compatibility with Cloud Foundry.</p>
<p>You can force Kf to use a V3 stack instead of a V2 by setting the
<code>spaceDefaultToV3Stack</code> field in the <code>kfsystem</code> Custom Resource to be <code>&quot;true&quot;</code> (<code>kfsystem</code> automatically updates corresonding <code>spaceDefaultToV3Stack</code> field in the <code>config-defaults</code> ConfigMap):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl edit kfsystem kfsystem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spaceDefaultToV3Stack: <span style="color:#4e9a06">&#34;true&#34;</span>
</span></span></code></pre></div><p>This option can also be modified on a per-Space basis by changing setting the
<code>spec.buildConfig.defaultToV3Stack</code> field to be <code>true</code> or <code>false</code>. If unset,
the value from the <code>config-defaults</code> ConfigMap is used.</p>
<table>
<thead>
<tr>
<th><code>config-defaults</code> value for <code>spaceDefaultToV3Stack</code></th>
<th>Space&rsquo;s <code>spec.buildConfig.defaultToV3Stack</code></th>
<th>Default stack</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>unset</em></td>
<td><em>unset</em></td>
<td>V2</td>
</tr>
<tr>
<td><code>&quot;false&quot;</code></td>
<td><em>unset</em></td>
<td>V2</td>
</tr>
<tr>
<td><code>&quot;true&quot;</code></td>
<td><em>unset</em></td>
<td>V3</td>
</tr>
<tr>
<td><em>any</em></td>
<td><code>false</code></td>
<td>V2</td>
</tr>
<tr>
<td><em>any</em></td>
<td><code>true</code></td>
<td>V3</td>
</tr>
</tbody>
</table>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f60fa136297c818ca9e1b205060a8432">1.4 - Troubleshooting</h1>
    <div class="lead">Troubleshoot Kf resources or installation.</div>
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9a85ad478cf508ecdd1e71de61d669e6">1.5 - Examples</h1>
    <div class="lead">Exapmles and demonstrations of special use-cases.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d9d41c282d85bcfed58e3051ef14aefa">1.5.1 - Deploy Spring Cloud Config</h1>
    <div class="lead">Learn how to deploy Spring Cloud Config as a configuration server.</div>
	<p>This document shows how to deploy Spring Cloud Config in a Kf cluster.</p>
<p><a href="https://cloud.spring.io/spring-cloud-config/reference/html/">Spring Cloud Config</a>
provides a way to decouple application code from its runtime configuration.
The Spring Cloud Config configuration server can read configuration files from Git
repositories, the local filesystem, <a href="https://www.vaultproject.io/">HashiCorp Vault servers</a>,
or <a href="https://docs.cloudfoundry.org/credhub/">Cloud Foundry CredHub</a>.
Once the configuration server has read the configuration, it can format and serve
that configuration as YAML, <a href="https://docs.oracle.com/cd/E23095_01/Platform.93/ATGProgGuide/html/s0204propertiesfileformat01.html">Java Properties</a>,
or JSON over HTTP.</p>
<h2 id="before-you-begin">Before you begin</h2>
<p>You will need a cluster with Kf installed and access to the Kf CLI.</p>
<p>Additionally, you will need the following software:</p>
<ul>
<li><strong><code>git</code></strong>: Git is required to clone a repository.</li>
</ul>
<h2 id="download-the-spring-cloud-config-configuration-server">Download the Spring Cloud Config configuration server</h2>
<p>To download the configuration server source:</p>
<ol>
<li>
<p>Open a terminal.</p>
</li>
<li>
<p>Clone the source for the configuration server:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone --depth <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">&#34;https://github.com/google/kf&#34;</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="configure-and-deploy-a-configuration-server">Configure and deploy a configuration server</h2>
<p>To update the settings for the instance:</p>
<ol>
<li>
<p>Change directory to <code>spring-cloud-config-server</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#204a87">cd</span> kf/spring-cloud-config-server
</span></span></code></pre></div></li>
<li>
<p>Open <code>manifest.yaml</code>.</p>
</li>
<li>
<p>Change the <code>GIT_URI</code> environment variable to the URI of your Git configuration server.</p>
</li>
<li>
<p>Optionally, change the name of the application in the manifest.</p>
</li>
<li>
<p>Optionally, <a href="https://cloud.spring.io/spring-cloud-config/reference/html/#_environment_repository">configure additional properties or alternative property sources</a>
by editing <code>src/main/resources/application.properties</code>.</p>
</li>
<li>
<p>Deploy the configuration server without an external route. If you changed
the name of the application in the manifest, update it here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push --no-route spring-cloud-config
</span></span></code></pre></div></li>
</ol>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> The default configuration is not production ready. The <code>README.md</code> file contains
additional steps to take if you want to deploy the application to production.
</aside>

<h2 id="bind-applications-to-the-configuration-server">Bind applications to the configuration server</h2>
<p>You can create a <a href="/kf/docs/v2.11/developer/backing-services/user-provided-services/">user provided service</a>
to bind the deployed configuration server to other Kf
applications in the same cluster or namespace.</p>
<p>How you configure them will depend on the library you use:</p>
<ul>
<li>Applications using Pivotal&rsquo;s Spring Cloud services client library</li>
</ul>
<p>Existing PCF applications that use <a href="https://github.com/pivotal-cf/spring-cloud-services-starters">Pivotal&rsquo;s Spring Cloud Services client library</a>
can be bound using the following method:</p>
<ol>
<li>
<p>Create a user provided service named <var>config-server</var>. This step
only has to be done once per configuration server:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf cups config-server -p <span style="color:#4e9a06">&#39;{&#34;uri&#34;:&#34;http://spring-cloud-config&#34;}&#39;</span> -t configuration
</span></span></code></pre></div>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> If you want to use a configuration server in a different space,
change the URI <a href="/kf/docs/v2.11/developer/service-discovery/service-discovery/#how_to_use_service_discovery_with">to include the space</a>.
</aside>

</li>
<li>
<p>For each application that needs get credentials, run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf bind-service application-name config-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kf restart application-name
</span></span></code></pre></div><p>This will create an entry into the <code>VCAP_SERVICES</code> environment variable for
the configuration server.</p>
</li>
</ol>
<ul>
<li>Other applications</li>
</ul>
<p>Applications that can connect directly to a Spring Cloud Config configuration
server should be configured to access it using its cluster internal URI:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">http://spring-cloud-config
</code></pre>
<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> If you want to use a configuration server in a different space, change the URI
<a href="/kf/docs/v2.11/developer/service-discovery/service-discovery/#how_to_use_service_discovery_with">to include the space name</a>.
</aside>

<ul>
<li>For Spring applications that use the <a href="https://cloud.spring.io/spring-cloud-config/multi/multi__spring_cloud_config_client.html">Spring Cloud Config client library</a>
can set the <code>spring.cloud.config.uri</code> property in the appropriate location
for your application. This is usually an <code>application.properties</code> or
<code>application.yaml</code> file.</li>
<li>For other frameworks, see your library&rsquo;s reference information.</li>
</ul>
<h2 id="delete-the-configuration-server">Delete the configuration server</h2>
<p>To remove a configuration server:</p>
<ol>
<li>
<p>Remove all bindings to the configuration server running the following commands for each bound application:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf unbind-service application-name config-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kf restart application-name
</span></span></code></pre></div></li>
<li>
<p>Remove the service entry for the configuration server:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete-service config-server
</span></span></code></pre></div></li>
<li>
<p>Delete the configuration server application:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete spring-cloud-config
</span></span></code></pre></div></li>
</ol>
<h2 id="whats-next">What&rsquo;s next</h2>
<ul>
<li>Read more about the <a href="https://cloud.spring.io/spring-cloud-config/reference/html/#_environment_repository">types of configuration sources</a>
Spring Cloud Config supports.</li>
<li>Learn about <a href="/kf/docs/v2.11/developer/build-and-deploy/app-runtime/#vcapservices">the structure of the <code>VCAP_SERVICES</code> environment variable</a>
to understand how it can be used for service discovery.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ff91ce51c2369e24b7fbd6a3ddf9a37d">1.5.2 - Deploy Spring Music</h1>
    <div class="lead">Learn to deploy an app with backing services.</div>
	<p>These instructions will walk you through deploying the <a href="https://github.com/cloudfoundry-samples/spring-music">Cloud Foundry Spring
Music</a> reference App using the Kf Cloud Service Broker.</p>
<ol>
<li>
<p><strong>Building Java Apps from source</strong>: The Spring Music source will be built on
the cluster, not locally.</p>
</li>
<li>
<p><strong>Service broker integration</strong>: You will create a database using the Kf Cloud Service Broker and bind the Spring Music App to it.</p>
</li>
<li>
<p><strong>Spring Cloud Connectors</strong>: <a href="https://cloud.spring.io/spring-cloud-connectors/">Spring Cloud
Connectors</a> are used by the Spring Music App to
detect things like bound CF services. They work seamlessly with Kf.</p>
</li>
<li>
<p><strong>Configuring the Java version</strong>: You will specify the version of Java you
want the buildpack to use.</p>
</li>
</ol>
<h2 id="prerequisites">Prerequisites</h2>
<p><a href="/kf/docs/v2.11/operator/service-brokers/deploying-cloud-sb/">Install and configure the Kf Cloud Service Broker</a>.</p>
<h2 id="deploy-spring-music">Deploy Spring Music</h2>
<h3 id="clone-source">Clone source</h3>
<ol>
<li>
<p>Clone the <a href="https://github.com/cloudfoundry-samples/spring-music">Spring Music repo</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/cloudfoundry-samples/spring-music.git spring-music
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> spring-music
</span></span></code></pre></div></li>
<li>
<p>Edit <code>manifest.yml</code>, and replace <code>path: build/libs/spring-music-1.0.jar</code> with <code>stack: org.cloudfoundry.stacks.cflinuxfs3</code>. This instructs Kf to build from source using <a href="https://cloud.google.com/blog/products/containers-kubernetes/google-cloud-now-supports-buildpacks">cloud native buildpacks</a> so you don&rsquo;t have to compile locally.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>applications:
</span></span><span style="display:flex;"><span>- name: spring-music
</span></span><span style="display:flex;"><span>  memory: 1G
</span></span><span style="display:flex;"><span>  random-route: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  stack: org.cloudfoundry.stacks.cflinuxfs3
</span></span><span style="display:flex;"><span>  env:
</span></span><span style="display:flex;"><span>    JBP_CONFIG_SPRING_AUTO_RECONFIGURATION: <span style="color:#4e9a06">&#39;{enabled: false}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    JBP_CONFIG_OPEN_JDK_JRE: &#39;{ jre: { version: 11.+ } }&#39;</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="push-spring-music-with-no-bindings">Push Spring Music with no bindings</h3>
<ol>
<li>
<p>Create and target a Space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-space <span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kf target -s <span style="color:#204a87">test</span>
</span></span></code></pre></div></li>
<li>
<p>Deploy Spring Music.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf push spring-music
</span></span></code></pre></div></li>
<li>
<p>Use the proxy feature to access the deployed App.</p>
</li>
<li>
<p>Start the proxy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf proxy spring-music
</span></span></code></pre></div></li>
<li>
<p>Open <code>http://localhost:8080</code> in your browser:</p>

      <figure>
          <img src="./sm1.png"
               alt="Screenshot of Spring Music showing no profile."/> 
      </figure>

<p>The deployed App includes a UI element showing which (if any) Spring profile is being used. No profile is being used here, indicating an in-memory database is in use.</p>
</li>
</ol>
<h3 id="create-and-bind-a-database">Create and bind a database</h3>
<ol>
<li>
<p>Create a PostgresSQL database from the marketplace.</p>

<aside class="alert alert-info" style="border-width: 1px 1px 1px 4px;">
<i class="fas fa-star ml-2"></i> <strong>Note:</strong> You must set the <code>COMPUTE_REGION</code> and <code>VPC_NAME</code> variables so Kf Cloud Service Broker knows where to provision your instance, and authorize the VPC Kf Apps run on to access it.
</aside>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf create-service csb-google-postgres small spring-music-postgres-db -c <span style="color:#4e9a06">&#39;{&#34;region&#34;:&#34;COMPUTE_REGION&#34;,&#34;authorized_network&#34;:&#34;VPC_NAME&#34;}&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>Bind the Service with the App.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf bind-service spring-music spring-music-postgres-db
</span></span></code></pre></div></li>
<li>
<p>Restart the App to make the service binding available via the VCAP_SERVICES environment variable.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf restart spring-music
</span></span></code></pre></div></li>
<li>
<p>(Optional) View the binding details.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf bindings
</span></span></code></pre></div></li>
<li>
<p>Verify the App is using the new binding.</p>
<ol>
<li>
<p>Start the proxy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf proxy spring-music
</span></span></code></pre></div></li>
<li>
<p>Open <code>http://localhost:8080</code> in your browser:</p>

        <figure>
            <img src="./sm2.png"
                 alt="Screenshot of Spring Music showing a profile."/> 
        </figure>

<p>You now see the Postgres profile is being used, and we see the name of our Service we bound the App to.</p>
</li>
</ol>
</li>
</ol>
<h2 id="clean-up">Clean up</h2>
<ol>
<li>
<p>Unbind and delete the PostgreSQL service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf unbind-service spring-music spring-music-db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kf delete-service spring-music-db
</span></span></code></pre></div></li>
<li>
<p>Delete the App:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kf delete spring-music
</span></span></code></pre></div></li>
</ol>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/kf" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Security mailing list" aria-label="Security mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:kf-security@google.com" aria-label="Security mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Kf Authors All Rights Reserved</small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/kf/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>




  </body>
</html>
