# Deploy UAA as a Kf App

These instructions will walk you through deploying [Cloud Foundry UAA][uaa] as a Kf app.

## Deploy

1. Download and extract the UAA source:

    ```sh
    wget https://github.com/cloudfoundry/uaa/archive/4.35.0.zip
    unzip 4.35.0.zip
    cd uaa-*
    ```

1. Add a default servlet mapping for Tomcat (this is necessary as the
   Tomcat Cloud Native Buildpack does not include a global web.xml with this
   mapping.):

    ```sh
    cat >uaa/src/main/webapp/WEB-INF/tomcat-web.xml <<EOF
    <?xml version="1.0" encoding="ISO-8859-1"?>
    <web-app xmlns="http://java.sun.com/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd" version="3.0"
      metadata-complete="true">
      <servlet>
            <servlet-name>default</servlet-name>
            <servlet-class>
              org.apache.catalina.servlets.DefaultServlet
            </servlet-class>
            <init-param>
                <param-name>debug</param-name>
                <param-value>0</param-value>
            </init-param>
            <init-param>
                <param-name>listings</param-name>
                <param-value>false</param-value>
            </init-param>
            <load-on-startup>1</load-on-startup>
        </servlet>
    </web-app>
    EOF
    ```

1. Create a sample deployment manifest. This snippet contains a minimally functional UAA configuration based on the manifest generated by running `gradlew manifests` in the UAA source repo. You should replace the `UAA_CONFIG_YAML` value with your own UAA configuration. **At a minimum, follow the instructions in [Create Keys and Certificates][create-keys-and-certs] to replace the keys and certificates in this manifest with ones you create yourself**:

    ```sh
    cat >manifest.yml <<EOF
    ---
    applications:
    - name: uaa
      minScale: 1
      env:
        BP_JAVA_VERSION: 8.*
        BP_BUILT_ARTIFACT: uaa/build/libs/cloudfoundry-identity-uaa-*.war
        UAA_URL: http://localhost:8080
        LOGIN_URL: http://localhost:8080
        UAA_CONFIG_YAML: |
          uaa:
            url: http://localhost:8080/uaa
          issuer:
            uri: http://localhost:8080/uaa
          encryption:
            active_key_label: key-1
            encryption_keys:
              - label: 'key-1'
                passphrase: 'CHANGE-ME'
              - label: 'key-2'
                passphrase: 'CHANGE-ME'
          spring_profiles: hsqldb
          jwt:
            token:
              signing-key: |
                -----BEGIN RSA PRIVATE KEY-----
                MIIEowIBAAKCAQEAsuzZAGXhnytRpqKemLXTmCLT4ahQju8GK7sQxpMmuXw4zf6p
                dS3zo7a9njpgw83pc8fq9sxdAv1xQPaAhPrYkup2CXwmsqZjp/QuQ2d8znHslXEZ
                tPVJUcZ7732tUg5uM+G/WwbH+ioKUSTegSmlmVCXw9GRrlC9EZPX8GYPrUWj43L3
                D0ft4YcLdRioIYfecrwRUR+eIRQDnF/4kQ8g+QbfpVbjDKwUxlvBnOBTGKJqgBbq
                JkwegmGPP2X/WDCYkYfrNUc1SwWwGq/civ0MNszXmdihJIFjNwCaJIK9/dWWBsJn
                8P6q7Xh2B0wNINFNw3kA/iWbZIA4ycRyQqvSrQIDAQABAoIBAHjOU8HiCBEo9Ws2
                FzDya1goA7kzpJitKBR0rGH2zsmj5tKm5BF7IipiYuqnbdgmej4zOCDEYPR43HPJ
                O4MNvxaK+YFz8sjicRzgUDAwemMFJoDMKVg12Pg+tEVCLLjfh2a+QC4ciP8OTYL2
                CslYrjey45VSNTNlzhJFKSJmNqV84t/YgPw8p6IOVTRbVZeYZJFIcZ/9RJ8cBkxK
                YaHLVcvtTk4EAWOt59HaczTKMn/bjrBvEhvv2HQPJlrawTIjHtQbXFEu95+X7CFu
                j3G02l9r/6oc1GQjXGSlGdnT9n09y2cOr6brbhjRkifH9t+zop5B/u24Eo0MPvQK
                5hMrV30CgYEA5kOrmRdl9Ic19CTvn86TECRZquy0o1EsU5m0HbxdEReoNVDfFvq4
                pxhGvg+YeeVjznKbY2WRIK+fXL5EYaXlcUltdSmbcQ6wk2UCxXrs59JXT6kaul56
                tU6JYaqpaNJR9+AVK8vF00eN4aIq5cyGlXN13gBEVenCN6tOzj41V3MCgYEAxuxC
                l5fA/23fKx5VO8wqyfUY+7ZFW/h8dTMY6SwD8hzcYy88ogR/fzMg2b018NnKLKX0
                FIxWdh7Z23rTFYlmdf8/B0e44h0+f5qdFpkunRYygZTgsTNWcKzHvVDfKxpUaR9h
                eHGMhGHx8dbmRvXQCyqeDWhrOr8sb9bOxUEgZV8CgYAQAQYNNuYcL8WdOW/6MHZi
                OdSNn7QSYdLt4JH3Ox9Qz88eHYfT5gstee94yEa1ui7Mq4SHTQjgN7Sg0oyYKNqg
                nBTifsjR+85kADJIHXoXxrPQ0pUL/QMUVOgRhLYPlgaibs2p5JjUTXXcB9RpcmSs
                QIEhs+0L95pLGjn49bPpZwKBgQCNVagq1SPHWGVL2Y1toy5zt7U8gtDc+7xR+TAl
                26QiDed4gUNvSgrccZNRoWIF8nf3KSI2x09XNaxMiQQZNTqbc/NwVMFDxst1FoGu
                YMAB1JemAgVzYap0/A4esKsfkOGQnz89uE/Cb2TcE3ghyt06UdliZWJqpxIHlHPt
                Ksy9uQKBgB4T/Yg/QTQMTheVCUFtC0B0UdqhHyBZNadUNKsaXSD604Z7BN9mmjoW
                62g0M22YeeFoiSpZ0B7G9KD+RC76EpvYALRPIW0dY9Wl14JQ57Q5SgvHKhdJY0Sv
                i8C5qKR8ALblTV6WZlB6k3w4k7B3a/UpnBUolGk+45wOY175UZB5
                -----END RSA PRIVATE KEY-----
              verification-key: |
                -----BEGIN PUBLIC KEY-----
                MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsuzZAGXhnytRpqKemLXT
                mCLT4ahQju8GK7sQxpMmuXw4zf6pdS3zo7a9njpgw83pc8fq9sxdAv1xQPaAhPrY
                kup2CXwmsqZjp/QuQ2d8znHslXEZtPVJUcZ7732tUg5uM+G/WwbH+ioKUSTegSml
                mVCXw9GRrlC9EZPX8GYPrUWj43L3D0ft4YcLdRioIYfecrwRUR+eIRQDnF/4kQ8g
                +QbfpVbjDKwUxlvBnOBTGKJqgBbqJkwegmGPP2X/WDCYkYfrNUc1SwWwGq/civ0M
                NszXmdihJIFjNwCaJIK9/dWWBsJn8P6q7Xh2B0wNINFNw3kA/iWbZIA4ycRyQqvS
                rQIDAQAB
                -----END PUBLIC KEY-----
          login:
            serviceProviderKey: |
              -----BEGIN RSA PRIVATE KEY-----
              MIICXQIBAAKBgQDb1hfV0qSvzeO2HzpJR1l0KnlkVYfSVLnkoS4gKFAtAcjqDKCp
              gmHq0bcO5Cacz/hvKSA3Q0x+C0/78IaxAxOBBrfA8XEdxqSVxWYqEGHLqr7Kc/xp
              X75eHHW1ARKKGVSUrk9n9i1jTf7jYPezLn790S9gJxrLE0HI7SvXnvg2WQIDAQAB
              AoGBAMeqmFN40mNq2RudGU9dIn5D5aWfmZELqxtg2YgTlV6LdHQ/q9zJsy2X9G/u
              ALQEoFw2OjB3S45fr/Hf8DXt2VN0BZT/U+v8F4HL0424HLz0fgDUxHSFlEcl7+R/
              xuG4PbTOONbcSKI3eMQrGIX+KHYvOsH1vV/i8WtGIKld9BdBAkEA9sJ7tqKUI3w+
              o4vUCtx1DFqZzgqNGbjyF23PbbhZRt02IWaEgd2jvSZem0yVtcQUB8+0GE/iiEVA
              gcR/aQTCnQJBAOQRg3vmR+vX0k9DbGMYa6/xbBK7X160Se5CDNWn6HgvyFU3UB8s
              4kxqgY5FdQHCg/rPvtdrJg9b6i/dJ2Tox+0CQQCHlLp20gOFL9oW8FhUk2b4n7tM
              e32luXnDJ8HGLnlXN2prlbGOzWIPJsrql3zWv2KmHBh/Fz2H1E0qP/YllMj9AkAT
              gHvhyFs2C4psRLOr9ZafwOEg6OzKyFfaC8PVMTprrIpQ3x32zHu9VQ4nAEF1GRD4
              DXOgMAVdItrvpNWNh2oxAkBPE1qNQr/x1qlIM7vc6LT9oM0P35O21AUKPKfa8uq+
              MUYoRMY9qtvc8gI5B9cc/pkKiN7erP4TCAQJbleMbnyp
              -----END RSA PRIVATE KEY-----
            serviceProviderKeyPassword:
            serviceProviderCertificate: |
              -----BEGIN CERTIFICATE-----
              MIICcDCCAdmgAwIBAgIUJe/3E3n9eA4NoQ/dYQatYSgldVMwDQYJKoZIhvcNAQEL
              BQAwSjELMAkGA1UEBhMCdXMxCzAJBgNVBAgMAndhMRAwDgYDVQQHDAdzZWF0dGxl
              MQswCQYDVQQKDAJLZjEPMA0GA1UEAwwGa2YuZGV2MB4XDTE5MDcxOTE4NDkyNFoX
              DTIwMDcxODE4NDkyNFowSjELMAkGA1UEBhMCdXMxCzAJBgNVBAgMAndhMRAwDgYD
              VQQHDAdzZWF0dGxlMQswCQYDVQQKDAJLZjEPMA0GA1UEAwwGa2YuZGV2MIGfMA0G
              CSqGSIb3DQEBAQUAA4GNADCBiQKBgQDb1hfV0qSvzeO2HzpJR1l0KnlkVYfSVLnk
              oS4gKFAtAcjqDKCpgmHq0bcO5Cacz/hvKSA3Q0x+C0/78IaxAxOBBrfA8XEdxqSV
              xWYqEGHLqr7Kc/xpX75eHHW1ARKKGVSUrk9n9i1jTf7jYPezLn790S9gJxrLE0HI
              7SvXnvg2WQIDAQABo1MwUTAdBgNVHQ4EFgQUVoMMfS3ceX8gtM1jFtT2hAi7nn0w
              HwYDVR0jBBgwFoAUVoMMfS3ceX8gtM1jFtT2hAi7nn0wDwYDVR0TAQH/BAUwAwEB
              /zANBgkqhkiG9w0BAQsFAAOBgQBjB2EBoPd+4q4dDollokrHvMhl3l9Wboaxld3G
              HkWyZ49D2VBb7vr2N1xmxjtVVV+c7hZIPSEn020eksob2pryRdU0PZOtk2C1a+tW
              eUe4EPi7baPJtObheJWcZcvxkyVvyvGcmlm816XVfLVGCddCFP6FBchf07zuOguS
              IaYpAw==
              -----END CERTIFICATE-----
          oauth:
            # Always override clients on startup
            client:
              override: true
            # List of OAuth clients
            clients:
              admin:
                id: admin
                secret: CHANGE-ME
                authorized-grant-types: client_credentials
                scope: none
                authorities: uaa.admin,clients.admin,clients.read,clients.write,clients.secret
    EOF
    ```

1. Deploy (this assumes you've already `kf target`'d a space; see [these
   docs][create-space] for more detail):

    ```sh
    kf push uaa
    ```

1. Use the proxy feature to access the deployed app:

    ```sh
    kf proxy uaa
    ```

1. Download and install `uaac` via [these instructions](uaac-install)

1. Target `uaa`:

    ```sh
    uaac target http://localhost:8080 --skip-ssl-validation
    ```

1. Get a token for the admin user:

    ```sh
    uaac token client get admin -s CHANGE-ME
    ```

1. Create a new user:

    ```sh
    uaac user add test -p changeme --emails test@example.com
    ```

1. Validate the user exists:

    ```sh
    uaac users
    ```

## Create Keys and Certs

### Create JWT Token-Signing Key

1. Run the following commands to create a key suitable for JWT token signing:

    ```sh
    openssl genrsa -out jwt.pem 2048
    openssl rsa -in jwt.pem -pubout > jwt-pub.pem
    ```

1. In `manifest.yml`, replace `jwt.token.signing-key` with the value of
   `jwt.pem`, and replace `jwt.token.verification-key` with the value of
   `jwt-pub.pem`

### Create Service Provider Key and Self-Signed Certificate

1. Run the following commands to create a key and remove its password:

    ```sh
    openssl genrsa -aes256 -out sp.key 1024
    openssl rsa -in sp.key -out sp.key
    ```

1. Create a CSR:

    ```sh
    openssl req -x509 -sha256 -new -key sp.key -out sp.csr
    ```

1. Create a cert:

    ```sh
    openssl x509 -sha256 -days 365 -in sp.csr -signkey sp.key -out sp.crt
    ```

1. In `manifest.yml`, replace `login.serviceProviderKey` with the value of
   `sp.key`, and replace `login.serviceProviderCertificate` with the value of
   `sp.crt`. `login.serviceProviderKeyPassword` should remain blank as the
   password was removed from the key in the first step.

## Destroy

1. Delete the app:

    ```sh
    kf delete uaa
    ```

[uaa]: https://github.com/cloudfoundry/uaa
[uaac-install]: https://github.com/cloudfoundry/cf-uaac#installation
[create-space]: /docs/install.md#create-and-target-a-space
[create-keys-and-certs]: #create-keys-and-certs
